!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("js-base64"),require("cross-fetch"),require("sip.js"),require("reconnecting-websocket")):"function"==typeof define&&define.amd?define(["js-base64","cross-fetch","sip.js","reconnecting-websocket"],t):e["@wazo/sdk"]=t(e.jsBase64,e["cross-fetch"],e.SIP,e.ReconnectingWebSocket)}(this,function(e,t,s,n){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,s=s&&s.hasOwnProperty("default")?s.default:s,n=n&&n.hasOwnProperty("default")?n.default:n;var a=(t,s)=>({checkToken:e=>t.callApi(`${s.authUrl}/token/${e}`,"head",null,null,e=>204===e.status),logIn(n={}){const a={backend:n.backend||s.backendUser,expiration:n.expiration||s.expiration},r={Authorization:`Basic ${e.Base64.encode(`${n.username}:${n.password}`)}`,"Content-Type":"application/json"};return t.callApi(`${s.authUrl}/token`,"post",a,r,e=>e.json().then(e=>e.data))},logOut:e=>t.callApi(`${s.authUrl}/token/${e}`,"delete"),listTenants:e=>t.callApi(`${s.authUrl}/tenants`,"get",null,t.getHeaders(e)),createTenant:(e,n)=>t.callApi(`${s.authUrl}/tenants`,"post",{name:n},t.getHeaders(e)),deleteTenant:(e,n)=>t.callApi(`${s.authUrl}/tenants/${n}`,"delete",null,t.getHeaders(e)),listUsers:e=>t.callApi(`${s.authUrl}/users`,"get",null,t.getHeaders(e)),listGroups:e=>t.callApi(`${s.authUrl}/groups`,"get",null,t.getHeaders(e)),listPolicies:e=>t.callApi(`${s.authUrl}/policies`,"get",null,t.getHeaders(e))}),r=(e,t)=>({answerCall(s,n,a,r,i,l){const o=`${t.applicationUrl}/${n}/nodes`,c={calls:[{id:a}]},u=e.getHeaders(s);return e.callApi(o,"post",c,u,e=>e.data.uuid).then(t=>e.callApi(`${o}/${t}/calls`,"post",{context:r,exten:i,autoanswer:l},u).then(e=>({nodeUuid:t,data:e})))},calls:(s,n)=>e.callApi(`${t.applicationUrl}/${n}/calls`,"get",null,e.getHeaders(s)),hangupCall(s,n,a){const r=`${t.applicationUrl}/${n}/calls/${a}`;return e.callApi(r,"delete",null,e.getHeaders(s))},nodes(s,n){const a=`${t.applicationUrl}/${n}/nodes`;return e.callApi(a,"get",null,e.getTokenHeaders(s))},playCall(s,n,a,r,i){const l=`${t.applicationUrl}/${n}/calls/${a}/play`;return e.callApi(l,"post",{language:r,uri:i},e.getHeaders(s))},addCallNodes(s,n,a,r){const i=`${t.applicationUrl}/${n}/nodes/${a}/calls/${r}`;return e.callApi(i,"put",null,e.getHeaders(s))},addNewCallNodes(s,n,a,r,i,l){const o=`${t.applicationUrl}/${n}/nodes/${a}/calls`,c={context:r,exten:i,autoanswer:l};return e.callApi(o,"post",c,e.getHeaders(s))},listCallsNodes(s,n,a){const r=`${t.applicationUrl}/${n}/nodes/${a}`;return e.callApi(r,"get",null,e.getHeaders(s))},listNodes(s,n){const a=`${t.applicationUrl}/${n}/nodes`;return e.callApi(a,"get",null,e.getHeaders(s))},removeNode(s,n,a){const r=`${t.applicationUrl}/${n}/nodes/${a}`;return e.callApi(r,"delete",null,e.getHeaders(s))},removeCallNodes(s,n,a,r){const i=`${t.applicationUrl}/${n}/nodes/${a}/calls/${r}`;return e.callApi(i,"delete",null,e.getHeaders(s))}}),i=(e,t)=>({listUsers:s=>e.callApi(`${t.confdUrl}/users`,"get",null,e.getHeaders(s)),getUser:(s,n)=>e.callApi(`${t.confdUrl}/users/${n}`,"get",null,e.getHeaders(s)),getUserLineSip(s,n,a){const r=`${t.confdUrl}/users/${n}/lines/${a}/associated/endpoints/sip`;return e.callApi(r,"get",null,e.getHeaders(s))},listApplications(s){const n=`${t.confdUrl}/applications?recurse=true`;return e.callApi(n,"get",null,e.getHeaders(s))}}),l=(e,t)=>({listSubscriptions(s){const n=`${t.accessdUrl}/subscriptions?recurse=true`;return e.callApi(n,"get",null,e.getHeaders(s))},createSubscription(s,{tenantUuid:n,productSku:a,name:r,startDate:i,contractDate:l,autoRenew:o,term:c}){const u=`${t.accessdUrl}/subscriptions`,d={product_sku:a,name:r,start_date:i,contract_date:l,auto_renew:o,term:c},p=e.getHeaders(s);return n&&(p["Wazo-Tenant"]=n),e.callApi(u,"post",d,p)},getSubscription(s,n){const a=`${t.accessdUrl}/subscriptions/${n}`;return e.callApi(a,"get",null,e.getHeaders(s))},listAuthorizations(s,n){const a=`${t.accessdUrl}/subscriptions/${n}/authorizations`;return e.callApi(a,"get",null,e.getHeaders(s))},getAuthorization(s,n,a){const r=`${t.accessdUrl}/subscriptions/${n}/authorizations/${a}`;return e.callApi(r,"get",null,e.getHeaders(s))},createAuthorization(s,n,{startDate:a,term:r,service:i,rules:l,autoRenew:o}){const c=`${t.accessdUrl}/subscriptions/${n}/authorizations`,u={start_date:a,term:r,service:i,rules:l,auto_renew:o};return e.callApi(c,"post",u,e.getHeaders(s))}});const o="0.1",c="1.0",u="1.1",d="1.0";class p{static callApi(e,s="get",n=null,a={},r=(e=>e.json().then(e=>e))){return t(e,{method:s,body:n?JSON.stringify(n):null,headers:a}).then(e=>{if(e.status>=400){return(-1!==e.headers.get("content-type").indexOf("application/json")?e.json():e.text()).then(e=>{throw e})}return r(e)})}static getHeaders(e){return{"X-Auth-Token":e,"Content-Type":"application/json"}}constructor({server:e}){this.server=e,this.backendUser="wazo_user",this.expiration=3600,this.auth=a(p,this),this.application=r(p,this),this.confd=i(p,this),this.accessd=l(p,this)}get authUrl(){return`${this.baseUrl}/auth/${o}`}get applicationUrl(){return`${this.baseUrl}/ctid-ng/${c}/applications`}get confdUrl(){return`${this.baseUrl}/confd/${u}`}get accessdUrl(){return`${this.baseUrl}/accessd/${d}`}get baseUrl(){return`https://${this.server}/api`}}const h=["STATUS_NULL","STATUS_NEW","STATUS_CONNECTING","STATUS_CONNECTED","STATUS_COMPLETED"],g=e=>({caller_id_name:e.remoteIdentity.displayName,caller_id_number:e.remoteIdentity.uri.user}),$=e=>!!e.getHeader("alert-info"),U=/^\+?[0-9#*]+$/;return{WazoApiClient:p,WazoWebRTCClient:class{constructor(e,t){this.config=e,this.ua=this.configureUa(),this.callback=t}configureUa(){const e=new s.Web.Simple(this.getConfig());return e.on("registered",()=>{this.callback("phone-events-registered")}),e.on("unregistered",()=>{this.callback("phone-events-unregistered")}),e.on("new",e=>{const t={callerid:g(e),autoanswer:$(e.request)};this.callback("phone-events-new",t)}),e.on("ringing",()=>{this.callback("phone-events-ringing")}),e.on("connected",()=>{this.callback("phone-events-connected")}),e.on("ended",()=>{this.callback("phone-events-ended")}),e}getConfig(){return{media:{remote:{audio:this.config.media.audio}},ua:{traceSip:!1,displayName:this.config.displayName,uri:this.config.uri,wsServers:this.config.wsServers,authorizationUser:this.config.authorizationUser,password:this.config.password,sessionDescriptionHandlerFactoryOptions:{peerConnectionOptions:{iceCheckingTimeout:500,rtcpMuxPolicy:"negotiate",rtcConfiguration:{iceServers:{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"]}}}}}}}getState(){return h[this.ua.state]}call(e){U.exec(e)&&this.ua.call(e)}answer(){this.ua.answer()}reject(){this.ua.reject()}hangup(){this.ua.hangup()}close(){this.ua.ua.transport.disconnect()}},WazoWebSocketClient:class{constructor(e){this.ws_init=!1,this.callback=e.callback,this.host=e.host,this.token=e.token,this.events=e.events}init(){const e=new n(`wss://${this.host}/api/websocketd/?token=${this.token}`);return e.debug=!1,e.onmessage=(t=>{const s=JSON.parse(t.data);this.ws_init?this.callback(s):this.initialize(s,e)}),e.onclose=(e=>{e.code}),e}initialize(e,t){switch(e.op){case"init":this.events.forEach(e=>{const s={op:"subscribe",data:{event_name:e}};t.send(JSON.stringify(s))}),t.send(JSON.stringify({op:"start"}));break;case"subscribe":break;case"start":this.ws_init=!0}}}}});
