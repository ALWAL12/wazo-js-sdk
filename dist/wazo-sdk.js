!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("cross-fetch/polyfill"),require("js-base64"),require("sip.js"),require("reconnecting-websocket")):"function"==typeof define&&define.amd?define(["cross-fetch/polyfill","js-base64","sip.js","reconnecting-websocket"],t):e["@wazo/sdk"]=t(null,e.jsBase64,e.SIP,e.ReconnectingWebSocket)}(this,function(e,t,s,n){"use strict";s=s&&s.hasOwnProperty("default")?s.default:s,n=n&&n.hasOwnProperty("default")?n.default:n;class i{static fromResponse(e){return new i(e.message,e.timestamp,e.error_id,e.details)}static fromText(e){return new i(e)}constructor(e,t=null,s=null,n=null){this.message=e,this.timestamp=t,this.errorId=s,this.details=n}}const r=1==+process.env.DEBUG||"true"===process.env.DEBUG,a=(e,t)=>204===e.status,o=(e,t,s)=>"get"===e&&s&&Object.keys(s).length?`${t}?${(e=>Object.keys(e).filter(t=>e[t]).map(t=>`${t}=${encodeURIComponent(e[t])}`).join("&"))(s)}`:t,l=(e,t="get",s=null,n={},l=((e,t)=>e.ok?e.json().then(e=>e):(t?e.json():e.text()).then(e=>t?i.fromResponse(e):i.fromText(e))))=>{const c=o(t,e,s),u=s&&"get"!==t?JSON.stringify(s):null,d="delete"===t||"head"===t?a:l,p={method:t,body:u,headers:n};return fetch(c,p).then(e=>{const t=-1!==(e.headers.get("content-type")||"").indexOf("application/json");if(((e,{method:t,body:s,headers:n},i)=>{if(!r)return;const{status:a}=i;let o=`${a} - curl ${"get"!==t?`-X ${t.toUpperCase()}`:""}`;Object.keys(n).forEach(e=>{o+=` -H '${e}: ${n[e]}'`}),o+=` ${e}`,s&&(o+=` -d '${s}'`),console.info(o)})(c,p,e),e.status>=500){return(t?e.json():e.text()).then(e=>{throw e})}return d(e,t)})},c=e=>({"X-Auth-Token":e,Accept:"application/json","Content-Type":"application/json"});var u=e=>({checkToken:t=>l(`${e}/token/${t}`,"head",null,{}),authenticate:t=>l(`${e}/token/${t}`,"get",null,{}),logIn(s={}){const n={backend:s.backend||"wazo_user",expiration:s.expiration||3600},i={Authorization:`Basic ${t.Base64.encode(`${s.username}:${s.password}`)}`,"Content-Type":"application/json"};return l(`${e}/token`,"post",n,i)},logOut:t=>l(`${e}/token/${t}`,"delete",null,{},a),updatePassword:(t,s,n,i)=>l(`${e}/users/${s}/password`,"put",{new_password:i,old_password:n},c(t),a),sendDeviceToken:(t,s,n)=>l(`${e}/users/${s}/external/mobile`,"post",{token:n},c(t)),removeDeviceToken:(t,s)=>l(`${e}/users/${s}/external/mobile`,"delete",null,c(t)),listTenants:t=>l(`${e}/tenants`,"get",null,c(t)),createTenant:(t,s)=>l(`${e}/tenants`,"post",{name:s},c(t)),deleteTenant:(t,s)=>l(`${e}/tenants/${s}`,"delete",null,c(t)),listUsers:t=>l(`${e}/users`,"get",null,c(t)),listGroups:t=>l(`${e}/groups`,"get",null,c(t)),listPolicies:t=>l(`${e}/policies`,"get",null,c(t))}),d=e=>({answerCall(t,s,n,i,r,a){const o=`${e}/${s}/nodes`,u={calls:[{id:n}]},d=c(t);return l(o,"post",u,d,e=>e.data.uuid).then(e=>l(`${o}/${e}/calls`,"post",{context:i,exten:r,autoanswer:a},d).then(t=>({nodeUuid:e,data:t})))},calls:(t,s)=>l(`${e}/${s}/calls`,"get",null,c(t)),hangupCall:(t,s,n)=>l(`${e}/${s}/calls/${n}`,"delete",null,c(t)),playCall:(t,s,n,i,r)=>l(`${e}/${s}/calls/${n}/play`,"post",{language:i,uri:r},c(t)),addCallNodes:(t,s,n,i)=>l(`${e}/${s}/nodes/${n}/calls/${i}`,"put",null,c(t)),addNewCallNodes:(t,s,n,i,r,a)=>l(`${e}/${s}/nodes/${n}/calls`,"post",{context:i,exten:r,autoanswer:a},c(t)),listCallsNodes:(t,s,n)=>l(`${e}/${s}/nodes/${n}`,"get",null,c(t)),listNodes:(t,s)=>l(`${e}/${s}/nodes`,"get",null,c(t)),removeNode:(t,s,n)=>l(`${e}/${s}/nodes/${n}`,"delete",null,c(t)),removeCallNodes:(t,s,n,i)=>l(`${e}/${s}/nodes/${n}/calls/${i}`,"delete",null,c(t))}),p=e=>({listUsers:t=>l(`${e}/users`,"get",null,c(t)),getUser:(t,s)=>l(`${e}/users/${s}`,"get",null,c(t)),updateUser:(t,s,{firstName:n,lastName:i,email:r,mobileNumber:o})=>l(`${e}/users/${s}`,"put",{firstname:n,lastname:i,email:r,mobile_phone_number:o},c(t),a),updateForwardOption:(t,s,n,i,r)=>l(`${e}/users/${s}/forwards/${n}`,"put",{destination:i,enabled:r},c(t),a),updateDoNotDisturb:(t,s,n)=>l(`${e}/users/${s}/services/dnd`,"put",{enabled:n},c(t),a),getUserLineSip:(t,s,n)=>l(`${e}/users/${s}/lines/${n}/associated/endpoints/sip`,"get",null,c(t)),listApplications:t=>l(`${e}/applications?recurse=true`,"get",null,c(t)),getSIP:(t,s,n)=>l(`${e}/users/${s}/lines/${n}/associated/endpoints/sip`,"get",null,c(t))}),$=e=>({listSubscriptions:t=>l(`${e}/subscriptions?recurse=true`,"get",null,c(t)),createSubscription(t,{tenantUuid:s,productSku:n,name:i,startDate:r,contractDate:a,autoRenew:o,term:u}){const d={product_sku:n,name:i,start_date:r,contract_date:a,auto_renew:o,term:u},p=c(t);return s&&(p["Wazo-Tenant"]=s),l(`${e}/subscriptions`,"post",d,p)},getSubscription:(t,s)=>l(`${e}/subscriptions/${s}`,"get",null,c(t)),listAuthorizations:(t,s)=>l(`${e}/subscriptions/${s}/authorizations`,"get",null,c(t)),getAuthorization:(t,s,n)=>l(`${e}/subscriptions/${s}/authorizations/${n}`,"get",null,c(t)),createAuthorization:(t,s,{startDate:n,term:i,service:r,rules:a,autoRenew:o})=>l(`${e}/subscriptions/${s}/authorizations`,"post",{start_date:n,term:i,service:r,rules:a,auto_renew:o},c(t))}),h=e=>({updatePresence:(t,s)=>l(`${e}/users/me/presences`,"put",{presence:s},c(t),a),listMessages:(t,s)=>l(`${e}/users/me/chats`,"get",s?{participant_user_uuid:s}:null,c(t)),sendMessage:(t,s,n,i)=>l(`${e}/users/me/chats`,"post",{alias:s,message:n,to:i},c(t)),makeCall:(t,s)=>l(`${e}/users/me/calls`,"post",{from_mobile:!0,extension:s},c(t)),cancelCall:(t,s)=>l(`${e}/users/me/calls/${s}`,"delete",null,c(t)),listCalls:t=>l(`${e}/users/me/calls`,"get",null,c(t)),relocateCall(t,s,n,i){const r={completions:["answer"],destination:n,initiator_call:s};return i&&(r.location={line_id:i}),l(`${e}/users/me/relocates`,"post",r,c(t))},listVoicemails:t=>l(`${e}/users/me/voicemails`,"get",null,c(t)),deleteVoicemail:(t,s)=>l(`${e}/users/me/voicemails/messages/${s}`,"delete",null,c(t)),getPresence:(t,s)=>l(`${e}/users/${s}/presences`,"get",null,c(t)),getStatus:(t,s)=>l(`${e}/lines/${s}/presences`,"get",null,c(t))});const g=e=>({email:e.email,firstname:e.firstName,lastname:e.lastName,number:e.phoneNumber,entreprise:e.entreprise,birthday:e.birthday,address:e.address,note:e.note});var m=e=>({search:(t,s,n)=>l(`${e}/directories/lookup/${s}`,"get",{term:n},c(t)),listPersonalContacts:t=>l(`${e}/personal`,"get",null,c(t)),addContact:(t,s)=>l(`${e}/personal`,"post",g(s),c(t)),editContact:(t,s)=>l(`${e}/personal/${s.id}`,"put",g(s),c(t)),deleteContact:(t,s)=>l(`${e}/personal/${s}`,"delete",null,c(t)),listFavorites:(t,s)=>l(`${e}/directories/favorites/${s}`,"get",null,c(t)),markAsFavorite:(t,s,n)=>l(`${e}/directories/favorites/${s}/${n}`,"put",null,c(t),a),removeFavorite:(t,s,n)=>l(`${e}/directories/favorites/${s}/${n}`,"delete",null,c(t))}),b=e=>({search:(t,s,n=5)=>l(`${e}/users/me/cdr`,"get",{search:s,limit:n},c(t)),listCallLogs:(t,s,n=5)=>l(`${e}/users/me/cdr`,"get",{offset:s,limit:n},c(t)),listCallLogsFromDate:(t,s,n)=>l(`${e}/users/me/cdr`,"get",{from:s,number:n},c(t))});const f="0.1",k="1.0",w="1.1",U="1.0",v="1.0",C="0.1",_="1.0";const S=["STATUS_NULL","STATUS_NEW","STATUS_CONNECTING","STATUS_CONNECTED","STATUS_COMPLETED"],y=e=>({caller_id_name:e.remoteIdentity.displayName,caller_id_number:e.remoteIdentity.uri.user}),N=e=>!!e.getHeader("alert-info"),T=/^\+?[0-9#*]+$/;return{WazoApiClient:class{constructor({server:e}){this.server=e}initializeEndpoints(){this.auth=u(this.authUrl),this.application=d(this.applicationUrl),this.confd=p(this.confdUrl),this.accessd=$(this.accessdUrl),this.ctidng=h(this.ctidngUrl),this.dird=m(this.dirdUrl),this.callLogd=b(this.callLogdUrl)}set server(e){this._server=e,this.initializeEndpoints()}get authUrl(){return`${this.baseUrl}/auth/${f}`}get applicationUrl(){return`${this.baseUrl}/ctid-ng/${k}/applications`}get confdUrl(){return`${this.baseUrl}/confd/${w}`}get accessdUrl(){return`${this.baseUrl}/accessd/${U}`}get ctidngUrl(){return`${this.baseUrl}/ctid-ng/${v}`}get dirdUrl(){return`${this.baseUrl}/dird/${C}`}get callLogdUrl(){return`${this.baseUrl}/call-logd/${_}`}get baseUrl(){return`https://${this._server}/api`}},WazoWebRTCClient:class{constructor(e,t){this.config=e,this.ua=this.configureUa(),this.callback=t}configureUa(){const e=new s.Web.Simple(this.getConfig());return e.on("registered",()=>{this.callback("phone-events-registered")}),e.on("unregistered",()=>{this.callback("phone-events-unregistered")}),e.on("new",e=>{const t={callerid:y(e),autoanswer:N(e.request)};this.callback("phone-events-new",t)}),e.on("ringing",()=>{this.callback("phone-events-ringing")}),e.on("connected",()=>{this.callback("phone-events-connected")}),e.on("ended",()=>{this.callback("phone-events-ended")}),e}getConfig(){return{media:{remote:{audio:this.config.media.audio}},ua:{traceSip:!1,displayName:this.config.displayName,uri:this.config.uri,wsServers:this.config.wsServers,authorizationUser:this.config.authorizationUser,password:this.config.password,sessionDescriptionHandlerFactoryOptions:{peerConnectionOptions:{iceCheckingTimeout:500,rtcpMuxPolicy:"negotiate",rtcConfiguration:{iceServers:{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"]}}}}}}}getState(){return S[this.ua.state]}call(e){T.exec(e)&&this.ua.call(e)}answer(){this.ua.answer()}reject(){this.ua.reject()}hangup(){this.ua.hangup()}close(){this.ua.ua.transport.disconnect()}},WazoWebSocketClient:class{constructor(e){this.ws_init=!1,this.callback=e.callback,this.host=e.host,this.token=e.token,this.events=e.events}init(){const e=new n(`wss://${this.host}/api/websocketd/?token=${this.token}`);return e.debug=!1,e.onmessage=(t=>{const s=JSON.parse(t.data);this.ws_init?this.callback(s):this.initialize(s,e)}),e.onclose=(e=>{e.code}),e}initialize(e,t){switch(e.op){case"init":this.events.forEach(e=>{const s={op:"subscribe",data:{event_name:e}};t.send(JSON.stringify(s))}),t.send(JSON.stringify({op:"start"}));break;case"subscribe":break;case"start":this.ws_init=!0}}},BadResponse:i}});
