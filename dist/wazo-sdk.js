!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("js-base64"),require("sip.js"),require("reconnecting-websocket")):"function"==typeof define&&define.amd?define(["js-base64","sip.js","reconnecting-websocket"],t):e["@wazo/sdk"]=t(e.jsBase64,e.SIP,e.ReconnectingWebSocket)}(this,function(e,t,s){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,s=s&&s.hasOwnProperty("default")?s.default:s;var n=require("./node-ponyfill"),i=n.fetch.bind({});i.polyfill=!0,global.fetch||(global.fetch=i,global.Response=n.Response,global.Headers=n.Headers,global.Request=n.Request);const a=(e,t="get",s=null,n={},i=(e=>e.json().then(e=>e)))=>fetch(e,{method:t,body:s?JSON.stringify(s):null,headers:n}).then(e=>{if(e.status>=500){return(-1!==e.headers.get("content-type").indexOf("application/json")?e.json():e.text()).then(e=>{throw e})}return i(e)}),o=e=>({"X-Auth-Token":e,"Content-Type":"application/json"});var r=t=>({checkToken:e=>a(`${t}/token/${e}`,"head",null,{},e=>204===e.status),authenticate:e=>a(`${t}/token/${e}`,"get",null,{}),logIn(s={}){const n={backend:s.backend||"wazo_user",expiration:s.expiration||3600},i={Authorization:`Basic ${e.Base64.encode(`${s.username}:${s.password}`)}`,"Content-Type":"application/json"};return a(`${t}/token`,"post",n,i)},logOut:e=>a(`${t}/token/${e}`,"delete"),updatePassword:(e,s,n,i)=>a(`${t}/users/${s}/password`,"put",{new_password:i,old_password:n},o(e)),sendDeviceToken:(e,s,n)=>a(`${t}/users/${s}/external/mobile`,"post",{token:n},o(e)),removeDeviceToken:(e,s)=>a(`${t}/users/${s}/external/mobile`,"delete",null,o(e)),listTenants:e=>a(`${t}/tenants`,"get",null,o(e)),createTenant:(e,s)=>a(`${t}/tenants`,"post",{name:s},o(e)),deleteTenant:(e,s)=>a(`${t}/tenants/${s}`,"delete",null,o(e),e=>204===e.status),listUsers:e=>a(`${t}/users`,"get",null,o(e)),listGroups:e=>a(`${t}/groups`,"get",null,o(e)),listPolicies:e=>a(`${t}/policies`,"get",null,o(e))}),l=e=>({answerCall(t,s,n,i,r,l){const c=`${e}/${s}/nodes`,u={calls:[{id:n}]},d=o(t);return a(c,"post",u,d,e=>e.data.uuid).then(e=>a(`${c}/${e}/calls`,"post",{context:i,exten:r,autoanswer:l},d).then(t=>({nodeUuid:e,data:t})))},calls:(t,s)=>a(`${e}/${s}/calls`,"get",null,o(t)),hangupCall:(t,s,n)=>a(`${e}/${s}/calls/${n}`,"delete",null,o(t)),playCall:(t,s,n,i,r)=>a(`${e}/${s}/calls/${n}/play`,"post",{language:i,uri:r},o(t)),addCallNodes:(t,s,n,i)=>a(`${e}/${s}/nodes/${n}/calls/${i}`,"put",null,o(t)),addNewCallNodes:(t,s,n,i,r,l)=>a(`${e}/${s}/nodes/${n}/calls`,"post",{context:i,exten:r,autoanswer:l},o(t)),listCallsNodes:(t,s,n)=>a(`${e}/${s}/nodes/${n}`,"get",null,o(t)),listNodes:(t,s)=>a(`${e}/${s}/nodes`,"get",null,o(t)),removeNode:(t,s,n)=>a(`${e}/${s}/nodes/${n}`,"delete",null,o(t)),removeCallNodes:(t,s,n,i)=>a(`${e}/${s}/nodes/${n}/calls/${i}`,"delete",null,o(t))}),c=e=>({listUsers:t=>a(`${e}/users`,"get",null,o(t)),getUser:(t,s)=>a(`${e}/users/${s}`,"get",null,o(t)),getUserLineSip:(t,s,n)=>a(`${e}/users/${s}/lines/${n}/associated/endpoints/sip`,"get",null,o(t)),listApplications:t=>a(`${e}/applications?recurse=true`,"get",null,o(t))}),u=e=>({listSubscriptions:t=>a(`${e}/subscriptions?recurse=true`,"get",null,o(t)),createSubscription(t,{tenantUuid:s,productSku:n,name:i,startDate:r,contractDate:l,autoRenew:c,term:u}){const d={product_sku:n,name:i,start_date:r,contract_date:l,auto_renew:c,term:u},p=o(t);return s&&(p["Wazo-Tenant"]=s),a(`${e}/subscriptions`,"post",d,p)},getSubscription:(t,s)=>a(`${e}/subscriptions/${s}`,"get",null,o(t)),listAuthorizations:(t,s)=>a(`${e}/subscriptions/${s}/authorizations`,"get",null,o(t)),getAuthorization:(t,s,n)=>a(`${e}/subscriptions/${s}/authorizations/${n}`,"get",null,o(t)),createAuthorization:(t,s,{startDate:n,term:i,service:r,rules:l,autoRenew:c})=>a(`${e}/subscriptions/${s}/authorizations`,"post",{start_date:n,term:i,service:r,rules:l,auto_renew:c},o(t))}),d=e=>({updatePresence:(t,s)=>a(`${e}/users/me/presences`,"put",{presence:s},o(t))});const p="0.1",h="1.0",$="1.1",g="1.0",b="1.0";const f=["STATUS_NULL","STATUS_NEW","STATUS_CONNECTING","STATUS_CONNECTED","STATUS_COMPLETED"],w=e=>({caller_id_name:e.remoteIdentity.displayName,caller_id_number:e.remoteIdentity.uri.user}),k=e=>!!e.getHeader("alert-info"),m=/^\+?[0-9#*]+$/;return{WazoApiClient:class{constructor({server:e}){this.server=e}initializeEndpoints(){this.auth=r(this.authUrl),this.application=l(this.applicationUrl),this.confd=c(this.confdUrl),this.accessd=u(this.accessdUrl),this.ctidng=d(this.ctidngUrl)}set server(e){this._server=e,this.initializeEndpoints()}get authUrl(){return`${this.baseUrl}/auth/${p}`}get applicationUrl(){return`${this.baseUrl}/ctid-ng/${h}/applications`}get confdUrl(){return`${this.baseUrl}/confd/${$}`}get accessdUrl(){return`${this.baseUrl}/accessd/${g}`}get ctidngUrl(){return`${this.baseUrl}/ctid-ng/${b}`}get baseUrl(){return`https://${this._server}/api`}},WazoWebRTCClient:class{constructor(e,t){this.config=e,this.ua=this.configureUa(),this.callback=t}configureUa(){const e=new t.Web.Simple(this.getConfig());return e.on("registered",()=>{this.callback("phone-events-registered")}),e.on("unregistered",()=>{this.callback("phone-events-unregistered")}),e.on("new",e=>{const t={callerid:w(e),autoanswer:k(e.request)};this.callback("phone-events-new",t)}),e.on("ringing",()=>{this.callback("phone-events-ringing")}),e.on("connected",()=>{this.callback("phone-events-connected")}),e.on("ended",()=>{this.callback("phone-events-ended")}),e}getConfig(){return{media:{remote:{audio:this.config.media.audio}},ua:{traceSip:!1,displayName:this.config.displayName,uri:this.config.uri,wsServers:this.config.wsServers,authorizationUser:this.config.authorizationUser,password:this.config.password,sessionDescriptionHandlerFactoryOptions:{peerConnectionOptions:{iceCheckingTimeout:500,rtcpMuxPolicy:"negotiate",rtcConfiguration:{iceServers:{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"]}}}}}}}getState(){return f[this.ua.state]}call(e){m.exec(e)&&this.ua.call(e)}answer(){this.ua.answer()}reject(){this.ua.reject()}hangup(){this.ua.hangup()}close(){this.ua.ua.transport.disconnect()}},WazoWebSocketClient:class{constructor(e){this.ws_init=!1,this.callback=e.callback,this.host=e.host,this.token=e.token,this.events=e.events}init(){const e=new s(`wss://${this.host}/api/websocketd/?token=${this.token}`);return e.debug=!1,e.onmessage=(t=>{const s=JSON.parse(t.data);this.ws_init?this.callback(s):this.initialize(s,e)}),e.onclose=(e=>{e.code}),e}initialize(e,t){switch(e.op){case"init":this.events.forEach(e=>{const s={op:"subscribe",data:{event_name:e}};t.send(JSON.stringify(s))}),t.send(JSON.stringify({op:"start"}));break;case"subscribe":break;case"start":this.ws_init=!0}}}}});
