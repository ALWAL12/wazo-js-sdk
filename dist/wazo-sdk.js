!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e["@wazo/sdk"]=t()}(this,function(){"use strict";var commonjsGlobal="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var base64=createCommonjsModule(function(module,exports){var global,factory;global="undefined"!=typeof self?self:"undefined"!=typeof window?window:commonjsGlobal,factory=function(global){var _Base64=global.Base64,version="2.4.9",buffer;if(module.exports)try{buffer=eval("require('buffer').Buffer")}catch(e){buffer=void 0}var b64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b64tab=function(e){for(var t={},r=0,i=e.length;r<i;r++)t[e.charAt(r)]=r;return t}(b64chars),fromCharCode=String.fromCharCode,cb_utob=function(e){if(e.length<2)return(t=e.charCodeAt(0))<128?e:t<2048?fromCharCode(192|t>>>6)+fromCharCode(128|63&t):fromCharCode(224|t>>>12&15)+fromCharCode(128|t>>>6&63)+fromCharCode(128|63&t);var t=65536+1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320);return fromCharCode(240|t>>>18&7)+fromCharCode(128|t>>>12&63)+fromCharCode(128|t>>>6&63)+fromCharCode(128|63&t)},re_utob=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,utob=function(e){return e.replace(re_utob,cb_utob)},cb_encode=function(e){var t=[0,2,1][e.length%3],r=e.charCodeAt(0)<<16|(e.length>1?e.charCodeAt(1):0)<<8|(e.length>2?e.charCodeAt(2):0);return[b64chars.charAt(r>>>18),b64chars.charAt(r>>>12&63),t>=2?"=":b64chars.charAt(r>>>6&63),t>=1?"=":b64chars.charAt(63&r)].join("")},btoa=global.btoa?function(e){return global.btoa(e)}:function(e){return e.replace(/[\s\S]{1,3}/g,cb_encode)},_encode=buffer?buffer.from&&Uint8Array&&buffer.from!==Uint8Array.from?function(e){return(e.constructor===buffer.constructor?e:buffer.from(e)).toString("base64")}:function(e){return(e.constructor===buffer.constructor?e:new buffer(e)).toString("base64")}:function(e){return btoa(utob(e))},encode=function(e,t){return t?_encode(String(e)).replace(/[+\/]/g,function(e){return"+"==e?"-":"_"}).replace(/=/g,""):_encode(String(e))},encodeURI=function(e){return encode(e,!0)},re_btou=new RegExp(["[À-ß][-¿]","[à-ï][-¿]{2}","[ð-÷][-¿]{3}"].join("|"),"g"),cb_btou=function(e){switch(e.length){case 4:var t=((7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3))-65536;return fromCharCode(55296+(t>>>10))+fromCharCode(56320+(1023&t));case 3:return fromCharCode((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return fromCharCode((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},btou=function(e){return e.replace(re_btou,cb_btou)},cb_decode=function(e){var t=e.length,r=t%4,i=(t>0?b64tab[e.charAt(0)]<<18:0)|(t>1?b64tab[e.charAt(1)]<<12:0)|(t>2?b64tab[e.charAt(2)]<<6:0)|(t>3?b64tab[e.charAt(3)]:0),n=[fromCharCode(i>>>16),fromCharCode(i>>>8&255),fromCharCode(255&i)];return n.length-=[0,0,2,1][r],n.join("")},atob=global.atob?function(e){return global.atob(e)}:function(e){return e.replace(/[\s\S]{1,4}/g,cb_decode)},_decode=buffer?buffer.from&&Uint8Array&&buffer.from!==Uint8Array.from?function(e){return(e.constructor===buffer.constructor?e:buffer.from(e,"base64")).toString()}:function(e){return(e.constructor===buffer.constructor?e:new buffer(e,"base64")).toString()}:function(e){return btou(atob(e))},decode=function(e){return _decode(String(e).replace(/[-_]/g,function(e){return"-"==e?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))},noConflict=function(){var e=global.Base64;return global.Base64=_Base64,e};if(global.Base64={VERSION:version,atob:atob,btoa:btoa,fromBase64:decode,toBase64:encode,utob:utob,encode:encode,encodeURI:encodeURI,btou:btou,decode:decode,noConflict:noConflict,__buffer__:buffer},"function"==typeof Object.defineProperty){var noEnum=function(e){return{value:e,enumerable:!1,writable:!0,configurable:!0}};global.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",noEnum(function(){return decode(this)})),Object.defineProperty(String.prototype,"toBase64",noEnum(function(e){return encode(this,e)})),Object.defineProperty(String.prototype,"toBase64URI",noEnum(function(){return encode(this,!0)}))}}return global.Meteor&&(Base64=global.Base64),module.exports&&(module.exports.Base64=global.Base64),{Base64:global.Base64}},module.exports=factory(global)}),base64_1=base64.Base64;class BadResponse extends Error{static fromResponse(e,t){return new BadResponse(e.message,t,e.timestamp,e.error_id,e.details)}static fromText(e,t){return new BadResponse(e,t)}constructor(e,t,r=null,i=null,n=null){super(e),this.timestamp=r,this.status=t,this.errorId=i,this.details=n}}class ServerError extends BadResponse{static fromResponse(e,t){return new ServerError(e.message,t,e.timestamp,e.error_id,e.details)}static fromText(e,t){return new ServerError(e,t)}}class Logger{static hasDebug(){return"undefined"!=typeof process&&(1==+process.env.DEBUG||"true"===process.env.DEBUG)}static logRequest(e,{method:t,body:r,headers:i},n){if(!Logger.hasDebug())return;const{status:s}=n;let o=`${s} - curl ${"get"!==t?`-X ${t.toUpperCase()}`:""}`;Object.keys(i).forEach(e=>{o+=` -H '${e}: ${i[e]}'`}),o+=` ${e}`,r&&(o+=` -d '${r}'`),console.info(o)}}const methods=["head","get","post","put","delete"],realFetch=()=>"undefined"==typeof fetch?require("node-fetch/lib/index"):fetch;class ApiRequester{static successResponseParser(e,t){return 204===e.status}static defaultParser(e){return e.json().then(e=>e)}static getHeaders(e){return e instanceof Object?e:{"X-Auth-Token":e,Accept:"application/json","Content-Type":"application/json"}}static getQueryString(e){return Object.keys(e).filter(t=>e[t]).map(t=>`${t}=${encodeURIComponent(e[t])}`).join("&")}static base64Encode(e){return"undefined"!=typeof btoa?btoa(e):base64_1.encode(e)}constructor({server:e,agent:t=null}){this.server=e,this.agent=t,methods.forEach(e=>{ApiRequester.prototype[e]=function(...t){return t.splice(1,0,e),this.call.call(this,...t)}})}call(e,t="get",r=null,i=null,n=ApiRequester.defaultParser){const s=this.computeUrl(t,e,r),o=r&&"get"!==t?JSON.stringify(r):null,a="head"===t,c="delete"===t||a?ApiRequester.successResponseParser:n,u={method:t,body:o,headers:i?ApiRequester.getHeaders(i):{},agent:this.agent};return realFetch()(s,u).then(e=>{const t=-1!==(e.headers.get("content-type")||"").indexOf("application/json");if(Logger.logRequest(s,u,e),a&&e.status>=500||!a&&e.status>=400){const r=t?e.json():e.text(),i=e.status>=500?ServerError:BadResponse;return r.then(t=>{throw"string"==typeof t?i.fromText(t,e.status):i.fromResponse(t,e.status)})}return c(e,t)})}computeUrl(e,t,r){const i=`${this.baseUrl}/${t}`;return"get"===e&&r&&Object.keys(r).length?`${i}?${ApiRequester.getQueryString(r)}`:i}get baseUrl(){return`https://${this.server}/api`}}var newFrom=(e,t)=>{const r={};return Object.getOwnPropertyNames(e).forEach(t=>{r[t]=e[t]}),new t(r)};class Line{static parse(e){return new Line({id:e.id,extensions:e.extensions})}static newFrom(e){return newFrom(e,Line)}constructor({id:e,extensions:t}={}){this.id=e,this.extensions=t}}const FORWARD_KEYS={BUSY:"busy",NO_ANSWER:"noanswer",UNCONDITIONAL:"unconditional"};class ForwardOption{static parse(e,t){return new ForwardOption({destination:e.destination||"",enabled:e.enabled,key:t})}static newFrom(e){return newFrom(e,ForwardOption)}constructor({destination:e,enabled:t,key:r}={}){this.destination=e,this.enabled=t,this.key=r}setDestination(e){return this.destination=e,this}is(e){return this.key===e.key}}const PRESENCE={AVAILABLE:"available",DO_NOT_DISTURB:"donotdisturb",DISCONNECTED:"disconnected"};class Profile{static parse(e){return new Profile({id:e.uuid,firstName:e.firstName,lastName:e.lastName,email:e.email,lines:e.lines.map(e=>Line.parse(e)),username:e.username,mobileNumber:e.mobile_phone_number||"",forwards:[ForwardOption.parse(e.forwards.unconditional,FORWARD_KEYS.UNCONDITIONAL),ForwardOption.parse(e.forwards.noanswer,FORWARD_KEYS.NO_ANSWER),ForwardOption.parse(e.forwards.busy,FORWARD_KEYS.BUSY)],doNotDisturb:e.services.dnd.enabled})}static newFrom(e){return newFrom(e,Profile)}constructor({id:e,firstName:t,lastName:r,email:i,lines:n,username:s,mobileNumber:o,forwards:a,doNotDisturb:c,presence:u}={}){this.id=e,this.firstName=t,this.lastName=r,this.email=i,this.lines=n,this.username=s,this.mobileNumber=o,this.forwards=a,this.doNotDisturb=c,this.presence=u}hasId(e){return e===this.id}setMobileNumber(e){return this.mobileNumber=e,this}setForwardOption(e){const t=this.forwards.slice(),r=t.findIndex(t=>t.is(e));return t.splice(r,1,e),this.forwards=t,this}setDoNotDisturb(e){return this.doNotDisturb=e,this}setPresence(e){return this.presence=e,this}}class Contact{static merge(e,t){return t.map(t=>{const r=e.find(e=>e.is(t));return void 0!==r?t.merge(r):t})}static parseMany(e){return e.results.map(t=>Contact.parse(t,e.column_types))}static parse(e,t){return new Contact({name:e.column_values[t.indexOf("name")],number:e.column_values[t.indexOf("number")]||"",favorited:e.column_values[t.indexOf("favorite")],email:e.column_values[t.indexOf("email")]||"",entreprise:e.column_values[t.indexOf("entreprise")]||"",birthday:e.column_values[t.indexOf("birthday")]||"",address:e.column_values[t.indexOf("address")]||"",note:e.column_values[t.indexOf("note")]||"",endpointId:e.relations.endpoint_id,personal:e.column_values[t.indexOf("personal")],source:e.source,sourceId:e.relations.source_entry_id,uuid:e.relations.user_uuid})}static parseManyPersonal(e){return e.map(e=>Contact.parsePersonal(e))}static parsePersonal(e){return new Contact({name:`${e.firstName||e.firstname||""} ${e.lastName||e.lastname||""}`,number:e.number||"",email:e.email||"",source:"personal",sourceId:e.id,entreprise:e.entreprise||"",birthday:e.birthday||"",address:e.address||"",note:e.note||"",favorited:!1,personal:!0})}static newFrom(e){return newFrom(e,Contact)}constructor({id:e,uuid:t,name:r,number:i,email:n,source:s,sourceId:o,entreprise:a,birthday:c,address:u,note:d,presence:h,status:l,endpointId:p,personal:f}={}){this.id=e,this.uuid=t,this.name=r,this.number=i,this.email=n,this.source=s,this.sourceId=o||"",this.entreprise=a,this.birthday=c,this.address=u,this.note=d,this.presence=h,this.status=l,this.endpointId=p,this.personal=f}setFavorite(e){return this.favorited=e,this}is(e){return Boolean(e)&&this.sourceId===e.sourceId&&(!this.uuid||this.uuid===e.uuid)}hasId(e){return this.uuid===e}hasNumber(e){return this.number===e}hasEndpointId(e){return this.endpointId===e}isAvailable(){return"available"===this.presence}isDoNotDisturb(){return"donotdisturb"===this.presence}isDisconnected(){return"disconnected"===this.presence}merge(e){return this.presence=e.presence,this.status=e.status,this}isIntern(){return!!this.uuid}isCallable(e){return!!this.number&&!!e&&!e.is(this)}separateName(){if(!this.name)return{firstName:"",lastName:""};const e=this.name.split(" ");return{firstName:e[0],lastName:e.slice(1).join(" ")}}}class Session{static parse(e){return new Session({token:e.data.token,uuid:e.data.xivo_user_uuid})}static newFrom(e){return newFrom(e,Session)}constructor({token:e,uuid:t,profile:r}={}){this.token=e,this.uuid=t,this.profile=r}is(e){return Boolean(e)&&this.uuid===e.uuid}using(e){return this.profile=e,this}displayName(){return this.profile?`${this.profile.firstName} ${this.profile.lastName}`:""}primaryLine(){return this.profile?this.profile.lines[0]:null}primaryContext(){const e=this.primaryLine();return e?e.extensions[0].context:null}primaryNumber(){const e=this.primaryLine();return e?e.extensions[0].exten:null}}const DEFAULT_BACKEND_USER="wazo_user",DETAULT_EXPIRATION=3600;var authMethods=(e,t)=>({checkToken:r=>e.head(`${t}/token/${r}`,null,{}),authenticate:r=>e.get(`${t}/token/${r}`,null,{}).then(e=>Session.parse(e)),logIn(r){const i={backend:r.backend||DEFAULT_BACKEND_USER,expiration:r.expiration||DETAULT_EXPIRATION},n={Authorization:`Basic ${ApiRequester.base64Encode(`${r.username}:${r.password}`)}`,"Content-Type":"application/json"};return e.post(`${t}/token`,i,n).then(e=>Session.parse(e))},logOut:r=>e.delete(`${t}/token/${r}`,null,{},ApiRequester.successResponseParser),updatePassword(r,i,n,s){const o={new_password:s,old_password:n};return e.put(`${t}/users/${i}/password`,o,r,ApiRequester.successResponseParser)},sendDeviceToken(r,i,n){const s={token:n};return e.post(`${t}/users/${i}/external/mobile`,s,r)},removeDeviceToken:(r,i)=>e.delete(`${t}/users/${i}/external/mobile`,null,r),getUser:(r,i)=>e.get(`${t}/users/${i}`,null,r),listTenants:r=>e.get(`${t}/tenants`,null,r),getTenant:(r,i)=>e.get(`${t}/tenants/${i}`,null,r),createTenant:(r,i)=>e.post(`${t}/tenants`,{name:i},r),deleteTenant:(r,i)=>e.delete(`${t}/tenants/${i}`,null,r),listUsers:r=>e.get(`${t}/users`,null,r),listGroups:r=>e.get(`${t}/groups`,null,r),listPolicies:r=>e.get(`${t}/policies`,null,r)}),applicationMethods=(e,t)=>({answerCall(r,i,n,s,o,a){const c=`${t}/${i}/nodes`,u={calls:[{id:n}]};return e.post(c,u,r,e=>e.data.uuid).then(t=>e.post(`${c}/${t}/calls`,{context:s,exten:o,autoanswer:a},r).then(e=>({nodeUuid:t,data:e})))},calls:(r,i)=>e.get(`${t}/${i}/calls`,null,r),hangupCall(r,i,n){const s=`${t}/${i}/calls/${n}`;return e.delete(s,null,r)},playCall:(r,i,n,s,o)=>e.post(`${t}/${i}/calls/${n}/play`,{language:s,uri:o},r),addCallNodes:(r,i,n,s)=>e.put(`${t}/${i}/nodes/${n}/calls/${s}`,null,r),addNewCallNodes(r,i,n,s,o,a){const c={context:s,exten:o,autoanswer:a};return e.post(`${t}/${i}/nodes/${n}/calls`,c,r)},listCallsNodes:(r,i,n)=>e.get(`${t}/${i}/nodes/${n}`,null,r),listNodes:(r,i)=>e.get(`${t}/${i}/nodes`,null,r),removeNode:(r,i,n)=>e.delete(`${t}/${i}/nodes/${n}`,null,r),removeCallNodes:(r,i,n,s)=>e.delete(`${t}/${i}/nodes/${n}/calls/${s}`,null,r)}),confdMethods=(e,t)=>({listUsers:r=>e.get(`${t}/users`,null,r),getUser:(r,i)=>e.get(`${t}/users/${i}`,null,r).then(e=>Profile.parse(e)),updateUser(r,i,n){const s={firstname:n.firstName,lastname:n.lastName,email:n.email,mobile_phone_number:n.mobileNumber};return e.put(`${t}/users/${i}`,s,r,ApiRequester.successResponseParser)},updateForwardOption(r,i,n,s,o){const a=`${t}/users/${i}/forwards/${n}`;return e.put(a,{destination:s,enabled:o},r,ApiRequester.successResponseParser)},updateDoNotDisturb(r,i,n){const s=`${t}/users/${i}/services/dnd`;return e.put(s,{enabled:n},r,ApiRequester.successResponseParser)},getUserLineSip:(r,i,n)=>e.get(`${t}/users/${i}/lines/${n}/associated/endpoints/sip`,null,r),listApplications(r){const i=`${t}/applications?recurse=true`;return e.get(i,null,r)},getSIP:(r,i,n)=>e.get(`${t}/users/${i}/lines/${n}/associated/endpoints/sip`,null,r)}),accessdMethods=(e,t)=>({listSubscriptions:r=>e.get(`${t}/subscriptions?recurse=true`,null,r),createSubscription(r,{tenantUuid:i,productSku:n,name:s,startDate:o,contractDate:a,autoRenew:c,term:u}){const d={product_sku:n,name:s,start_date:o,contract_date:a,auto_renew:c,term:u},h={"X-Auth-Token":r};return i&&(h["Wazo-Tenant"]=i),e.post(`${t}/subscriptions`,d,h)},getSubscription:(r,i)=>e.get(`${t}/subscriptions/${i}`,null,r),listAuthorizations:(r,i)=>e.get(`${t}/subscriptions/${i}/authorizations`,null,r),getAuthorization:(r,i,n)=>e.get(`${t}/subscriptions/${i}/authorizations/${n}`,null,r),createAuthorization(r,i,{startDate:n,term:s,service:o,rules:a,autoRenew:c}){const u=`${t}/subscriptions/${i}/authorizations`,d={start_date:n,term:s,service:o,rules:a,auto_renew:c};return e.post(u,d,r)}});const uuid=()=>{const e=()=>Math.floor(65536*(1+Math.random())).toString(16).substring(1);return`${e()}${e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`};class ChatMessage{static parseMany(e){return e.items.map(e=>ChatMessage.parse(e))}static parse(e){return new ChatMessage({id:uuid(),date:new Date(e.date),message:e.msg,direction:e.direction,destination:{serverId:e.destination_server_uuid,userId:e.destination_user_uuid},source:{serverId:e.source_server_uuid,userId:e.source_user_uuid},read:!0})}static parseMessageSent(e){return new ChatMessage({id:uuid(),date:new Date,message:e.msg,direction:"sent",destination:{serverId:e.to[0],userId:e.to[1]},source:{serverId:e.from[0],userId:e.from[1]},read:!0})}static parseMessageReceived(e){return new ChatMessage({id:uuid(),date:new Date,message:e.msg,direction:"received",destination:{serverId:e.to[0],userId:e.to[1]},source:{serverId:e.from[0],userId:e.from[1]},read:!1})}static newFrom(e){return newFrom(e,ChatMessage)}constructor({id:e,date:t,message:r,direction:i,destination:n,source:s,read:o=!0}={}){this.id=e,this.date=t,this.message=r,this.direction=i,this.destination=n,this.source=s,this.read=o}is(e){return this.id===e.id}isIncoming(){return"received"===this.direction}acknowledge(){return this.read=!0,this}getTheOtherParty(){return"sent"===this.direction?this.destination.userId:this.source.userId}}class Voicemail{static parse(e){return new Voicemail({id:e.id,date:new Date(e.timestamp),duration:1e3*e.duration,caller:{name:e.caller_id_name,number:e.caller_id_num},unread:e.folder?"new"===e.folder.type:null})}static parseMany(e){const t=e.folders.filter(e=>"new"===e.type)[0].messages,r=e.folders.filter(e=>"old"===e.type)[0].messages;return[...t.map(e=>Voicemail.parse(e)).map(e=>e.makeAsUnRead()),...r.map(e=>Voicemail.parse(e)).map(e=>e.acknowledge())]}static newFrom(e){return newFrom(e,Voicemail)}constructor({id:e,date:t,duration:r,caller:i}={}){this.id=e,this.date=t,this.duration=r,this.caller=i}is(e){return e&&this.id===e.id}acknowledge(){return this.unread=!1,this}makeAsUnRead(){return this.unread=!0,this}contains(e){return!e||(this.caller.name.toUpperCase().includes(e.toUpperCase())||this.caller.number.includes(e))}}class Call{static parseMany(e){return e.map(e=>Call.parse(e))}static parse(e){return new Call({id:+e.call_id,calleeName:e.peer_caller_id_name,calleeNumber:e.peer_caller_id_number,status:e.status,startingTime:new Date(e.creation_time)})}static newFrom(e){return newFrom(e,Call)}constructor({id:e,calleeName:t,calleeNumber:r,status:i,startingTime:n}={}){this.id=e,this.calleeName=t,this.calleeNumber=r,this.status=i,this.startingTime=n}separateCalleeName(){const e=this.calleeName.split(" ");return{firstName:e[0],lastName:e.slice(1).join(" ")}}is(e){return this.id===e.id}hasACalleeName(){return this.calleeName.length>0}isUp(){return"Up"===this.status}isDown(){return"Down"===this.status}isRingingIncoming(){return"Ringing"===this.status}isRingingOutgoing(){return"Ring"===this.status}isFromTransfer(){return"Down"===this.status||"Ringing"===this.status}}var ctidNgMethods=(e,t)=>({updatePresence:(r,i)=>e.put(`${t}/users/me/presences`,{presence:i},r,ApiRequester.successResponseParser),listMessages(r,i){const n=i?{participant_user_uuid:i}:null;return e.get(`${t}/users/me/chats`,n,r).then(e=>ChatMessage.parseMany(e))},sendMessage(r,i,n,s){const o={alias:i,msg:n,to:s};return e.post(`${t}/users/me/chats`,o,r,ApiRequester.successResponseParser)},makeCall:(r,i)=>e.post(`${t}/users/me/calls`,{from_mobile:!0,extension:i},r),cancelCall:(r,i)=>e.delete(`${t}/users/me/calls/${i}`,null,r),listCalls:r=>e.get(`${t}/users/me/calls`,null,r).then(e=>Call.parseMany(e.items)),relocateCall(r,i,n,s){const o={completions:["answer"],destination:n,initiator_call:i};return s&&(o.location={line_id:s}),e.post(`${t}/users/me/relocates`,o,r)},listVoicemails:r=>e.get(`${t}/users/me/voicemails`,null,r).then(e=>Voicemail.parseMany(e)),deleteVoicemail:(r,i)=>e.delete(`${t}/users/me/voicemails/messages/${i}`,null,r),getPresence:(r,i)=>e.get(`${t}/users/${i}/presences`,null,r),getStatus:(r,i)=>e.get(`${t}/lines/${i}/presences`,null,r)});const getContactPayload=e=>({email:e.email,firstname:e.firstName?e.firstName:null,lastname:e.lastName?e.lastName:null,number:e.phoneNumber?e.phoneNumber:null,entreprise:e.entreprise,birthday:e.birthday,address:e.address,note:e.note});var dirdMethods=(e,t)=>({search:(r,i,n)=>e.get(`${t}/directories/lookup/${i}`,{term:n},r).then(e=>Contact.parseMany(e)),listPersonalContacts:r=>e.get(`${t}/personal`,null,r).then(e=>Contact.parseManyPersonal(e.items)),addContact:(r,i)=>e.post(`${t}/personal`,getContactPayload(i),r).then(e=>Contact.parsePersonal(e)),editContact:(r,i)=>e.put(`${t}/personal/${i.id||""}`,getContactPayload(i),r),deleteContact:(r,i)=>e.delete(`${t}/personal/${i}`,null,r),listFavorites:(r,i)=>e.get(`${t}/directories/favorites/${i}`,null,r).then(e=>Contact.parseMany(e)),markAsFavorite(r,i,n){const s=`${t}/directories/favorites/${i}/${n}`;return e.put(s,null,r,ApiRequester.successResponseParser)},removeFavorite:(r,i,n)=>e.delete(`${t}/directories/favorites/${i}/${n}`,null,r)});class CallLog{static merge(e,t){const r=e.concat(t);return r.map(e=>e.id).filter((e,t,r)=>r.indexOf(e)===t).map(e=>r.find(t=>t.id===e))}static parseMany(e){return e.items.map(e=>CallLog.parse(e))}static parse(e){return new CallLog({answer:new Date(e.answer),answered:e.answered,callDirection:e.call_direction,destination:{extension:e.destination_extension,name:e.destination_name||""},source:{extension:e.source_extension,name:e.source_name},id:e.id,duration:1e3*(e.duration||0),start:new Date(e.start),end:new Date(e.end)})}static parseNew(e,t){return new CallLog({answer:new Date(e.answer),answered:e.answered,callDirection:e.call_direction,destination:{extension:e.destination_extension,name:e.destination_name||""},source:{extension:e.source_extension,name:e.source_name},id:e.id,duration:1e3*(e.duration||0),start:new Date(e.start),end:new Date(e.end),newMissedCall:e.destination_extension===t.primaryNumber()&&!e.answered})}static newFrom(e){return newFrom(e,CallLog)}constructor({answer:e,answered:t,callDirection:r,destination:i,source:n,id:s,duration:o,start:a,end:c}={}){this.answer=e,this.answered=t,this.callDirection=r,this.destination=i,this.source=n,this.id=s,this.duration=o,this.start=a,this.end=c}isFromSameParty(e,t){return this.theOtherParty(t).extension===e.theOtherParty(t).extension}theOtherParty(e){return this.source.extension===e.primaryNumber()?this.destination:this.source}isNewMissedCall(){return this.newMissedCall}acknowledgeCall(){return this.newMissedCall=!1,this}isAcknowledged(){return this.newMissedCall}isAnOutgoingCall(e){return this.source.extension===e.primaryNumber()&&this.answered}isAMissedOutgoingCall(e){return this.source.extension===e.primaryNumber()&&!this.answered}isAnIncomingCall(e){return this.destination.extension===e.primaryNumber()&&this.answered}isADeclinedCall(e){return this.destination.extension===e.primaryNumber()&&!this.answered}}var callLogdMethods=(e,t)=>({search:(r,i,n=5)=>e.get(`${t}/users/me/cdr`,{search:i,limit:n},r).then(e=>CallLog.parseMany(e)),listCallLogs:(r,i,n=5)=>e.get(`${t}/users/me/cdr`,{offset:i,limit:n},r).then(e=>CallLog.parseMany(e)),listCallLogsFromDate:(r,i,n)=>e.get(`${t}/users/me/cdr`,{from:i.toISOString(),number:n},r).then(e=>CallLog.parseMany(e))});const AUTH_VERSION="0.1",APPLICATION_VERSION="1.0",CONFD_VERSION="1.1",ACCESSD_VERSION="1.0",CTIDNG_VERSION="1.0",DIRD_VERSION="0.1",CALL_LOGD_VERSION="1.0";class ApiClient{constructor({server:e,agent:t=null}){this.updatePatemers({server:e,agent:t})}initializeEndpoints(){this.auth=authMethods(this.client,`auth/${AUTH_VERSION}`),this.application=applicationMethods(this.client,`ctid-ng/${APPLICATION_VERSION}/applications`),this.confd=confdMethods(this.client,`confd/${CONFD_VERSION}`),this.accessd=accessdMethods(this.client,`accessd/${ACCESSD_VERSION}`),this.ctidNg=ctidNgMethods(this.client,`ctid-ng/${CTIDNG_VERSION}`),this.dird=dirdMethods(this.client,`dird/${DIRD_VERSION}`),this.callLogd=callLogdMethods(this.client,`call-logd/${CALL_LOGD_VERSION}`)}updatePatemers({server:e,agent:t}){this.client=new ApiRequester({server:e,agent:t}),this.initializeEndpoints()}}var logDisabled_=!0,deprecationWarnings_=!0;function extractVersion(e,t,r){var i=e.match(t);return i&&i.length>=r&&parseInt(i[r],10)}function wrapPeerConnectionEvent(e,t,r){if(e.RTCPeerConnection){var i=e.RTCPeerConnection.prototype,n=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return n.apply(this,arguments);var s=function(e){var t=r(e);t&&i(t)};return this._eventMap=this._eventMap||{},this._eventMap[i]=s,n.apply(this,[e,s])};var s=i.removeEventListener;i.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return s.apply(this,arguments);var i=this._eventMap[r];return delete this._eventMap[r],s.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}}var utils={extractVersion:extractVersion,wrapPeerConnectionEvent:wrapPeerConnectionEvent,disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(logDisabled_=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},disableWarnings:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(deprecationWarnings_=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},log:function(){if("object"==typeof window){if(logDisabled_)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},deprecated:function(e,t){deprecationWarnings_&&console.warn(e+" is deprecated, please use "+t+" instead.")},detectBrowser:function(e){var t=e&&e.navigator,r={browser:null,version:null};if(void 0===e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=extractVersion(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia)r.browser="chrome",r.version=extractVersion(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=extractVersion(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return r.browser="Not a supported browser.",r;r.browser="safari",r.version=extractVersion(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return r}},logging=utils.log,getusermedia=function(e){var t=utils.detectBrowser(e),r=e&&e.navigator,i=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var i="object"==typeof e[r]?e[r]:{ideal:e[r]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);var n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];var s={};"number"==typeof i.ideal?(s[n("min",r)]=i.ideal,t.optional.push(s),(s={})[n("max",r)]=i.ideal,t.optional.push(s)):(s[n("",r)]=i.ideal,t.optional.push(s))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",r)]=i.exact):["min","max"].forEach(function(e){void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,r)]=i[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},n=function(e,n){if(t.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){var s=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};s((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),s(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=i(e.audio)}if(e&&"object"==typeof e.video){var o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});var a,c=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!r.mediaDevices.getSupportedConstraints||!r.mediaDevices.getSupportedConstraints().facingMode||c))if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?a=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(a=["front"]),a)return r.mediaDevices.enumerateDevices().then(function(t){var r=(t=t.filter(function(e){return"videoinput"===e.kind})).find(function(e){return a.some(function(t){return-1!==e.label.toLowerCase().indexOf(t)})});return!r&&t.length&&-1!==a.indexOf("back")&&(r=t[t.length-1]),r&&(e.video.deviceId=o.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=i(e.video),logging("chrome: "+JSON.stringify(e)),n(e)});e.video=i(e.video)}return logging("chrome: "+JSON.stringify(e)),n(e)},s=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};r.getUserMedia=function(e,t,i){n(e,function(e){r.webkitGetUserMedia(e,t,function(e){i&&i(s(e))})})};var o=function(e){return new Promise(function(t,i){r.getUserMedia(e,t,i)})};if(r.mediaDevices||(r.mediaDevices={getUserMedia:o,enumerateDevices:function(){return new Promise(function(t){var r={audio:"audioinput",video:"videoinput"};return e.MediaStreamTrack.getSources(function(e){t(e.map(function(e){return{label:e.label,kind:r[e.kind],deviceId:e.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),r.mediaDevices.getUserMedia){var a=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(e){return n(e,function(e){return a(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(s(e))})})}}else r.mediaDevices.getUserMedia=function(e){return o(e)};void 0===r.mediaDevices.addEventListener&&(r.mediaDevices.addEventListener=function(){logging("Dummy mediaDevices.addEventListener called.")}),void 0===r.mediaDevices.removeEventListener&&(r.mediaDevices.removeEventListener=function(){logging("Dummy mediaDevices.removeEventListener called.")})},logging$1=utils.log;function walkStats(e,t,r){t&&!r.has(t.id)&&(r.set(t.id,t),Object.keys(t).forEach(function(i){i.endsWith("Id")?walkStats(e,e.get(t[i]),r):i.endsWith("Ids")&&t[i].forEach(function(t){walkStats(e,e.get(t),r)})}))}function filterStats(e,t,r){var i=r?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;var s=[];return e.forEach(function(e){"track"===e.type&&e.trackIdentifier===t.id&&s.push(e)}),s.forEach(function(t){e.forEach(function(r){r.type===i&&r.trackId===t.id&&walkStats(e,r,n)})}),n}var chrome_shim={shimGetUserMedia:getusermedia,shimMediaStream:function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},shimOnTrack:function(e){if("object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)utils.wrapPeerConnectionEvent(e,"track",function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e});else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var r=this;return r._ontrackpoly||(r._ontrackpoly=function(t){t.stream.addEventListener("addtrack",function(i){var n;n=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find(function(e){return e.track&&e.track.id===i.track.id}):{track:i.track};var s=new Event("track");s.track=i.track,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],r.dispatchEvent(s)}),t.stream.getTracks().forEach(function(i){var n;n=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find(function(e){return e.track&&e.track.id===i.id}):{track:i};var s=new Event("track");s.track=i,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],r.dispatchEvent(s)})},r.addEventListener("addstream",r._ontrackpoly)),t.apply(r,arguments)}}},shimGetSendersWithDtmf:function(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){var n=r.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;r._senders=r._senders||[],n.apply(r,[e]),e.getTracks().forEach(function(e){r._senders.push(t(r,e))})};var s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._senders=t._senders||[],s.apply(t,[e]),e.getTracks().forEach(function(e){var r=t._senders.find(function(t){return t.track===e});r&&t._senders.splice(t._senders.indexOf(r),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var o=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=o.apply(e,[]);return t.forEach(function(t){t._pc=e}),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},shimSenderReceiverGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(e,[]);return r.forEach(function(t){t._pc=e}),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return filterStats(t,e.track,!0)})}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var i=e.RTCPeerConnection.prototype.getReceivers;i&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=i.apply(e,[]);return t.forEach(function(t){t._pc=e}),t}),utils.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver._pc=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return filterStats(t,e.track,!1)})}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){var t,r,i,s=arguments[0];return this.getSenders().forEach(function(e){e.track===s&&(t?i=!0:t=e)}),this.getReceivers().forEach(function(e){return e.track===s&&(r?i=!0:r=e),e.track===s}),i||t&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return n.apply(this,arguments)}}}},shimSourceObject:function(e){var t=e&&e.URL;"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var r=this;this._srcObject=e,this.src&&t.revokeObjectURL(this.src),e?(this.src=t.createObjectURL(e),e.addEventListener("addtrack",function(){r.src&&t.revokeObjectURL(r.src),r.src=t.createObjectURL(e)}),e.addEventListener("removetrack",function(){r.src&&t.revokeObjectURL(r.src),r.src=t.createObjectURL(e)})):this.src=""}}))},shimAddTrackRemoveTrackWithNative:function(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(t){return e._shimmedLocalStreams[t][0]})};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var i=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(i)&&this._shimmedLocalStreams[r.id].push(i):this._shimmedLocalStreams[r.id]=[r,i],i};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(function(e){if(t.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")});var i=t.getSenders();r.apply(this,arguments);var n=t.getSenders().filter(function(e){return-1===i.indexOf(e)});this._shimmedLocalStreams[e.id]=[e].concat(n)};var i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};var n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(function(r){var i=t._shimmedLocalStreams[r].indexOf(e);-1!==i&&t._shimmedLocalStreams[r].splice(i,1),1===t._shimmedLocalStreams[r].length&&delete t._shimmedLocalStreams[r]}),n.apply(this,arguments)}},shimAddTrackRemoveTrack:function(e){var t=utils.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return this.shimAddTrackRemoveTrackWithNative(e);var r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=r.apply(this);return e._reverseStreams=e._reverseStreams||{},t.map(function(t){return e._reverseStreams[t.id]})};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var r=this;if(r._streams=r._streams||{},r._reverseStreams=r._reverseStreams||{},t.getTracks().forEach(function(e){if(r.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")}),!r._reverseStreams[t.id]){var n=new e.MediaStream(t.getTracks());r._streams[t.id]=n,r._reverseStreams[n.id]=t,t=n}i.apply(r,[t])};var n=e.RTCPeerConnection.prototype.removeStream;function s(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var i=e._reverseStreams[t],n=e._streams[i.id];r=r.replace(new RegExp(n.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:r})}e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._streams=t._streams||{},t._reverseStreams=t._reverseStreams||{},n.apply(t,[t._streams[e.id]||e]),delete t._reverseStreams[t._streams[e.id]?t._streams[e.id].id:e.id],delete t._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){var i=this;if("closed"===i.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find(function(e){return e===t}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(i.getSenders().find(function(e){return e.track===t}))throw new DOMException("Track already exists.","InvalidAccessError");i._streams=i._streams||{},i._reverseStreams=i._reverseStreams||{};var s=i._streams[r.id];if(s)s.addTrack(t),Promise.resolve().then(function(){i.dispatchEvent(new Event("negotiationneeded"))});else{var o=new e.MediaStream([t]);i._streams[r.id]=o,i._reverseStreams[o.id]=r,i.addStream(o)}return i.getSenders().find(function(e){return e.track===t})},["createOffer","createAnswer"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this,t=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(e,[function(r){var i=s(e,r);t[0].apply(null,[i])},function(e){t[1]&&t[1].apply(null,e)},arguments[2]]):r.apply(e,arguments).then(function(t){return s(e,t)})}});var o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var i=e._reverseStreams[t],n=e._streams[i.id];r=r.replace(new RegExp(i.id,"g"),n.id)}),new RTCSessionDescription({type:t.type,sdp:r})}(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};var a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=a.get.apply(this);return""===e.type?e:s(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t,r=this;if("closed"===r.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===r))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");r._streams=r._streams||{},Object.keys(r._streams).forEach(function(i){r._streams[i].getTracks().find(function(t){return e.track===t})&&(t=r._streams[i])}),t&&(1===t.getTracks().length?r.removeStream(r._reverseStreams[t.id]):t.removeTrack(e.track),r.dispatchEvent(new Event("negotiationneeded")))}},shimPeerConnection:function(e){var t=utils.detectBrowser(e);!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=function(t,r){return logging$1("PeerConnection"),t&&t.iceTransportPolicy&&(t.iceTransports=t.iceTransportPolicy),new e.webkitRTCPeerConnection(t,r)},e.RTCPeerConnection.prototype=e.webkitRTCPeerConnection.prototype,e.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.webkitRTCPeerConnection.generateCertificate}}));var r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,t,i){var n=this,s=arguments;if(arguments.length>0&&"function"==typeof e)return r.apply(this,arguments);if(0===r.length&&(0===arguments.length||"function"!=typeof arguments[0]))return r.apply(this,[]);var o=function(e){var t={};return e.result().forEach(function(e){var r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){r[t]=e.stat(t)}),t[r.id]=r}),t},a=function(e){return new Map(Object.keys(e).map(function(t){return[t,e[t]]}))};if(arguments.length>=2){return r.apply(this,[function(e){s[1](a(o(e)))},arguments[0]])}return new Promise(function(e,t){r.apply(n,[function(t){e(a(o(t)))},t])}).then(t,i)},t.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=arguments,t=this,i=new Promise(function(i,n){r.apply(t,[e[0],i,n])});return e.length<2?i:i.then(function(){e[1].apply(null,[])},function(t){e.length>=3&&e[2].apply(null,[t])})}}),t.version<52&&["createOffer","createAnswer"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var t=1===arguments.length?arguments[0]:void 0;return new Promise(function(i,n){r.apply(e,[i,n,t])})}return r.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}});var i=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}},fixNegotiationNeeded:function(e){utils.wrapPeerConnectionEvent(e,"negotiationneeded",function(e){if("stable"===e.target.signalingState)return e})},shimGetDisplayMedia:function(e,t){"getDisplayMedia"in e.navigator||("function"==typeof t?navigator.getDisplayMedia=function(e){return t(e).then(function(t){return e.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:e.video.frameRate||3}},e.video&&(e.video.height&&(e.video.maxWidth=e.video.width),e.video.width&&(e.video.maxHeight=e.video.height)),navigator.mediaDevices.getUserMedia(e)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}},filtericeservers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter(function(e){if(e&&(e.urls||e.url)){var i=e.urls||e.url;e.url&&!e.urls&&utils.deprecated("RTCIceServer.url","RTCIceServer.urls");var n="string"==typeof i;return n&&(i=[i]),i=i.filter(function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!r?(r=!0,!0):0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp")}),delete e.url,e.urls=n?i[0]:i,!!i.length}})},sdp=createCommonjsModule(function(e){var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},t.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},t.getDescription=function(e){var r=t.splitSections(e);return r&&r[0]},t.getMediaSections=function(e){var r=t.splitSections(e);return r.shift(),r},t.matchPrefix=function(e,r){return t.splitLines(e).filter(function(e){return 0===e.indexOf(r)})},t.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":r.relatedAddress=t[i+1];break;case"rport":r.relatedPort=parseInt(t[i+1],10);break;case"tcptype":r.tcpType=t[i+1];break;case"ufrag":r.ufrag=t[i+1],r.usernameFragment=t[i+1];break;default:r[t[i]]=t[i+1]}return r},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,r={},i=e.substr(e.indexOf(" ")+1).split(";"),n=0;n<i.length;n++)r[(t=i[n].trim().split("="))[0].trim()]=t[1];return r},t.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var i=[];Object.keys(e.parameters).forEach(function(t){e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)}),t+="a=fmtp:"+r+" "+i.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(r.attribute=e.substr(t+1,i-t-1),r.value=e.substr(i+1)):r.attribute=e.substr(t+1),r},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},t.getMid=function(e){var r=t.matchPrefix(e,"a=mid:")[0];if(r)return r.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,r){return{role:"auto",fingerprints:t.matchPrefix(e+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),r},t.getIceParameters=function(e,r){var i=t.splitLines(e);return{usernameFragment:(i=i.concat(t.splitLines(r))).filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:i.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=t.splitLines(e)[0].split(" "),n=3;n<i.length;n++){var s=i[n],o=t.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(o){var a=t.parseRtpMap(o),c=t.matchPrefix(e,"a=fmtp:"+s+" ");switch(a.parameters=c.length?t.parseFmtp(c[0]):{},a.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(t.parseRtcpFb),r.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(a.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach(function(e){r.headerExtensions.push(t.parseExtmap(e))}),r},t.writeRtpDescription=function(e,r){var i="";i+="m="+e+" ",i+=r.codecs.length>0?"9":"0",i+=" UDP/TLS/RTP/SAVPF ",i+=r.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",r.codecs.forEach(function(e){i+=t.writeRtpMap(e),i+=t.writeFmtp(e),i+=t.writeRtcpFb(e)});var n=0;return r.codecs.forEach(function(e){e.maxptime>n&&(n=e.maxptime)}),n>0&&(i+="a=maxptime:"+n+"\r\n"),i+="a=rtcp-mux\r\n",r.headerExtensions&&r.headerExtensions.forEach(function(e){i+=t.writeExtmap(e)}),i},t.parseRtpEncodingParameters=function(e){var r,i=[],n=t.parseRtpParameters(e),s=-1!==n.fecMechanisms.indexOf("RED"),o=-1!==n.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=a.length>0&&a[0].ssrc,u=t.matchPrefix(e,"a=ssrc-group:FID").map(function(e){return e.substr(17).split(" ").map(function(e){return parseInt(e,10)})});u.length>0&&u[0].length>1&&u[0][0]===c&&(r=u[0][1]),n.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&r&&(t.rtx={ssrc:r}),i.push(t),s&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},i.push(t))}}),0===i.length&&c&&i.push({ssrc:c});var d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,i.forEach(function(e){e.maxBitrate=d})),i},t.parseRtcpParameters=function(e){var r={},i=t.matchPrefix(e,"a=ssrc:").map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];i&&(r.cname=i.value,r.ssrc=i.ssrc);var n=t.matchPrefix(e,"a=rtcp-rsize");r.reducedSize=n.length>0,r.compound=0===n.length;var s=t.matchPrefix(e,"a=rtcp-mux");return r.mux=s.length>0,r},t.parseMsid=function(e){var r,i=t.matchPrefix(e,"a=msid:");if(1===i.length)return{stream:(r=i[0].substr(7).split(" "))[0],track:r[1]};var n=t.matchPrefix(e,"a=ssrc:").map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return n.length>0?{stream:(r=n[0].value.split(" "))[0],track:r[1]}:void 0},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,r,i){var n=void 0!==r?r:2;return"v=0\r\no="+(i||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,r,i,n){var s=t.writeRtpDescription(e.kind,r);if(s+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":"active"),s+="a=mid:"+e.mid+"\r\n",e.direction?s+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var o="msid:"+n.id+" "+e.rtpSender.track.id+"\r\n";s+="a="+o,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),s},t.getDirection=function(e,r){for(var i=t.splitLines(e),n=0;n<i.length;n++)switch(i[n]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[n].substr(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){var r=t.splitLines(e)[0].substr(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(e){var r=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var r=t.splitLines(e),i=0;i<r.length;i++)if(r[i].length<2||"="!==r[i].charAt(1))return!1;return!0},e.exports=t});function fixStatsType(e){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type}function writeMediaSection(e,t,r,i,n){var s=sdp.writeRtpDescription(e.kind,t);if(s+=sdp.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=sdp.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":n||"active"),s+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var a="msid:"+(i?i.id:"-")+" "+o+"\r\n";s+="a="+a,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+sdp.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+sdp.localCName+"\r\n"),s}function filterIceServers(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter(function(e){if(e&&(e.urls||e.url)){var i=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var n="string"==typeof i;return n&&(i=[i]),i=i.filter(function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!r?(r=!0,!0):0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp")}),delete e.url,e.urls=n?i[0]:i,!!i.length}})}function getCommonCapabilities(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},i=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},n=function(e,t,r,n){var s=i(e.parameters.apt,r),o=i(t.parameters.apt,n);return s&&o&&s.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach(function(i){for(var s=0;s<t.codecs.length;s++){var o=t.codecs[s];if(i.name.toLowerCase()===o.name.toLowerCase()&&i.clockRate===o.clockRate){if("rtx"===i.name.toLowerCase()&&i.parameters&&o.parameters.apt&&!n(i,o,e.codecs,t.codecs))continue;(o=JSON.parse(JSON.stringify(o))).numChannels=Math.min(i.numChannels,o.numChannels),r.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter(function(e){for(var t=0;t<i.rtcpFeedback.length;t++)if(i.rtcpFeedback[t].type===e.type&&i.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),e.headerExtensions.forEach(function(e){for(var i=0;i<t.headerExtensions.length;i++){var n=t.headerExtensions[i];if(e.uri===n.uri){r.headerExtensions.push(n);break}}}),r}function isActionAllowedInSignalingState(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function maybeAddCandidate(e,t){var r=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return r||e.addRemoteCandidate(t),!r}function makeError(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}var rtcpeerconnection=function(e,t){function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function i(t,r,i,n){var s=new Event("track");s.track=r,s.receiver=i,s.transceiver={receiver:i},s.streams=n,e.setTimeout(function(){t._dispatchEvent("track",s)})}var n=function(r){var i=this,n=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){i[e]=n[e].bind(n)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw makeError("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require"),r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all"}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced"}if(r.iceServers=filterIceServers(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var s=r.iceCandidatePoolSize;s>0;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=sdp.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(n.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(n.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),n.prototype.onicecandidate=null,n.prototype.onaddstream=null,n.prototype.ontrack=null,n.prototype.onremovestream=null,n.prototype.onsignalingstatechange=null,n.prototype.oniceconnectionstatechange=null,n.prototype.onconnectionstatechange=null,n.prototype.onicegatheringstatechange=null,n.prototype.onnegotiationneeded=null,n.prototype.ondatachannel=null,n.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},n.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},n.prototype.getConfiguration=function(){return this._config},n.prototype.getLocalStreams=function(){return this.localStreams},n.prototype.getRemoteStreams=function(){return this.remoteStreams},n.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0,i={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)i.iceTransport=this.transceivers[0].iceTransport,i.dtlsTransport=this.transceivers[0].dtlsTransport;else{var n=this._createIceAndDtlsTransports();i.iceTransport=n.iceTransport,i.dtlsTransport=n.dtlsTransport}return t||this.transceivers.push(i),i},n.prototype.addTrack=function(t,r){if(this._isClosed)throw makeError("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var i;if(this.transceivers.find(function(e){return e.track===t}))throw makeError("InvalidAccessError","Track already exists.");for(var n=0;n<this.transceivers.length;n++)this.transceivers[n].track||this.transceivers[n].kind!==t.kind||(i=this.transceivers[n]);return i||(i=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),i.track=t,i.stream=r,i.rtpSender=new e.RTCRtpSender(t,i.dtlsTransport),i.rtpSender},n.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach(function(t){r.addTrack(t,e)});else{var i=e.clone();e.getTracks().forEach(function(e,t){var r=i.getTracks()[t];e.addEventListener("enabled",function(e){r.enabled=e.enabled})}),i.getTracks().forEach(function(e){r.addTrack(e,i)})}},n.prototype.removeTrack=function(t){if(this._isClosed)throw makeError("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var r=this.transceivers.find(function(e){return e.rtpSender===t});if(!r)throw makeError("InvalidAccessError","Sender was not created by this connection.");var i=r.stream;r.rtpSender.stop(),r.rtpSender=null,r.track=null,r.stream=null,-1===this.transceivers.map(function(e){return e.stream}).indexOf(i)&&this.localStreams.indexOf(i)>-1&&this.localStreams.splice(this.localStreams.indexOf(i),1),this._maybeFireNegotiationNeeded()},n.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var r=t.getSenders().find(function(t){return t.track===e});r&&t.removeTrack(r)})},n.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},n.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},n.prototype._createIceGatherer=function(t,r){var i=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var n=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(n,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;n.state=r?"completed":"gathering",null!==i.transceivers[t].bufferedCandidateEvents&&i.transceivers[t].bufferedCandidateEvents.push(e)},n.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),n},n.prototype._gather=function(t,r){var i=this,n=this.transceivers[r].iceGatherer;if(!n.onlocalcandidate){var s=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,n.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),n.onlocalcandidate=function(e){if(!(i.usingBundle&&r>0)){var s=new Event("icecandidate");s.candidate={sdpMid:t,sdpMLineIndex:r};var o=e.candidate,a=!o||0===Object.keys(o).length;if(a)"new"!==n.state&&"gathering"!==n.state||(n.state="completed");else{"new"===n.state&&(n.state="gathering"),o.component=1,o.ufrag=n.getLocalParameters().usernameFragment;var c=sdp.writeCandidate(o);s.candidate=Object.assign(s.candidate,sdp.parseCandidate(c)),s.candidate.candidate=c,s.candidate.toJSON=function(){return{candidate:s.candidate.candidate,sdpMid:s.candidate.sdpMid,sdpMLineIndex:s.candidate.sdpMLineIndex,usernameFragment:s.candidate.usernameFragment}}}var u=sdp.getMediaSections(i._localDescription.sdp);u[s.candidate.sdpMLineIndex]+=a?"a=end-of-candidates\r\n":"a="+s.candidate.candidate+"\r\n",i._localDescription.sdp=sdp.getDescription(i._localDescription.sdp)+u.join("");var d=i.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});"gathering"!==i.iceGatheringState&&(i.iceGatheringState="gathering",i._emitGatheringStateChange()),a||i._dispatchEvent("icecandidate",s),d&&(i._dispatchEvent("icecandidate",new Event("icecandidate")),i.iceGatheringState="complete",i._emitGatheringStateChange())}},e.setTimeout(function(){s.forEach(function(e){n.onlocalcandidate(e)})},0)}},n.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var i=new e.RTCDtlsTransport(r);return i.ondtlsstatechange=function(){t._updateConnectionState()},i.onerror=function(){Object.defineProperty(i,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:r,dtlsTransport:i}},n.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var i=this.transceivers[e].dtlsTransport;i&&(delete i.ondtlsstatechange,delete i.onerror,delete this.transceivers[e].dtlsTransport)},n.prototype._transceive=function(e,r,i){var n=getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(n.encodings=e.sendEncodingParameters,n.rtcp={cname:sdp.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(n.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(n)),i&&e.rtpReceiver&&n.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),e.recvEncodingParameters.length?n.encodings=e.recvEncodingParameters:n.encodings=[{}],n.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(n.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(n.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(n))},n.prototype.setLocalDescription=function(e){var t,r,i=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(makeError("TypeError",'Unsupported type "'+e.type+'"'));if(!isActionAllowedInSignalingState("setLocalDescription",e.type,i.signalingState)||i._isClosed)return Promise.reject(makeError("InvalidStateError","Can not set local "+e.type+" in state "+i.signalingState));if("offer"===e.type)t=sdp.splitSections(e.sdp),r=t.shift(),t.forEach(function(e,t){var r=sdp.parseRtpParameters(e);i.transceivers[t].localCapabilities=r}),i.transceivers.forEach(function(e,t){i._gather(e.mid,t)});else if("answer"===e.type){t=sdp.splitSections(i._remoteDescription.sdp),r=t.shift();var n=sdp.matchPrefix(r,"a=ice-lite").length>0;t.forEach(function(e,t){var s=i.transceivers[t],o=s.iceGatherer,a=s.iceTransport,c=s.dtlsTransport,u=s.localCapabilities,d=s.remoteCapabilities;if(!(sdp.isRejected(e)&&0===sdp.matchPrefix(e,"a=bundle-only").length)&&!s.rejected){var h=sdp.getIceParameters(e,r),l=sdp.getDtlsParameters(e,r);n&&(l.role="server"),i.usingBundle&&0!==t||(i._gather(s.mid,t),"new"===a.state&&a.start(o,h,n?"controlling":"controlled"),"new"===c.state&&c.start(l));var p=getCommonCapabilities(u,d);i._transceive(s,p.codecs.length>0,!1)}})}return i._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?i._updateSignalingState("have-local-offer"):i._updateSignalingState("stable"),Promise.resolve()},n.prototype.setRemoteDescription=function(n){var s=this;if(-1===["offer","answer"].indexOf(n.type))return Promise.reject(makeError("TypeError",'Unsupported type "'+n.type+'"'));if(!isActionAllowedInSignalingState("setRemoteDescription",n.type,s.signalingState)||s._isClosed)return Promise.reject(makeError("InvalidStateError","Can not set remote "+n.type+" in state "+s.signalingState));var o={};s.remoteStreams.forEach(function(e){o[e.id]=e});var a=[],c=sdp.splitSections(n.sdp),u=c.shift(),d=sdp.matchPrefix(u,"a=ice-lite").length>0,h=sdp.matchPrefix(u,"a=group:BUNDLE ").length>0;s.usingBundle=h;var l=sdp.matchPrefix(u,"a=ice-options:")[0];return s.canTrickleIceCandidates=!!l&&l.substr(14).split(" ").indexOf("trickle")>=0,c.forEach(function(i,c){var l=sdp.splitLines(i),p=sdp.getKind(i),f=sdp.isRejected(i)&&0===sdp.matchPrefix(i,"a=bundle-only").length,m=l[0].substr(2).split(" ")[2],g=sdp.getDirection(i,u),T=sdp.parseMsid(i),v=sdp.getMid(i)||sdp.generateIdentifier();if(f||"application"===p&&("DTLS/SCTP"===m||"UDP/DTLS/SCTP"===m))s.transceivers[c]={mid:v,kind:p,protocol:m,rejected:!0};else{var C,S,_,y,E,b,R,w,A;!f&&s.transceivers[c]&&s.transceivers[c].rejected&&(s.transceivers[c]=s._createTransceiver(p,!0));var I,D,O=sdp.parseRtpParameters(i);f||(I=sdp.getIceParameters(i,u),(D=sdp.getDtlsParameters(i,u)).role="client"),R=sdp.parseRtpEncodingParameters(i);var N=sdp.parseRtcpParameters(i),P=sdp.matchPrefix(i,"a=end-of-candidates",u).length>0,x=sdp.matchPrefix(i,"a=candidate:").map(function(e){return sdp.parseCandidate(e)}).filter(function(e){return 1===e.component});if(("offer"===n.type||"answer"===n.type)&&!f&&h&&c>0&&s.transceivers[c]&&(s._disposeIceAndDtlsTransports(c),s.transceivers[c].iceGatherer=s.transceivers[0].iceGatherer,s.transceivers[c].iceTransport=s.transceivers[0].iceTransport,s.transceivers[c].dtlsTransport=s.transceivers[0].dtlsTransport,s.transceivers[c].rtpSender&&s.transceivers[c].rtpSender.setTransport(s.transceivers[0].dtlsTransport),s.transceivers[c].rtpReceiver&&s.transceivers[c].rtpReceiver.setTransport(s.transceivers[0].dtlsTransport)),"offer"!==n.type||f){if("answer"===n.type&&!f){S=(C=s.transceivers[c]).iceGatherer,_=C.iceTransport,y=C.dtlsTransport,E=C.rtpReceiver,b=C.sendEncodingParameters,w=C.localCapabilities,s.transceivers[c].recvEncodingParameters=R,s.transceivers[c].remoteCapabilities=O,s.transceivers[c].rtcpParameters=N,x.length&&"new"===_.state&&(!d&&!P||h&&0!==c?x.forEach(function(e){maybeAddCandidate(C.iceTransport,e)}):_.setRemoteCandidates(x)),h&&0!==c||("new"===_.state&&_.start(S,I,"controlling"),"new"===y.state&&y.start(D)),!getCommonCapabilities(C.localCapabilities,C.remoteCapabilities).codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&C.sendEncodingParameters[0].rtx&&delete C.sendEncodingParameters[0].rtx,s._transceive(C,"sendrecv"===g||"recvonly"===g,"sendrecv"===g||"sendonly"===g),!E||"sendrecv"!==g&&"sendonly"!==g?delete C.rtpReceiver:(A=E.track,T?(o[T.stream]||(o[T.stream]=new e.MediaStream),r(A,o[T.stream]),a.push([A,E,o[T.stream]])):(o.default||(o.default=new e.MediaStream),r(A,o.default),a.push([A,E,o.default])))}}else{(C=s.transceivers[c]||s._createTransceiver(p)).mid=v,C.iceGatherer||(C.iceGatherer=s._createIceGatherer(c,h)),x.length&&"new"===C.iceTransport.state&&(!P||h&&0!==c?x.forEach(function(e){maybeAddCandidate(C.iceTransport,e)}):C.iceTransport.setRemoteCandidates(x)),w=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(w.codecs=w.codecs.filter(function(e){return"rtx"!==e.name})),b=C.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var $,k=!1;if("sendrecv"===g||"sendonly"===g){if(k=!C.rtpReceiver,E=C.rtpReceiver||new e.RTCRtpReceiver(C.dtlsTransport,p),k)A=E.track,T&&"-"===T.stream||(T?(o[T.stream]||(o[T.stream]=new e.MediaStream,Object.defineProperty(o[T.stream],"id",{get:function(){return T.stream}})),Object.defineProperty(A,"id",{get:function(){return T.track}}),$=o[T.stream]):(o.default||(o.default=new e.MediaStream),$=o.default)),$&&(r(A,$),C.associatedRemoteMediaStreams.push($)),a.push([A,E,$])}else C.rtpReceiver&&C.rtpReceiver.track&&(C.associatedRemoteMediaStreams.forEach(function(t){var r,i,n=t.getTracks().find(function(e){return e.id===C.rtpReceiver.track.id});n&&(r=n,(i=t).removeTrack(r),i.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:r})))}),C.associatedRemoteMediaStreams=[]);C.localCapabilities=w,C.remoteCapabilities=O,C.rtpReceiver=E,C.rtcpParameters=N,C.sendEncodingParameters=b,C.recvEncodingParameters=R,s._transceive(s.transceivers[c],!1,k)}}}),void 0===s._dtlsRole&&(s._dtlsRole="offer"===n.type?"active":"passive"),s._remoteDescription={type:n.type,sdp:n.sdp},"offer"===n.type?s._updateSignalingState("have-remote-offer"):s._updateSignalingState("stable"),Object.keys(o).forEach(function(t){var r=o[t];if(r.getTracks().length){if(-1===s.remoteStreams.indexOf(r)){s.remoteStreams.push(r);var n=new Event("addstream");n.stream=r,e.setTimeout(function(){s._dispatchEvent("addstream",n)})}a.forEach(function(e){var t=e[0],n=e[1];r.id===e[2].id&&i(s,t,n,[r])})}}),a.forEach(function(e){e[2]||i(s,e[0],e[1],[])}),e.setTimeout(function(){s&&s.transceivers&&s.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},n.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},n.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},n.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}},0))},n.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){t[e.iceTransport.state]++}),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}},n.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){t[e.iceTransport.state]++,t[e.dtlsTransport.state]++}),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}},n.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(makeError("InvalidStateError","Can not call createOffer after close"));var i=r.transceivers.filter(function(e){return"audio"===e.kind}).length,n=r.transceivers.filter(function(e){return"video"===e.kind}).length,s=arguments[0];if(s){if(s.mandatory||s.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==s.offerToReceiveAudio&&(i=!0===s.offerToReceiveAudio?1:!1===s.offerToReceiveAudio?0:s.offerToReceiveAudio),void 0!==s.offerToReceiveVideo&&(n=!0===s.offerToReceiveVideo?1:!1===s.offerToReceiveVideo?0:s.offerToReceiveVideo)}for(r.transceivers.forEach(function(e){"audio"===e.kind?--i<0&&(e.wantReceive=!1):"video"===e.kind&&--n<0&&(e.wantReceive=!1)});i>0||n>0;)i>0&&(r._createTransceiver("audio"),i--),n>0&&(r._createTransceiver("video"),n--);var o=sdp.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach(function(i,n){var s=i.track,o=i.kind,a=i.mid||sdp.generateIdentifier();i.mid=a,i.iceGatherer||(i.iceGatherer=r._createIceGatherer(n,r.usingBundle));var c=e.RTCRtpSender.getCapabilities(o);t<15019&&(c.codecs=c.codecs.filter(function(e){return"rtx"!==e.name})),c.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),i.remoteCapabilities&&i.remoteCapabilities.codecs&&i.remoteCapabilities.codecs.forEach(function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)})}),c.headerExtensions.forEach(function(e){(i.remoteCapabilities&&i.remoteCapabilities.headerExtensions||[]).forEach(function(t){e.uri===t.uri&&(e.id=t.id)})});var u=i.sendEncodingParameters||[{ssrc:1001*(2*n+1)}];s&&t>=15019&&"video"===o&&!u[0].rtx&&(u[0].rtx={ssrc:u[0].ssrc+1}),i.wantReceive&&(i.rtpReceiver=new e.RTCRtpReceiver(i.dtlsTransport,o)),i.localCapabilities=c,i.sendEncodingParameters=u}),"max-compat"!==r._config.bundlePolicy&&(o+="a=group:BUNDLE "+r.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),o+="a=ice-options:trickle\r\n",r.transceivers.forEach(function(e,t){o+=writeMediaSection(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),o+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===r.iceGatheringState||0!==t&&r.usingBundle||(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,o+="a="+sdp.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(o+="a=end-of-candidates\r\n"))});var a=new e.RTCSessionDescription({type:"offer",sdp:o});return Promise.resolve(a)},n.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(makeError("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(makeError("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var i=sdp.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(i+="a=group:BUNDLE "+r.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),i+="a=ice-options:trickle\r\n";var n=sdp.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach(function(e,s){if(!(s+1>n)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?i+="m=application 0 DTLS/SCTP 5000\r\n":i+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?i+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(i+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(i+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var o;if(e.stream)"audio"===e.kind?o=e.stream.getAudioTracks()[0]:"video"===e.kind&&(o=e.stream.getVideoTracks()[0]),o&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var a=getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);!a.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,i+=writeMediaSection(e,a,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(i+="a=rtcp-rsize\r\n")}});var s=new e.RTCSessionDescription({type:"answer",sdp:i});return Promise.resolve(s)},n.prototype.addIceCandidate=function(e){var t,r=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(i,n){if(!r._remoteDescription)return n(makeError("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var s=e.sdpMLineIndex;if(e.sdpMid)for(var o=0;o<r.transceivers.length;o++)if(r.transceivers[o].mid===e.sdpMid){s=o;break}var a=r.transceivers[s];if(!a)return n(makeError("OperationError","Can not add ICE candidate"));if(a.rejected)return i();var c=Object.keys(e.candidate).length>0?sdp.parseCandidate(e.candidate):{};if("tcp"===c.protocol&&(0===c.port||9===c.port))return i();if(c.component&&1!==c.component)return i();if((0===s||s>0&&a.iceTransport!==r.transceivers[0].iceTransport)&&!maybeAddCandidate(a.iceTransport,c))return n(makeError("OperationError","Can not add ICE candidate"));var u=e.candidate.trim();0===u.indexOf("a=")&&(u=u.substr(2)),(t=sdp.getMediaSections(r._remoteDescription.sdp))[s]+="a="+(c.type?u:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=sdp.getDescription(r._remoteDescription.sdp)+t.join("")}else for(var d=0;d<r.transceivers.length&&(r.transceivers[d].rejected||(r.transceivers[d].iceTransport.addRemoteCandidate({}),(t=sdp.getMediaSections(r._remoteDescription.sdp))[d]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=sdp.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));d++);i()})},n.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach(function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver)}),!r)throw makeError("InvalidAccessError","Invalid selector.");return r.getStats()}var i=[];return this.transceivers.forEach(function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(t){e[t]&&i.push(e[t].getStats())})}),Promise.all(i).then(function(e){var t=new Map;return e.forEach(function(e){e.forEach(function(e){t.set(e.id,e)})}),t})};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var i=r.prototype.getStats;r.prototype.getStats=function(){return i.apply(this).then(function(e){var t=new Map;return Object.keys(e).forEach(function(r){e[r].type=fixStatsType(e[r]),t.set(r,e[r])}),t})}}});var s=["createOffer","createAnswer"];return s.forEach(function(e){var t=n.prototype[e];n.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then(function(t){"function"==typeof e[0]&&e[0].apply(null,[t])},function(t){"function"==typeof e[1]&&e[1].apply(null,[t])}):t.apply(this,arguments)}}),(s=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach(function(e){var t=n.prototype[e];n.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)},function(t){"function"==typeof e[2]&&e[2].apply(null,[t])}):t.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=n.prototype[e];n.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),n},getusermedia$1=function(e){var t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch(function(e){return Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))})}},edge_shim={shimGetUserMedia:getusermedia$1,shimPeerConnection:function(e){var t=utils.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){r.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var i=rtcpeerconnection(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=filtericeservers(e.iceServers)),new i(e)},e.RTCPeerConnection.prototype=i.prototype},shimReplaceTrack:function(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}},logging$2=utils.log,getusermedia$2=function(e){var t=utils.detectBrowser(e),r=e&&e.navigator,i=e&&e.MediaStreamTrack,n=function(e){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},s=function(e,i,s){var o=function(e){if("object"!=typeof e||e.require)return e;var t=[];return Object.keys(e).forEach(function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var i=e[r]="object"==typeof e[r]?e[r]:{ideal:e[r]};if(void 0===i.min&&void 0===i.max&&void 0===i.exact||t.push(r),void 0!==i.exact&&("number"==typeof i.exact?i.min=i.max=i.exact:e[r]=i.exact,delete i.exact),void 0!==i.ideal){e.advanced=e.advanced||[];var n={};"number"==typeof i.ideal?n[r]={min:i.ideal,max:i.ideal}:n[r]=i.ideal,e.advanced.push(n),delete i.ideal,Object.keys(i).length||delete e[r]}}}),t.length&&(e.require=t),e};return e=JSON.parse(JSON.stringify(e)),t.version<38&&(logging$2("spec: "+JSON.stringify(e)),e.audio&&(e.audio=o(e.audio)),e.video&&(e.video=o(e.video)),logging$2("ff37: "+JSON.stringify(e))),r.mozGetUserMedia(e,i,function(e){s(n(e))})};if(r.mediaDevices||(r.mediaDevices={getUserMedia:function(e){return new Promise(function(t,r){s(e,t,r)})},addEventListener:function(){},removeEventListener:function(){}}),r.mediaDevices.enumerateDevices=r.mediaDevices.enumerateDevices||function(){return new Promise(function(e){e([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},t.version<41){var o=r.mediaDevices.enumerateDevices.bind(r.mediaDevices);r.mediaDevices.enumerateDevices=function(){return o().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(t.version<49){var a=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(e){return a(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return t},function(e){return Promise.reject(n(e))})}}if(!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var c=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},u=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(e){return"object"==typeof e&&"object"==typeof e.audio&&(e=JSON.parse(JSON.stringify(e)),c(e.audio,"autoGainControl","mozAutoGainControl"),c(e.audio,"noiseSuppression","mozNoiseSuppression")),u(e)},i&&i.prototype.getSettings){var d=i.prototype.getSettings;i.prototype.getSettings=function(){var e=d.apply(this,arguments);return c(e,"mozAutoGainControl","autoGainControl"),c(e,"mozNoiseSuppression","noiseSuppression"),e}}if(i&&i.prototype.applyConstraints){var h=i.prototype.applyConstraints;i.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"==typeof e&&(e=JSON.parse(JSON.stringify(e)),c(e,"autoGainControl","mozAutoGainControl"),c(e,"noiseSuppression","mozNoiseSuppression")),h.apply(this,[e])}}}r.getUserMedia=function(e,i,n){if(t.version<44)return s(e,i,n);utils.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(i,n)}},firefox_shim={shimGetUserMedia:getusermedia$2,shimOnTrack:function(e){"object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var r=new Event("track");r.track=t,r.receiver={track:t},r.transceiver={receiver:r.receiver},r.streams=[e.stream],this.dispatchEvent(r)}.bind(this))}.bind(this))},enumerable:!0,configurable:!0}),"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimSourceObject:function(e){"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(e){var t=utils.detectBrowser(e);if("object"==typeof e&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){e.RTCPeerConnection||(e.RTCPeerConnection=function(r,i){if(t.version<38&&r&&r.iceServers){for(var n=[],s=0;s<r.iceServers.length;s++){var o=r.iceServers[s];if(o.hasOwnProperty("urls"))for(var a=0;a<o.urls.length;a++){var c={url:o.urls[a]};0===o.urls[a].indexOf("turn")&&(c.username=o.username,c.credential=o.credential),n.push(c)}else n.push(r.iceServers[s])}r.iceServers=n}return new e.mozRTCPeerConnection(r,i)},e.RTCPeerConnection.prototype=e.mozRTCPeerConnection.prototype,e.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.mozRTCPeerConnection.generateCertificate}}),e.RTCSessionDescription=e.mozRTCSessionDescription,e.RTCIceCandidate=e.mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}});var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,r,s){return n.apply(this,[e||null]).then(function(e){if(t.version<48&&(e=function(e){var t=new Map;return Object.keys(e).forEach(function(r){t.set(r,e[r]),t[r]=e[r]}),t}(e)),t.version<53&&!r)try{e.forEach(function(e){e.type=i[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach(function(t,r){e.set(r,Object.assign({},t,{type:i[t.type]||t.type}))})}return e}).then(r,s)}}},shimSenderGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(e,[]);return r.forEach(function(t){t._pc=e}),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},shimReceiverGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,r=t.apply(e,[]);return r.forEach(function(t){t._pc=e}),r}),utils.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver._pc=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},shimRemoveStream:function(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;utils.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(r){r.track&&-1!==e.getTracks().indexOf(r.track)&&t.removeTrack(r)})})},shimRTCDataChannel:function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)},shimGetDisplayMedia:function(e,t){"getDisplayMedia"in e.navigator||(navigator.getDisplayMedia=function(e){if(!e||!e.video){var r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return!0===e.video?e.video={mediaSource:t}:e.video.mediaSource=t,navigator.mediaDevices.getUserMedia(e)})}},safari_shim={shimLocalStreamsAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"getStreamById"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getStreamById=function(e){var t=null;return this._localStreams&&this._localStreams.forEach(function(r){r.id===e&&(t=r)}),this._remoteStreams&&this._remoteStreams.forEach(function(r){r.id===e&&(t=r)}),t}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),-1===this._localStreams.indexOf(e)&&this._localStreams.push(e);var r=this;e.getTracks().forEach(function(i){t.call(r,i,e)})},e.RTCPeerConnection.prototype.addTrack=function(e,r){return r&&(this._localStreams?-1===this._localStreams.indexOf(r)&&this._localStreams.push(r):this._localStreams=[r]),t.call(this,e,r)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);var t=this._localStreams.indexOf(e);if(-1!==t){this._localStreams.splice(t,1);var r=this,i=e.getTracks();this.getSenders().forEach(function(e){-1!==i.indexOf(e.track)&&r.removeTrack(e)})}})}},shimRemoteStreamsAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){this._onaddstream&&this.removeEventListener("addstream",this._onaddstream),this.addEventListener("addstream",this._onaddstream=e)}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(e._remoteStreams.indexOf(t)>=0)){e._remoteStreams.push(t);var r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}})}),t.apply(e,arguments)}}},shimCallbacksAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,r=t.createOffer,i=t.createAnswer,n=t.setLocalDescription,s=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){var i=arguments.length>=2?arguments[2]:arguments[0],n=r.apply(this,[i]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){var r=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[r]);return t?(n.then(e,t),Promise.resolve()):n};var a=function(e,t,r){var i=n.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i};t.setLocalDescription=a,a=function(e,t,r){var i=s.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.setRemoteDescription=a,a=function(e,t,r){var i=o.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.addIceCandidate=a}},shimGetUserMedia:function(e){var t=e&&e.navigator;t.getUserMedia||(t.webkitGetUserMedia?t.getUserMedia=t.webkitGetUserMedia.bind(t):t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,i){t.mediaDevices.getUserMedia(e).then(r,i)}.bind(t)))},shimRTCIceServerUrls:function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){for(var i=[],n=0;n<e.iceServers.length;n++){var s=e.iceServers[n];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(utils.deprecated("RTCIceServer.url","RTCIceServer.urls"),(s=JSON.parse(JSON.stringify(s))).urls=s.url,delete s.url,i.push(s)):i.push(e.iceServers[n])}e.iceServers=i}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},shimTrackEventTransceiver:function(e){"object"==typeof e&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimCreateOfferLegacy:function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){var r=this;if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var i=r.getTransceivers().find(function(e){return e.sender.track&&"audio"===e.sender.track.kind});!1===e.offerToReceiveAudio&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveAudio||i||r.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var n=r.getTransceivers().find(function(e){return e.sender.track&&"video"===e.sender.track.kind});!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection("sendonly"):"recvonly"===n.direction&&n.setDirection("inactive"):!0!==e.offerToReceiveVideo||n||r.addTransceiver("video")}return t.apply(r,arguments)}}},common_shim={shimRTCIceCandidate:function(e){if(e.RTCIceCandidate&&!(e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var r=new t(e),i=sdp.parseCandidate(e.candidate),n=Object.assign(r,i);return n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}},n}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,utils.wrapPeerConnectionEvent(e,"icecandidate",function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t})}},shimCreateObjectURL:function(e){var t=e&&e.URL;if("object"==typeof e&&e.HTMLMediaElement&&"srcObject"in e.HTMLMediaElement.prototype&&t.createObjectURL&&t.revokeObjectURL){var r=t.createObjectURL.bind(t),i=t.revokeObjectURL.bind(t),n=new Map,s=0;t.createObjectURL=function(e){if("getTracks"in e){var t="polyblob:"+ ++s;return n.set(t,e),utils.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream"),t}return r(e)},t.revokeObjectURL=function(e){i(e),n.delete(e)};var o=Object.getOwnPropertyDescriptor(e.HTMLMediaElement.prototype,"src");Object.defineProperty(e.HTMLMediaElement.prototype,"src",{get:function(){return o.get.apply(this)},set:function(e){return this.srcObject=n.get(e)||null,o.set.apply(this,[e])}});var a=e.HTMLMediaElement.prototype.setAttribute;e.HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=n.get(arguments[1])||null),a.apply(this,arguments)}}},shimMaxMessageSize:function(e){if(!e.RTCSctpTransport&&e.RTCPeerConnection){var t=utils.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e,i,n,s;if(this._sctp=null,n=arguments[0],(s=sdp.splitSections(n.sdp)).shift(),s.some(function(e){var t=sdp.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})){var o,a=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var r=parseInt(t[1],10);return r!=r?-1:r}(arguments[0]),c=(e=a,i=65536,"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i),u=function(e,r){var i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);var n=sdp.matchPrefix(e.sdp,"a=max-message-size:");return n.length>0?i=parseInt(n[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(i=2147483637),i}(arguments[0],a);o=0===c&&0===u?Number.POSITIVE_INFINITY:0===c||0===u?Math.max(c,u):Math.min(c,u);var d={};Object.defineProperty(d,"maxMessageSize",{get:function(){return o}}),this._sctp=d}return r.apply(this,arguments)}}},shimSendThrowTypeError:function(e){if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var t=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=t.apply(this,arguments);return r(e,this),e},utils.wrapPeerConnectionEvent(e,"datachannel",function(e){return r(e.channel,e.target),e})}function r(e,t){var r=e.send;e.send=function(){var i=arguments[0],n=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}}},adapter_factory=function(e,t){var r=e&&e.window,i={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0};for(var n in t)hasOwnProperty.call(t,n)&&(i[n]=t[n]);var s=utils.log,o=utils.detectBrowser(r),a=chrome_shim||null,c=edge_shim||null,u=firefox_shim||null,d=safari_shim||null,h=common_shim||null,l={browserDetails:o,commonShim:h,extractVersion:utils.extractVersion,disableLog:utils.disableLog,disableWarnings:utils.disableWarnings};switch(o.browser){case"chrome":if(!a||!a.shimPeerConnection||!i.shimChrome)return s("Chrome shim is not included in this adapter release."),l;s("adapter.js shimming chrome."),l.browserShim=a,h.shimCreateObjectURL(r),a.shimGetUserMedia(r),a.shimMediaStream(r),a.shimSourceObject(r),a.shimPeerConnection(r),a.shimOnTrack(r),a.shimAddTrackRemoveTrack(r),a.shimGetSendersWithDtmf(r),a.shimSenderReceiverGetStats(r),a.fixNegotiationNeeded(r),h.shimRTCIceCandidate(r),h.shimMaxMessageSize(r),h.shimSendThrowTypeError(r);break;case"firefox":if(!u||!u.shimPeerConnection||!i.shimFirefox)return s("Firefox shim is not included in this adapter release."),l;s("adapter.js shimming firefox."),l.browserShim=u,h.shimCreateObjectURL(r),u.shimGetUserMedia(r),u.shimSourceObject(r),u.shimPeerConnection(r),u.shimOnTrack(r),u.shimRemoveStream(r),u.shimSenderGetStats(r),u.shimReceiverGetStats(r),u.shimRTCDataChannel(r),h.shimRTCIceCandidate(r),h.shimMaxMessageSize(r),h.shimSendThrowTypeError(r);break;case"edge":if(!c||!c.shimPeerConnection||!i.shimEdge)return s("MS edge shim is not included in this adapter release."),l;s("adapter.js shimming edge."),l.browserShim=c,h.shimCreateObjectURL(r),c.shimGetUserMedia(r),c.shimPeerConnection(r),c.shimReplaceTrack(r),h.shimMaxMessageSize(r),h.shimSendThrowTypeError(r);break;case"safari":if(!d||!i.shimSafari)return s("Safari shim is not included in this adapter release."),l;s("adapter.js shimming safari."),l.browserShim=d,h.shimCreateObjectURL(r),d.shimRTCIceServerUrls(r),d.shimCreateOfferLegacy(r),d.shimCallbacksAPI(r),d.shimLocalStreamsAPI(r),d.shimRemoteStreamsAPI(r),d.shimTrackEventTransceiver(r),d.shimGetUserMedia(r),h.shimRTCIceCandidate(r),h.shimMaxMessageSize(r),h.shimSendThrowTypeError(r);break;default:s("Unsupported browser!")}return l},adapter_core=adapter_factory({window:commonjsGlobal.window}),sip=createCommonjsModule(function(e,t){var r;r=function(){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){e.exports=r(1)(r(40))},function(e,t,r){e.exports=function(e){var t=r(2),i=t.version,n=t.title,s=Object.defineProperties({},{version:{get:function(){return i}},name:{get:function(){return n}}});return r(3)(s,e),s.LoggerFactory=r(4)(e.console),s.EventEmitter=r(5)(),s.C=r(7)(s.name,s.version),s.Exceptions=r(8),s.Timers=r(9)(e.timers),s.Transport=r(10)(s),r(11)(s),r(12)(s),r(13)(s),r(14)(s),r(15)(s),r(16)(s),r(18)(s),r(19)(s),s.SessionDescriptionHandler=r(20)(s.EventEmitter),r(21)(s),r(22)(s),r(23)(s),r(25)(s),r(26)(s),r(27)(s,e),r(32)(s),s.DigestAuthentication=r(33)(s.Utils),s.Grammar=r(36)(s),s.Web={Modifiers:r(38)(s),Simple:r(39)(s)},s}},function(e){e.exports={name:"sip.js",title:"SIP.js",description:"A simple, intuitive, and powerful JavaScript signaling library",version:"0.11.4",main:"dist/sip.js",browser:{"./src/environment.js":"./src/environment_browser.js"},homepage:"https://sipjs.com",author:"OnSIP <developer@onsip.com> (https://sipjs.com/aboutus/)",contributors:[{url:"https://github.com/onsip/SIP.js/blob/master/THANKS.md"}],repository:{type:"git",url:"https://github.com/onsip/SIP.js.git"},keywords:["sip","websocket","webrtc","library","javascript"],devDependencies:{"babel-core":"^6.26.0","babel-loader":"^7.1.2","babel-preset-env":"^1.6.1",eslint:"^5.4.0","jasmine-core":"^3.2.1",karma:"^3.0.0","karma-chrome-launcher":"^2.2.0","karma-cli":"^1.0.1","karma-jasmine":"^1.1.0","karma-jasmine-html-reporter":"^1.3.1","karma-mocha-reporter":"^2.2.5","karma-webpack":"^3.0.0",pegjs:"^0.10.0","pegjs-loader":"^0.5.4",webpack:"^4.19.0","webpack-cli":"^3.0.8"},engines:{node:">=6.0"},license:"MIT",scripts:{prebuild:"eslint src/*.js src/**/*.js","build-dev":"webpack --progress --env.buildType dev","build-prod":"webpack --progress --env.buildType prod","copy-dist-files":"cp dist/sip.js dist/sip-$npm_package_version.js && cp dist/sip.min.js  dist/sip-$npm_package_version.min.js",build:"npm run build-dev && npm run build-prod && npm run copy-dist-files",browserTest:"sleep 2 && open http://0.0.0.0:9876/debug.html & karma start --reporters kjhtml --no-single-run",commandLineTest:"karma start --reporters mocha --browsers ChromeHeadless --single-run",buildAndTest:"npm run build && npm run commandLineTest",buildAndBrowserTest:"npm run build && npm run browserTest"},dependencies:{"crypto-js":"^3.1.9-1"},optionalDependencies:{promiscuous:"^0.6.0"}}},function(e,t,r){e.exports=function(e,t){var r;r={Promise:t.Promise,defer:function(){var e={};return e.promise=new r.Promise(function(t,r){e.resolve=t,e.reject=r}),e},reducePromises:function(t,r){return t.reduce(function(e,t){return e=e.then(t)},e.Utils.Promise.resolve(r))},augment:function(e,t,r,i){var n,s;for(n in s=t.prototype)(i||void 0===e[n])&&(e[n]=s[n]);t.apply(e,r)},defaultOptions:function(e,t){return e=e||{},t=t||{},Object.assign({},e,t)},optionsOverride:function(e,t,r,i,n,s){i&&e[r]&&n.warn(r+" is deprecated, please use "+t+" instead"),e[t]&&e[r]&&n.warn(t+" overriding "+r),e[t]=e[t]||e[r]||s},str_utf8_length:function(e){return encodeURIComponent(e).replace(/%[A-F\d]{2}/g,"U").length},generateFakeSDP:function(e){if(e){var t=e.indexOf("o="),r=e.indexOf("\r\n",t);return"v=0\r\n"+e.slice(t,r)+"\r\ns=-\r\nt=0 0\r\nc=IN IP4 0.0.0.0"}},isFunction:function(e){return void 0!==e&&"[object Function]"===Object.prototype.toString.call(e)},isDecimal:function(e){return!isNaN(e)&&parseFloat(e)===parseInt(e,10)},createRandomToken:function(e,t){var r,i="";for(t=t||32,r=0;r<e;r++)i+=(Math.random()*t|0).toString(t);return i},newTag:function(){return e.Utils.createRandomToken(e.UA.C.TAG_LENGTH)},newUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},hostType:function(t){if(t)return-1!==(t=e.Grammar.parse(t,"host"))?t.host_type:void 0},normalizeTarget:function(t,r){var i,n,s;if(t){if(t instanceof e.URI)return t;if("string"==typeof t){switch((i=t.split("@")).length){case 1:if(!r)return;n=t,s=r;break;case 2:n=i[0],s=i[1];break;default:n=i.slice(0,i.length-1).join("@"),s=i[i.length-1]}return n=n.replace(/^(sips?|tel):/i,""),/^[\-\.\(\)]*\+?[0-9\-\.\(\)]+$/.test(n)&&(n=n.replace(/[\-\.\(\)]/g,"")),t=e.C.SIP+":"+e.Utils.escapeUser(n)+"@"+s,e.URI.parse(t)}}else;},escapeUser:function(e){return encodeURIComponent(decodeURIComponent(e)).replace(/%3A/gi,":").replace(/%2B/gi,"+").replace(/%3F/gi,"?").replace(/%2F/gi,"/")},headerize:function(e){var t,r={"Call-Id":"Call-ID",Cseq:"CSeq","Min-Se":"Min-SE",Rack:"RAck",Rseq:"RSeq","Www-Authenticate":"WWW-Authenticate"},i=e.toLowerCase().replace(/_/g,"-").split("-"),n="",s=i.length;for(t=0;t<s;t++)0!==t&&(n+="-"),n+=i[t].charAt(0).toUpperCase()+i[t].substring(1);return r[n]&&(n=r[n]),n},sipErrorCause:function(t){var r;for(r in e.C.SIP_ERROR_CAUSES)if(-1!==e.C.SIP_ERROR_CAUSES[r].indexOf(t))return e.C.causes[r];return e.C.causes.SIP_FAILURE_CODE},getReasonPhrase:function(t,r){return r||e.C.REASON_PHRASE[t]||""},getReasonHeaderValue:function(t,r){return"SIP;cause="+t+';text="'+(r=e.Utils.getReasonPhrase(t,r))+'"'},getCancelReason:function(t,r){if(t&&t<200||t>699)throw new TypeError("Invalid status_code: "+t);if(t)return e.Utils.getReasonHeaderValue(t,r)},buildStatusLine:function(e,t){if(t=t||null,!(e=e||null)||e<100||e>699)throw new TypeError("Invalid status_code: "+e);if(t&&"string"!=typeof t&&!(t instanceof String))throw new TypeError("Invalid reason_phrase: "+t);return"SIP/2.0 "+e+" "+(t=r.getReasonPhrase(e,t))+"\r\n"},getRandomTestNetIP:function(){return"192.0.2."+(e=1,t=254,Math.floor(Math.random()*(t-e+1)+e));var e,t}},e.Utils=r}},function(e,t,r){var i={error:0,warn:1,log:2,debug:3};e.exports=function(e){var t=function(){var e,t=2,r=!0,n=null;this.loggers={},e=this.getLogger("sip.loggerfactory"),Object.defineProperties(this,{builtinEnabled:{get:function(){return r},set:function(t){"boolean"==typeof t?r=t:e.error('invalid "builtinEnabled" parameter value: '+JSON.stringify(t))}},level:{get:function(){return t},set:function(r){r>=0&&r<=3?t=r:r>3?t=3:i.hasOwnProperty(r)?t=i[r]:e.error('invalid "level" parameter value: '+JSON.stringify(r))}},connector:{get:function(){return n},set:function(t){null===t||""===t||void 0===t?n=null:"function"==typeof t?n=t:e.error('invalid "connector" parameter value: '+JSON.stringify(t))}}})};function r(e,t,r){this.logger=e,this.category=t,this.label=r}return t.prototype.print=function(t,r,i,n){if("string"==typeof n){var s=[new Date,r];i&&s.push(i),n=s.concat(n).join(" | ")}t.call(e,n)},Object.keys(i).forEach(function(n){r.prototype[n]=function(e){this.logger[n](this.category,this.label,e)},t.prototype[n]=function(t,r,s){this.level>=i[n]&&(this.builtinEnabled&&this.print(e[n],t,r,s),this.connector&&this.connector(n,t,r,s))}}),t.prototype.getLogger=function(e,t){var i;return t&&3===this.level?new r(this,e,t):this.loggers[e]?this.loggers[e]:(i=new r(this,e),this.loggers[e]=i,i)},t}},function(e,t,r){var i=r(6).EventEmitter;e.exports=function(){function e(){i.call(this)}return e.prototype=Object.create(i.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),e}},function(e,t){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(e){return"function"==typeof e}function n(e){return"object"==typeof e&&null!==e}function s(e){return void 0===e}e.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,r,o,a,c,u;if(this._events||(this._events={}),"error"===e&&(!this._events.error||n(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var d=new Error('Uncaught, unspecified "error" event. ('+t+")");throw d.context=t,d}if(s(r=this._events[e]))return!1;if(i(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:a=Array.prototype.slice.call(arguments,1),r.apply(this,a)}else if(n(r))for(a=Array.prototype.slice.call(arguments,1),o=(u=r.slice()).length,c=0;c<o;c++)u[c].apply(this,a);return!0},r.prototype.addListener=function(e,t){var o;if(!i(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,i(t.listener)?t.listener:t),this._events[e]?n(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,n(this._events[e])&&!this._events[e].warned&&(o=s(this._maxListeners)?r.defaultMaxListeners:this._maxListeners)&&o>0&&this._events[e].length>o&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){if(!i(t))throw TypeError("listener must be a function");var r=!1;function n(){this.removeListener(e,n),r||(r=!0,t.apply(this,arguments))}return n.listener=t,this.on(e,n),this},r.prototype.removeListener=function(e,t){var r,s,o,a;if(!i(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(o=(r=this._events[e]).length,s=-1,r===t||i(r.listener)&&r.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(n(r)){for(a=o;a-- >0;)if(r[a]===t||r[a].listener&&r[a].listener===t){s=a;break}if(s<0)return this;1===r.length?(r.length=0,delete this._events[e]):r.splice(s,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,r;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(i(r=this._events[e]))this.removeListener(e,r);else if(r)for(;r.length;)this.removeListener(e,r[r.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){return this._events&&this._events[e]?i(this._events[e])?[this._events[e]]:this._events[e].slice():[]},r.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(i(t))return 1;if(t)return t.length}return 0},r.listenerCount=function(e,t){return e.listenerCount(t)}},function(e,t,r){e.exports=function(e,t){return{USER_AGENT:e+"/"+t,SIP:"sip",SIPS:"sips",causes:{CONNECTION_ERROR:"Connection Error",REQUEST_TIMEOUT:"Request Timeout",SIP_FAILURE_CODE:"SIP Failure Code",INTERNAL_ERROR:"Internal Error",BUSY:"Busy",REJECTED:"Rejected",REDIRECTED:"Redirected",UNAVAILABLE:"Unavailable",NOT_FOUND:"Not Found",ADDRESS_INCOMPLETE:"Address Incomplete",INCOMPATIBLE_SDP:"Incompatible SDP",AUTHENTICATION_ERROR:"Authentication Error",DIALOG_ERROR:"Dialog Error",WEBRTC_NOT_SUPPORTED:"WebRTC Not Supported",WEBRTC_ERROR:"WebRTC Error",CANCELED:"Canceled",NO_ANSWER:"No Answer",EXPIRES:"Expires",NO_ACK:"No ACK",NO_PRACK:"No PRACK",USER_DENIED_MEDIA_ACCESS:"User Denied Media Access",BAD_MEDIA_DESCRIPTION:"Bad Media Description",RTP_TIMEOUT:"RTP Timeout"},supported:{UNSUPPORTED:"none",SUPPORTED:"supported",REQUIRED:"required"},SIP_ERROR_CAUSES:{REDIRECTED:[300,301,302,305,380],BUSY:[486,600],REJECTED:[403,603],NOT_FOUND:[404,604],UNAVAILABLE:[480,410,408,430],ADDRESS_INCOMPLETE:[484],INCOMPATIBLE_SDP:[488,606],AUTHENTICATION_ERROR:[401,407]},ACK:"ACK",BYE:"BYE",CANCEL:"CANCEL",INFO:"INFO",INVITE:"INVITE",MESSAGE:"MESSAGE",NOTIFY:"NOTIFY",OPTIONS:"OPTIONS",REGISTER:"REGISTER",UPDATE:"UPDATE",SUBSCRIBE:"SUBSCRIBE",PUBLISH:"PUBLISH",REFER:"REFER",PRACK:"PRACK",REASON_PHRASE:{100:"Trying",180:"Ringing",181:"Call Is Being Forwarded",182:"Queued",183:"Session Progress",199:"Early Dialog Terminated",200:"OK",202:"Accepted",204:"No Notification",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",305:"Use Proxy",380:"Alternative Service",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",410:"Gone",412:"Conditional Request Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Unsupported URI Scheme",417:"Unknown Resource-Priority",420:"Bad Extension",421:"Extension Required",422:"Session Interval Too Small",423:"Interval Too Brief",428:"Use Identity Header",429:"Provide Referrer Identity",430:"Flow Failed",433:"Anonymity Disallowed",436:"Bad Identity-Info",437:"Unsupported Certificate",438:"Invalid Identity Header",439:"First Hop Lacks Outbound Support",440:"Max-Breadth Exceeded",469:"Bad Info Package",470:"Consent Needed",478:"Unresolvable Destination",480:"Temporarily Unavailable",481:"Call/Transaction Does Not Exist",482:"Loop Detected",483:"Too Many Hops",484:"Address Incomplete",485:"Ambiguous",486:"Busy Here",487:"Request Terminated",488:"Not Acceptable Here",489:"Bad Event",491:"Request Pending",493:"Undecipherable",494:"Security Agreement Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Server Time-out",505:"Version Not Supported",513:"Message Too Large",580:"Precondition Failure",600:"Busy Everywhere",603:"Decline",604:"Does Not Exist Anywhere",606:"Not Acceptable"},OPTION_TAGS:{"100rel":!0,199:!0,answermode:!0,"early-session":!0,eventlist:!0,explicitsub:!0,"from-change":!0,"geolocation-http":!0,"geolocation-sip":!0,gin:!0,gruu:!0,histinfo:!0,ice:!0,join:!0,"multiple-refer":!0,norefersub:!0,nosub:!0,outbound:!0,path:!0,policy:!0,precondition:!0,pref:!0,privacy:!0,"recipient-list-invite":!0,"recipient-list-message":!0,"recipient-list-subscribe":!0,replaces:!0,"resource-priority":!0,"sdp-anat":!0,"sec-agree":!0,tdialog:!0,timer:!0,uui:!0},dtmfType:{INFO:"info",RTP:"rtp"}}}},function(e,t,r){var i;e.exports={ConfigurationError:(i=function(e,t){this.code=1,this.name="CONFIGURATION_ERROR",this.parameter=e,this.value=t,this.message=this.value?"Invalid value "+JSON.stringify(this.value)+' for parameter "'+this.parameter+'"':"Missing parameter: "+this.parameter},i.prototype=new Error,i),InvalidStateError:function(){var e=function(e){this.code=2,this.name="INVALID_STATE_ERROR",this.status=e,this.message="Invalid status: "+e};return e.prototype=new Error,e}(),NotSupportedError:function(){var e=function(e){this.code=3,this.name="NOT_SUPPORTED_ERROR",this.message=e};return e.prototype=new Error,e}(),GetDescriptionError:function(){var e=function(e){this.code=4,this.name="GET_DESCRIPTION_ERROR",this.message=e};return e.prototype=new Error,e}(),RenegotiationError:function(){var e=function(e){this.code=5,this.name="RENEGOTIATION_ERROR",this.message=e};return e.prototype=new Error,e}(),MethodParameterError:function(){var e=function(e,t,r){this.code=6,this.name="METHOD_PARAMETER_ERROR",this.method=e,this.parameter=t,this.value=r,this.message=this.value?"Invalid value "+JSON.stringify(this.value)+' for parameter "'+this.parameter+'"':"Missing parameter: "+this.parameter};return e.prototype=new Error,e}(),TransportError:function(){var e=function(e){this.code=7,this.name="TRANSPORT_ERROR",this.message=e};return e.prototype=new Error,e}(),SessionDescriptionHandlerError:function(){var e=function(e,t,r){this.code=8,this.name="SESSION_DESCRIPTION_HANDLER_ERROR",this.method=e,this.error=t,this.message=r||"Error with Session Description Handler"};return e.prototype=new Error,e}()}},function(e,t,r){var i=500;e.exports=function(e){var t={T1:i,T2:4e3,T4:5e3,TIMER_B:32e3,TIMER_D:0,TIMER_F:32e3,TIMER_H:32e3,TIMER_I:0,TIMER_J:0,TIMER_K:0,TIMER_L:32e3,TIMER_M:32e3,TIMER_N:32e3,PROVISIONAL_RESPONSE_INTERVAL:6e4};return["setTimeout","clearTimeout","setInterval","clearInterval"].forEach(function(r){t[r]=function(){return e[r].apply(e,arguments)}}),t}},function(e,t,r){e.exports=function(e){var t=function(e,t){};return t.prototype=Object.create(e.EventEmitter.prototype,{connect:{writable:!0,value:function(e){return e=e||{},this.connectPromise(e).then(function(e){!e.overrideEvent&&this.emit("connected")}.bind(this))}},connectPromise:{writable:!0,value:function(e){}},isConnected:{writable:!0,value:function(){}},send:{writable:!0,value:function(e,t){return t=t||{},this.sendPromise(e).then(function(e){!e.overrideEvent&&this.emit("messageSent",e.msg)}.bind(this))}},sendPromise:{writable:!0,value:function(e,t){}},onMessage:{writable:!0,value:function(e){}},disconnect:{writable:!0,value:function(e){return e=e||{},this.disconnectPromise(e).then(function(e){!e.overrideEvent&&this.emit("disconnected")}.bind(this))}},disconnectPromise:{writable:!0,value:function(e){}},afterConnected:{writable:!0,value:function(e){this.isConnected()?e():this.once("connected",e)}},waitForConnected:{writable:!0,value:function(){return console.warn("DEPRECATION WARNING Transport.waitForConnected(): use afterConnected() instead"),new e.Utils.Promise(function(e){this.afterConnected(e)}.bind(this))}}}),t}},function(e,t,r){e.exports=function(e){var t;function r(e,t){var r=t,i=0,n=0;if(e.substring(r,r+2).match(/(^\r\n)/))return-2;for(;0===i;){if(-1===(n=e.indexOf("\r\n",r)))return n;!e.substring(n+2,n+4).match(/(^\r\n)/)&&e.charAt(n+2).match(/(^\s+)/)?r=n+2:i=n}return i}function i(t,r,i,n){var s,o,a,c,u=r.indexOf(":",i),d=r.substring(i,u).trim(),h=r.substring(u+1,n).trim();switch(d.toLowerCase()){case"via":case"v":t.addHeader("via",h),1===t.getHeaders("via").length?(c=t.parseHeader("Via"))&&(t.via=c,t.via_branch=c.branch):c=0;break;case"from":case"f":t.setHeader("from",h),(c=t.parseHeader("from"))&&(t.from=c,t.from_tag=c.getParam("tag"));break;case"to":case"t":t.setHeader("to",h),(c=t.parseHeader("to"))&&(t.to=c,t.to_tag=c.getParam("tag"));break;case"record-route":if(-1===(c=e.Grammar.parse(h,"Record_Route"))){c=void 0;break}for(a=c.length,o=0;o<a;o++)s=c[o],t.addHeader("record-route",h.substring(s.position,s.offset)),t.headers["Record-Route"][t.getHeaders("record-route").length-1].parsed=s.parsed;break;case"call-id":case"i":t.setHeader("call-id",h),(c=t.parseHeader("call-id"))&&(t.call_id=h);break;case"contact":case"m":if(-1===(c=e.Grammar.parse(h,"Contact"))){c=void 0;break}for(a=c.length,o=0;o<a;o++)s=c[o],t.addHeader("contact",h.substring(s.position,s.offset)),t.headers.Contact[t.getHeaders("contact").length-1].parsed=s.parsed;break;case"content-length":case"l":t.setHeader("content-length",h),c=t.parseHeader("content-length");break;case"content-type":case"c":t.setHeader("content-type",h),c=t.parseHeader("content-type");break;case"cseq":t.setHeader("cseq",h),(c=t.parseHeader("cseq"))&&(t.cseq=c.value),t instanceof e.IncomingResponse&&(t.method=c.method);break;case"max-forwards":t.setHeader("max-forwards",h),c=t.parseHeader("max-forwards");break;case"www-authenticate":t.setHeader("www-authenticate",h),c=t.parseHeader("www-authenticate");break;case"proxy-authenticate":t.setHeader("proxy-authenticate",h),c=t.parseHeader("proxy-authenticate");break;case"refer-to":case"r":t.setHeader("refer-to",h),(c=t.parseHeader("refer-to"))&&(t.refer_to=c);break;default:t.setHeader(d,h),c=0}return void 0!==c||{error:'error parsing header "'+d+'"'}}(t={}).parseMessage=function(t,n){var s,o,a,c,u,d=0,h=t.indexOf("\r\n"),l=n.getLogger("sip.parser");if(-1!==h){if(o=t.substring(0,h),-1!==(u=e.Grammar.parse(o,"Request_Response"))){for(u.status_code?((s=new e.IncomingResponse(n)).status_code=u.status_code,s.reason_phrase=u.reason_phrase):((s=new e.IncomingRequest(n)).method=u.method,s.ruri=u.uri),s.data=t,d=h+2;;){if(-2===(h=r(t,d))){c=d+2;break}if(-1===h)return void l.error("malformed message");if(!0!==(u=i(s,t,d,h)))return void l.error(u.error);d=h+2}return s.hasHeader("content-length")?(a=s.getHeader("content-length"),s.body=t.substr(c,a)):s.body=t.substring(c),s}l.warn('error parsing first line of SIP message: "'+o+'"')}else l.warn("no CRLF found, not a SIP message, discarded")},e.Parser=t}},function(e,t,r){e.exports=function(e){var t,r,i,n;function s(t){var r=t.ua.configuration.hackAllowUnregisteredOptionTags,i=[],n={};return t.method===e.C.REGISTER?i.push("path","gruu"):t.method===e.C.INVITE&&(t.ua.contact.pub_gruu||t.ua.contact.temp_gruu)&&i.push("gruu"),t.ua.configuration.rel100===e.C.supported.SUPPORTED&&i.push("100rel"),t.ua.configuration.replaces===e.C.supported.SUPPORTED&&i.push("replaces"),i.push("outbound"),"Supported: "+(i=(i=i.concat(t.ua.configuration.extraSupported)).filter(function(t){var i=e.C.OPTION_TAGS[t],s=!n[t];return n[t]=!0,(i||r)&&s})).join(", ")+"\r\n"}(t=function(t,r,i,n,s,o){var a,c,u,d,h,l;if(n=n||{},!t||!r||!i)return null;this.logger=i.getLogger("sip.sipmessage"),this.ua=i,this.headers={},this.method=t,this.ruri=r,this.body=o,this.extraHeaders=(s||[]).slice(),this.statusCode=n.status_code,this.reasonPhrase=n.reason_phrase,n.route_set?this.setHeader("route",n.route_set):i.configuration.usePreloadedRoute&&this.setHeader("route",i.transport.server.sip_uri),this.setHeader("via",""),this.setHeader("max-forwards",e.UA.C.MAX_FORWARDS),h=n.to_uri||r,a=n.to_displayName||0===n.to_displayName?'"'+n.to_displayName+'" ':"",a+="<"+(h&&h.toRaw?h.toRaw():h)+">",a+=n.to_tag?";tag="+n.to_tag:"",this.to=new e.NameAddrHeader.parse(a),this.setHeader("to",a),l=n.from_uri||i.configuration.uri,c=n.from_displayName||0===n.from_displayName?'"'+n.from_displayName+'" ':i.configuration.displayName?'"'+i.configuration.displayName+'" ':"",c+="<"+(l&&l.toRaw?l.toRaw():l)+">;tag=",c+=n.from_tag||e.Utils.newTag(),this.from=new e.NameAddrHeader.parse(c),this.setHeader("from",c),u=n.call_id||i.configuration.sipjsId+e.Utils.createRandomToken(15),this.call_id=u,this.setHeader("call-id",u),d=n.cseq||Math.floor(1e4*Math.random()),this.cseq=d,this.setHeader("cseq",d+" "+t)}).prototype={setHeader:function(t,r){this.headers[e.Utils.headerize(t)]=r instanceof Array?r:[r]},getHeader:function(t){var r,i,n=this.extraHeaders.length,s=this.headers[e.Utils.headerize(t)];if(s){if(s[0])return s[0]}else for(r=new RegExp("^\\s*"+t+"\\s*:","i"),i=0;i<n;i++)if(s=this.extraHeaders[i],r.test(s))return s.substring(s.indexOf(":")+1).trim()},getHeaders:function(t){var r,i,n,s=this.headers[e.Utils.headerize(t)],o=[];if(s){for(i=s.length,r=0;r<i;r++)o.push(s[r]);return o}for(i=this.extraHeaders.length,n=new RegExp("^\\s*"+t+"\\s*:","i"),r=0;r<i;r++)s=this.extraHeaders[r],n.test(s)&&o.push(s.substring(s.indexOf(":")+1).trim());return o},hasHeader:function(t){var r,i,n=this.extraHeaders.length;if(this.headers[e.Utils.headerize(t)])return!0;for(r=new RegExp("^\\s*"+t+"\\s*:","i"),i=0;i<n;i++)if(r.test(this.extraHeaders[i]))return!0;return!1},toString:function(){var t,r,i,n="";for(t in n+=this.method+" "+(this.ruri.toRaw?this.ruri.toRaw():this.ruri)+" SIP/2.0\r\n",this.headers)for(r=this.headers[t].length,i=0;i<r;i++)n+=t+": "+this.headers[t][i]+"\r\n";for(r=this.extraHeaders.length,i=0;i<r;i++)n+=this.extraHeaders[i].trim()+"\r\n";return n+=s(this),n+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",this.body?"string"==typeof this.body?(n+="Content-Length: "+(r=e.Utils.str_utf8_length(this.body))+"\r\n\r\n",n+=this.body):this.body.body&&this.body.contentType?(r=e.Utils.str_utf8_length(this.body.body),n+="Content-Type: "+this.body.contentType+"\r\n",n+="Content-Length: "+r+"\r\n\r\n",n+=this.body.body):n+="Content-Length: 0\r\n\r\n":n+="Content-Length: 0\r\n\r\n",n}},(r=function(){this.data=null,this.headers=null,this.method=null,this.via=null,this.via_branch=null,this.call_id=null,this.cseq=null,this.from=null,this.from_tag=null,this.to=null,this.to_tag=null,this.body=null}).prototype={addHeader:function(t,r){var i={raw:r};t=e.Utils.headerize(t),this.headers[t]?this.headers[t].push(i):this.headers[t]=[i]},getHeader:function(t){var r=this.headers[e.Utils.headerize(t)];if(r)return r[0]?r[0].raw:void 0},getHeaders:function(t){var r,i,n=this.headers[e.Utils.headerize(t)],s=[];if(!n)return[];for(i=n.length,r=0;r<i;r++)s.push(n[r].raw);return s},hasHeader:function(t){return!!this.headers[e.Utils.headerize(t)]},parseHeader:function(t,r){var i,n,s;if(t=e.Utils.headerize(t),r=r||0,this.headers[t]){if(!(r>=this.headers[t].length))return n=(i=this.headers[t][r]).raw,i.parsed?i.parsed:-1===(s=e.Grammar.parse(n,t.replace(/-/g,"_")))?(this.headers[t].splice(r,1),void this.logger.warn('error parsing "'+t+'" header field with value "'+n+'"')):(i.parsed=s,s);this.logger.log('not so many "'+t+'" headers present')}else this.logger.log('header "'+t+'" not present')},s:function(e,t){return this.parseHeader(e,t)},setHeader:function(t,r){var i={raw:r};this.headers[e.Utils.headerize(t)]=[i]},toString:function(){return this.data}},((i=function(e){this.logger=e.getLogger("sip.sipmessage"),this.ua=e,this.headers={},this.ruri=null,this.transport=null,this.server_transaction=null}).prototype=new r).reply=function(t,r,i,n,o,a){var c,u,d,h,l,p=this.getHeader("To"),f=0,m=0;if(l=e.Utils.buildStatusLine(t,r),i=(i||[]).slice(),this.method===e.C.INVITE&&t>100&&t<=200)for(d=(c=this.getHeaders("record-route")).length;f<d;f++)l+="Record-Route: "+c[f]+"\r\n";for(d=(u=this.getHeaders("via")).length;m<d;m++)l+="Via: "+u[m]+"\r\n";for(!this.to_tag&&t>100?p+=";tag="+e.Utils.newTag():this.to_tag&&!this.s("to").hasParam("tag")&&(p+=";tag="+this.to_tag),l+="To: "+p+"\r\n",l+="From: "+this.getHeader("From")+"\r\n",l+="Call-ID: "+this.call_id+"\r\n",l+="CSeq: "+this.cseq+" "+this.method+"\r\n",d=i.length,h=0;h<d;h++)l+=i[h].trim()+"\r\n";return l+=s(this),l+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",n?"string"==typeof n?(l+="Content-Type: application/sdp\r\n",l+="Content-Length: "+(d=e.Utils.str_utf8_length(n))+"\r\n\r\n",l+=n):n.body&&n.contentType?(d=e.Utils.str_utf8_length(n.body),l+="Content-Type: "+n.contentType+"\r\n",l+="Content-Length: "+d+"\r\n\r\n",l+=n.body):l+="Content-Length: 0\r\n\r\n":l+="Content-Length: 0\r\n\r\n",this.server_transaction.receiveResponse(t,l).then(o,a),l},i.prototype.reply_sl=function(t,r){var i,n,s=0,o=this.getHeaders("via"),a=o.length;for(n=e.Utils.buildStatusLine(t,r);s<a;s++)n+="Via: "+o[s]+"\r\n";i=this.getHeader("To"),!this.to_tag&&t>100?i+=";tag="+e.Utils.newTag():this.to_tag&&!this.s("to").hasParam("tag")&&(i+=";tag="+this.to_tag),n+="To: "+i+"\r\n",n+="From: "+this.getHeader("From")+"\r\n",n+="Call-ID: "+this.call_id+"\r\n",n+="CSeq: "+this.cseq+" "+this.method+"\r\n",n+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",n+="Content-Length: 0\r\n\r\n",this.transport.send(n)},(n=function(e){this.logger=e.getLogger("sip.sipmessage"),this.headers={},this.status_code=null,this.reason_phrase=null}).prototype=new r,e.OutgoingRequest=t,e.IncomingRequest=i,e.IncomingResponse=n}},function(e,t,r){e.exports=function(e){var t;(t=function(t,r,i,n,s,o){var a,c,u,d;if(!i)throw new TypeError('missing or invalid "host" parameter');for(a in t=t||e.C.SIP,this.parameters={},this.headers={},s)this.setParam(a,s[a]);for(c in o)this.setHeader(c,o[c]);u={scheme:t,user:r,host:i,port:n},d={scheme:t.toLowerCase(),user:r,host:i.toLowerCase(),port:n},Object.defineProperties(this,{_normal:{get:function(){return d}},_raw:{get:function(){return u}},scheme:{get:function(){return d.scheme},set:function(e){u.scheme=e,d.scheme=e.toLowerCase()}},user:{get:function(){return d.user},set:function(e){d.user=u.user=e}},host:{get:function(){return d.host},set:function(e){u.host=e,d.host=e.toLowerCase()}},aor:{get:function(){return d.user+"@"+d.host}},port:{get:function(){return d.port},set:function(e){d.port=u.port=0===e?e:parseInt(e,10)||null}}})}).prototype={setParam:function(e,t){e&&(this.parameters[e.toLowerCase()]=null==t?null:t.toString())},getParam:function(e){if(e)return this.parameters[e.toLowerCase()]},hasParam:function(e){if(e)return!!this.parameters.hasOwnProperty(e.toLowerCase())},deleteParam:function(e){var t;if(e=e.toLowerCase(),this.parameters.hasOwnProperty(e))return t=this.parameters[e],delete this.parameters[e],t},clearParams:function(){this.parameters={}},setHeader:function(t,r){this.headers[e.Utils.headerize(t)]=r instanceof Array?r:[r]},getHeader:function(t){if(t)return this.headers[e.Utils.headerize(t)]},hasHeader:function(t){if(t)return!!this.headers.hasOwnProperty(e.Utils.headerize(t))},deleteHeader:function(t){var r;if(t=e.Utils.headerize(t),this.headers.hasOwnProperty(t))return r=this.headers[t],delete this.headers[t],r},clearHeaders:function(){this.headers={}},clone:function(){return new t(this._raw.scheme,this._raw.user,this._raw.host,this._raw.port,JSON.parse(JSON.stringify(this.parameters)),JSON.parse(JSON.stringify(this.headers)))},toRaw:function(){return this._toString(this._raw)},toString:function(){return this._toString(this._normal)},_toString:function(t){var r,i,n,s,o=[];for(i in s=t.scheme+":",t.scheme.toLowerCase().match("^sips?$")||(s+="//"),t.user&&(s+=e.Utils.escapeUser(t.user)+"@"),s+=t.host,(t.port||0===t.port)&&(s+=":"+t.port),this.parameters)s+=";"+i,null!==this.parameters[i]&&(s+="="+this.parameters[i]);for(r in this.headers)for(n in this.headers[r])o.push(r+"="+this.headers[r][n]);return o.length>0&&(s+="?"+o.join("&")),s}},t.parse=function(t){return-1!==(t=e.Grammar.parse(t,"SIP_URI"))?t:void 0},e.URI=t}},function(e,t,r){e.exports=function(e){var t;(t=function(t,r,i){var n;if(!(t&&t instanceof e.URI))throw new TypeError('missing or invalid "uri" parameter');for(n in this.uri=t,this.parameters={},i)this.setParam(n,i[n]);Object.defineProperties(this,{friendlyName:{get:function(){return this.displayName||t.aor}},displayName:{get:function(){return r},set:function(e){r=0===e?"0":e}}})}).prototype={setParam:function(e,t){e&&(this.parameters[e.toLowerCase()]=null==t?null:t.toString())},getParam:e.URI.prototype.getParam,hasParam:e.URI.prototype.hasParam,deleteParam:e.URI.prototype.deleteParam,clearParams:e.URI.prototype.clearParams,clone:function(){return new t(this.uri.clone(),this.displayName,JSON.parse(JSON.stringify(this.parameters)))},toString:function(){var e,t;for(t in e=this.displayName||0===this.displayName?'"'+this.displayName+'" ':"",e+="<"+this.uri.toString()+">",this.parameters)e+=";"+t,null!==this.parameters[t]&&(e+="="+this.parameters[t]);return e}},t.parse=function(t){return-1!==(t=e.Grammar.parse(t,"Name_Addr_Header"))?t:void 0},e.NameAddrHeader=t}},function(e,t,r){e.exports=function(e){var t={STATUS_TRYING:1,STATUS_PROCEEDING:2,STATUS_CALLING:3,STATUS_ACCEPTED:4,STATUS_COMPLETED:5,STATUS_TERMINATED:6,STATUS_CONFIRMED:7,NON_INVITE_CLIENT:"nict",NON_INVITE_SERVER:"nist",INVITE_CLIENT:"ict",INVITE_SERVER:"ist"};function r(e,t,r){var i;return i="SIP/2.0/"+(e.ua.configuration.hackViaTcp?"TCP":t.server.scheme),i+=" "+e.ua.configuration.viaHost+";branch="+r,e.ua.configuration.forceRport&&(i+=";rport"),i}var i=function(e,i,n){var s;this.type=t.NON_INVITE_CLIENT,this.transport=n,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=i,this.logger=e.ua.getLogger("sip.transaction.nict",this.id),s=r(e,n,this.id),this.request.setHeader("via",s),this.request_sender.ua.newTransaction(this)};(i.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},i.prototype.send=function(){this.stateChanged(t.STATUS_TRYING),this.F=e.Timers.setTimeout(this.timer_F.bind(this),e.Timers.TIMER_F),this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},i.prototype.onTransportError=function(){this.logger.log("transport error occurred, deleting non-INVITE client transaction "+this.id),e.Timers.clearTimeout(this.F),e.Timers.clearTimeout(this.K),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onTransportError()},i.prototype.timer_F=function(){this.logger.debug("Timer F expired for non-INVITE client transaction "+this.id),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onRequestTimeout()},i.prototype.timer_K=function(){this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this)},i.prototype.receiveResponse=function(r){var i=r.status_code;if(i<200)switch(this.state){case t.STATUS_TRYING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_PROCEEDING),this.request_sender.receiveResponse(r)}else switch(this.state){case t.STATUS_TRYING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_COMPLETED),e.Timers.clearTimeout(this.F),408===i?this.request_sender.onRequestTimeout():this.request_sender.receiveResponse(r),this.K=e.Timers.setTimeout(this.timer_K.bind(this),e.Timers.TIMER_K)}};var n=function(e,i,n){var s,o=this;this.type=t.INVITE_CLIENT,this.transport=n,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=i,this.logger=e.ua.getLogger("sip.transaction.ict",this.id),s=r(e,n,this.id),this.request.setHeader("via",s),this.request_sender.ua.newTransaction(this),this.request.cancel=function(e,t){for(var r=(t=(t||[]).slice()).length,i=null,n=0;n<r;n++)i=(i||"")+t[n].trim()+"\r\n";o.cancel_request(o,e,i)}};(n.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},n.prototype.send=function(){this.stateChanged(t.STATUS_CALLING),this.B=e.Timers.setTimeout(this.timer_B.bind(this),e.Timers.TIMER_B),this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},n.prototype.onTransportError=function(){this.logger.log("transport error occurred, deleting INVITE client transaction "+this.id),e.Timers.clearTimeout(this.B),e.Timers.clearTimeout(this.D),e.Timers.clearTimeout(this.M),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.state!==t.STATUS_ACCEPTED&&this.request_sender.onTransportError()},n.prototype.timer_M=function(){this.logger.debug("Timer M expired for INVITE client transaction "+this.id),this.state===t.STATUS_ACCEPTED&&(e.Timers.clearTimeout(this.B),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this))},n.prototype.timer_B=function(){this.logger.debug("Timer B expired for INVITE client transaction "+this.id),this.state===t.STATUS_CALLING&&(this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onRequestTimeout())},n.prototype.timer_D=function(){this.logger.debug("Timer D expired for INVITE client transaction "+this.id),e.Timers.clearTimeout(this.B),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this)},n.prototype.sendACK=function(t){var r,i=this;t=t||{},r=this.response.getHeader("contact")?this.response.parseHeader("contact").uri:this.request.ruri;var n=new e.OutgoingRequest("ACK",r,this.request.ua,{cseq:this.response.cseq,call_id:this.response.call_id,from_uri:this.response.from.uri,from_tag:this.response.from_tag,to_uri:this.response.to.uri,to_tag:this.response.to_tag,route_set:this.response.getHeaders("record-route").reverse()},t.extraHeaders||[],t.body);return this.ackSender=new e.RequestSender({request:n,onRequestTimeout:this.request_sender.applicant.applicant?this.request_sender.applicant.applicant.onRequestTimeout:function(){i.logger.warn("ACK Request timed out")},onTransportError:this.request_sender.applicant.applicant?this.request_sender.applicant.applicant.onRequestTransportError:function(){i.logger.warn("ACK Request had a transport error")},receiveResponse:t.receiveResponse||function(){i.logger.warn("Received a response to an ACK which was unexpected. Dropping Response.")}},this.request.ua).send(),n},n.prototype.cancel_request=function(r,i,n){var s=r.request;this.cancel=e.C.CANCEL+" "+s.ruri+" SIP/2.0\r\n",this.cancel+="Via: "+s.headers.Via.toString()+"\r\n",this.request.headers.Route&&(this.cancel+="Route: "+s.headers.Route.toString()+"\r\n"),this.cancel+="To: "+s.headers.To.toString()+"\r\n",this.cancel+="From: "+s.headers.From.toString()+"\r\n",this.cancel+="Call-ID: "+s.headers["Call-ID"].toString()+"\r\n",this.cancel+="Max-Forwards: "+e.UA.C.MAX_FORWARDS+"\r\n",this.cancel+="CSeq: "+s.headers.CSeq.toString().split(" ")[0]+" CANCEL\r\n",i&&(this.cancel+="Reason: "+i+"\r\n"),n&&(this.cancel+=n),this.cancel+="Content-Length: 0\r\n\r\n",this.state===t.STATUS_PROCEEDING&&this.transport.send(this.cancel)},n.prototype.receiveResponse=function(r){var i=r.status_code;if(r.transaction=this,this.response&&this.response.status_code===r.status_code&&this.response.cseq===r.cseq)return this.logger.debug("ICT Received a retransmission for cseq: "+r.cseq),void(this.ackSender&&this.ackSender.send());if(this.response=r,i>=100&&i<=199)switch(this.state){case t.STATUS_CALLING:this.stateChanged(t.STATUS_PROCEEDING),this.request_sender.receiveResponse(r),this.cancel&&this.transport.send(this.cancel);break;case t.STATUS_PROCEEDING:this.request_sender.receiveResponse(r)}else if(i>=200&&i<=299)switch(this.state){case t.STATUS_CALLING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_ACCEPTED),this.M=e.Timers.setTimeout(this.timer_M.bind(this),e.Timers.TIMER_M),this.request_sender.receiveResponse(r);break;case t.STATUS_ACCEPTED:this.request_sender.receiveResponse(r)}else if(i>=300&&i<=699)switch(this.state){case t.STATUS_CALLING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_COMPLETED),this.sendACK(),this.request_sender.receiveResponse(r);break;case t.STATUS_COMPLETED:this.sendACK()}};var s=function(e,t,i){var n;this.transport=i,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=t,this.logger=e.ua.getLogger("sip.transaction.nict",this.id),n=r(e,i,this.id),this.request.setHeader("via",n)};(s.prototype=Object.create(e.EventEmitter.prototype)).send=function(){this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},s.prototype.onTransportError=function(){this.logger.log("transport error occurred, for an ACK client transaction "+this.id),this.request_sender.onTransportError()};var o=function(e,r){this.type=t.NON_INVITE_SERVER,this.id=e.via_branch,this.request=e,this.transport=r.transport,this.ua=r,this.last_response="",e.server_transaction=this,this.logger=r.getLogger("sip.transaction.nist",this.id),this.state=t.STATUS_TRYING,r.newTransaction(this)};(o.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},o.prototype.timer_J=function(){this.logger.debug("Timer J expired for non-INVITE server transaction "+this.id),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this)},o.prototype.onTransportError=function(){this.transportError||(this.transportError=!0,this.logger.log("transport error occurred, deleting non-INVITE server transaction "+this.id),e.Timers.clearTimeout(this.J),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this))},o.prototype.receiveResponse=function(r,i){var n=e.Utils.defer();if(100===r)switch(this.state){case t.STATUS_TRYING:this.stateChanged(t.STATUS_PROCEEDING),this.transport.send(i).catch(function(){this.onTransportError()}.bind(this));break;case t.STATUS_PROCEEDING:this.last_response=i,this.transport.send(i).then(function(){n.resolve()}).catch(function(){this.onTransportError(),n.reject()}.bind(this))}else if(r>=200&&r<=699)switch(this.state){case t.STATUS_TRYING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_COMPLETED),this.last_response=i,this.J=e.Timers.setTimeout(this.timer_J.bind(this),e.Timers.TIMER_J),this.transport.send(i).then(function(){n.resolve()}).catch(function(){this.onTransportError(),n.reject()}.bind(this))}return n.promise};var a=function(e,r){this.type=t.INVITE_SERVER,this.id=e.via_branch,this.request=e,this.transport=r.transport,this.ua=r,this.last_response="",e.server_transaction=this,this.logger=r.getLogger("sip.transaction.ist",this.id),this.state=t.STATUS_PROCEEDING,r.newTransaction(this),this.resendProvisionalTimer=null,e.reply(100)};(a.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},a.prototype.timer_H=function(){this.logger.debug("Timer H expired for INVITE server transaction "+this.id),this.state===t.STATUS_COMPLETED&&this.logger.warn("transactions","ACK for INVITE server transaction was never received, call will be terminated"),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this)},a.prototype.timer_I=function(){this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this)},a.prototype.timer_L=function(){this.logger.debug("Timer L expired for INVITE server transaction "+this.id),this.state===t.STATUS_ACCEPTED&&(this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this))},a.prototype.onTransportError=function(){this.transportError||(this.transportError=!0,this.logger.log("transport error occurred, deleting INVITE server transaction "+this.id),null!==this.resendProvisionalTimer&&(e.Timers.clearInterval(this.resendProvisionalTimer),this.resendProvisionalTimer=null),e.Timers.clearTimeout(this.L),e.Timers.clearTimeout(this.H),e.Timers.clearTimeout(this.I),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this))},a.prototype.resend_provisional=function(){this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},a.prototype.receiveResponse=function(r,i){var n=this,s=e.Utils.defer();if(r>=100&&r<=199)switch(this.state){case t.STATUS_PROCEEDING:this.transport.send(i).catch(function(){this.onTransportError()}.bind(this)),this.last_response=i}if(r>100&&r<=199&&this.state===t.STATUS_PROCEEDING)null===this.resendProvisionalTimer&&(this.resendProvisionalTimer=e.Timers.setInterval(n.resend_provisional.bind(n),e.Timers.PROVISIONAL_RESPONSE_INTERVAL));else if(r>=200&&r<=299)switch(this.state){case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_ACCEPTED),this.last_response=i,this.L=e.Timers.setTimeout(n.timer_L.bind(n),e.Timers.TIMER_L),null!==this.resendProvisionalTimer&&(e.Timers.clearInterval(this.resendProvisionalTimer),this.resendProvisionalTimer=null);case t.STATUS_ACCEPTED:this.transport.send(i).then(function(){s.resolve()}).catch(function(e){this.logger.error(e),this.onTransportError(),s.reject()}.bind(this))}else if(r>=300&&r<=699)switch(this.state){case t.STATUS_PROCEEDING:null!==this.resendProvisionalTimer&&(e.Timers.clearInterval(this.resendProvisionalTimer),this.resendProvisionalTimer=null),this.transport.send(i).then(function(){this.stateChanged(t.STATUS_COMPLETED),this.H=e.Timers.setTimeout(n.timer_H.bind(n),e.Timers.TIMER_H),s.resolve()}.bind(this)).catch(function(e){this.logger.error(e),this.onTransportError(),s.reject()}.bind(this))}return s.promise};e.Transactions={C:t,checkTransaction:function(r,i){var n;switch(i.method){case e.C.INVITE:if(n=r.transactions.ist[i.via_branch]){switch(n.state){case t.STATUS_PROCEEDING:n.transport.send(n.last_response)}return!0}break;case e.C.ACK:if(!(n=r.transactions.ist[i.via_branch]))return!1;if(n.state===t.STATUS_ACCEPTED)return!1;if(n.state===t.STATUS_COMPLETED)return n.stateChanged(t.STATUS_CONFIRMED),n.I=e.Timers.setTimeout(n.timer_I.bind(n),e.Timers.TIMER_I),!0;break;case e.C.CANCEL:return(n=r.transactions.ist[i.via_branch])?(i.reply_sl(200),n.state!==t.STATUS_PROCEEDING):(i.reply_sl(481),!0);default:if(n=r.transactions.nist[i.via_branch]){switch(n.state){case t.STATUS_TRYING:break;case t.STATUS_PROCEEDING:case t.STATUS_COMPLETED:n.transport.send(n.last_response)}return!0}}},NonInviteClientTransaction:i,InviteClientTransaction:n,AckClientTransaction:s,NonInviteServerTransaction:o,InviteServerTransaction:a}}},function(e,t,r){e.exports=function(e){var t,i=r(17)(e),n={STATUS_EARLY:1,STATUS_CONFIRMED:2};(t=function(t,r,i,s){var o;if(this.uac_pending_reply=!1,this.uas_pending_reply=!1,!r.hasHeader("contact"))return{error:"unable to create a Dialog without Contact header field"};s=r instanceof e.IncomingResponse?r.status_code<200?n.STATUS_EARLY:n.STATUS_CONFIRMED:s||n.STATUS_CONFIRMED,o=r.parseHeader("contact"),"UAS"===i?(this.id={call_id:r.call_id,local_tag:r.to_tag,remote_tag:r.from_tag,toString:function(){return this.call_id+this.local_tag+this.remote_tag}},this.state=s,this.remote_seqnum=r.cseq,this.local_uri=r.parseHeader("to").uri,this.remote_uri=r.parseHeader("from").uri,this.remote_target=o.uri,this.route_set=r.getHeaders("record-route"),this.invite_seqnum=r.cseq,this.local_seqnum=r.cseq):"UAC"===i&&(this.id={call_id:r.call_id,local_tag:r.from_tag,remote_tag:r.to_tag,toString:function(){return this.call_id+this.local_tag+this.remote_tag}},this.state=s,this.invite_seqnum=r.cseq,this.local_seqnum=r.cseq,this.local_uri=r.parseHeader("from").uri,this.pracked=[],this.remote_uri=r.parseHeader("to").uri,this.remote_target=o.uri,this.route_set=r.getHeaders("record-route").reverse()),this.logger=t.ua.getLogger("sip.dialog",this.id.toString()),this.owner=t,t.ua.dialogs[this.id.toString()]=this,this.logger.log("new "+i+" dialog created with status "+(this.state===n.STATUS_EARLY?"EARLY":"CONFIRMED")),t.emit("dialog",this)}).prototype={update:function(e,t){this.state=n.STATUS_CONFIRMED,this.logger.log("dialog "+this.id.toString()+"  changed to CONFIRMED state"),"UAC"===t&&(this.route_set=e.getHeaders("record-route").reverse())},terminate:function(){this.logger.log("dialog "+this.id.toString()+" deleted"),this.sessionDescriptionHandler&&this.state!==n.STATUS_CONFIRMED&&this.sessionDescriptionHandler.close(),delete this.owner.ua.dialogs[this.id.toString()]},createRequest:function(t,r,i){var n,s;return r=(r||[]).slice(),this.local_seqnum||(this.local_seqnum=Math.floor(1e4*Math.random())),n=t===e.C.CANCEL||t===e.C.ACK?this.invite_seqnum:this.local_seqnum+=1,(s=new e.OutgoingRequest(t,this.remote_target,this.owner.ua,{cseq:n,call_id:this.id.call_id,from_uri:this.local_uri,from_tag:this.id.local_tag,to_uri:this.remote_uri,to_tag:this.id.remote_tag,route_set:this.route_set},r,i)).dialog=this,s},checkInDialogRequest:function(t){var r=this;if(this.remote_seqnum){if(t.cseq<this.remote_seqnum)return t.method!==e.C.ACK&&t.reply(500),t.cseq===this.invite_seqnum}else this.remote_seqnum=t.cseq;switch(t.method){case e.C.INVITE:if(!0===this.uac_pending_reply)t.reply(491);else{if(!0===this.uas_pending_reply&&t.cseq>this.remote_seqnum){var i=1+(10*Math.random()|0);return t.reply(500,null,["Retry-After:"+i]),this.remote_seqnum=t.cseq,!1}this.uas_pending_reply=!0,t.server_transaction.on("stateChanged",function t(){this.state!==e.Transactions.C.STATUS_ACCEPTED&&this.state!==e.Transactions.C.STATUS_COMPLETED&&this.state!==e.Transactions.C.STATUS_TERMINATED||(this.removeListener("stateChanged",t),r.uas_pending_reply=!1)})}t.hasHeader("contact")&&t.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_ACCEPTED&&(r.remote_target=t.parseHeader("contact").uri)});break;case e.C.NOTIFY:t.hasHeader("contact")&&t.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_COMPLETED&&(r.remote_target=t.parseHeader("contact").uri)})}return t.cseq>this.remote_seqnum&&(this.remote_seqnum=t.cseq),!0},sendRequest:function(e,t,r){var n=((r=r||{}).extraHeaders||[]).slice(),s=null;r.body&&(r.body.body?s=r.body:((s={}).body=r.body,r.contentType&&(s.contentType=r.contentType)));var o=this.createRequest(t,n,s);return new i(this,e,o).send(),o},receiveRequest:function(e){this.checkInDialogRequest(e)&&this.owner.receiveRequest(e)}},t.C=n,e.Dialog=t}},function(e,t,r){e.exports=function(e){var t;return(t=function(e,t,r){this.dialog=e,this.applicant=t,this.request=r,this.reattempt=!1,this.reattemptTimer=null}).prototype={send:function(){var t=this,r=new e.RequestSender(this,this.dialog.owner.ua);r.send(),this.request.method===e.C.INVITE&&r.clientTransaction.state!==e.Transactions.C.STATUS_TERMINATED&&(this.dialog.uac_pending_reply=!0,r.clientTransaction.on("stateChanged",function r(){this.state!==e.Transactions.C.STATUS_ACCEPTED&&this.state!==e.Transactions.C.STATUS_COMPLETED&&this.state!==e.Transactions.C.STATUS_TERMINATED||(this.removeListener("stateChanged",r),t.dialog.uac_pending_reply=!1)}))},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},receiveResponse:function(t){var r=this;408===t.status_code||481===t.status_code?this.applicant.onDialogError(t):t.method===e.C.INVITE&&491===t.status_code?this.reattempt?this.applicant.receiveResponse(t):(this.request.cseq.value=this.dialog.local_seqnum+=1,this.reattemptTimer=e.Timers.setTimeout(function(){r.applicant.owner.status!==e.Session.C.STATUS_TERMINATED&&(r.reattempt=!0,r.request_sender.send())},this.getReattemptTimeout())):this.applicant.receiveResponse(t)}},t}},function(e,t,r){e.exports=function(e){var t;(t=function(t,r){this.logger=r.getLogger("sip.requestsender"),this.ua=r,this.applicant=t,this.method=t.request.method,this.request=t.request,this.credentials=null,this.challenged=!1,this.staled=!1,r.status!==e.UA.C.STATUS_USER_CLOSED||this.method===e.C.BYE&&this.method===e.C.ACK||this.onTransportError()}).prototype={send:function(){switch(this.method){case"INVITE":this.clientTransaction=new e.Transactions.InviteClientTransaction(this,this.request,this.ua.transport);break;case"ACK":this.clientTransaction=new e.Transactions.AckClientTransaction(this,this.request,this.ua.transport);break;default:this.clientTransaction=new e.Transactions.NonInviteClientTransaction(this,this.request,this.ua.transport)}return this.clientTransaction.send(),this.clientTransaction},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},receiveResponse:function(t){var r,i,n,s=t.status_code;if(401===s||407===s){if(401===t.status_code?(i=t.parseHeader("www-authenticate"),n="authorization"):(i=t.parseHeader("proxy-authenticate"),n="proxy-authorization"),!i)return this.logger.warn(t.status_code+" with wrong or missing challenge, cannot authenticate"),void this.applicant.receiveResponse(t);if(!this.challenged||!this.staled&&!0===i.stale){if(this.credentials||(this.credentials=this.ua.configuration.authenticationFactory(this.ua)),!this.credentials.authenticate(this.request,i))return void this.applicant.receiveResponse(t);this.challenged=!0,i.stale&&(this.staled=!0),t.method===e.C.REGISTER?r=this.applicant.cseq+=1:this.request.dialog?r=this.request.dialog.local_seqnum+=1:(r=this.request.cseq+1,this.request.cseq=r),this.request.setHeader("cseq",r+" "+this.method),this.request.setHeader(n,this.credentials.toString()),this.send()}else this.applicant.receiveResponse(t)}else this.applicant.receiveResponse(t)}},e.RequestSender=t}},function(e,t,r){e.exports=function(e){var t;(t=function(t){var r={};this.registrar=t.configuration.registrarServer,this.expires=t.configuration.registerExpires,this.contact=t.contact.toString(),this.contact+=";reg-id=1",this.contact+=';+sip.instance="<urn:uuid:'+t.configuration.instanceId+'>"',this.call_id=e.Utils.createRandomToken(22),this.cseq=Math.floor(1e4*Math.random()),this.to_uri=t.configuration.uri,r.to_uri=this.to_uri,r.to_displayName=t.configuration.displayName,r.call_id=this.call_id,r.cseq=this.cseq,e.Utils.augment(this,e.ClientContext,[t,"REGISTER",this.registrar,{params:r}]),this.registrationTimer=null,this.registrationExpiredTimer=null,this.registered=!1,this.logger=t.getLogger("sip.registercontext"),t.on("transportCreated",function(e){e.on("disconnected",this.onTransportDisconnected.bind(this))}.bind(this))}).prototype=Object.create({},{register:{writable:!0,value:function(t){var r,i=this;this.options=t||{},(r=(this.options.extraHeaders||[]).slice()).push("Contact: "+this.contact+";expires="+this.expires),r.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.closeHeaders=this.options.closeWithHeaders?(this.options.extraHeaders||[]).slice():[],this.receiveResponse=function(t){var r,n,s,o=t.getHeaders("contact").length;if(t.cseq===this.cseq)switch(null!==this.registrationTimer&&(e.Timers.clearTimeout(this.registrationTimer),this.registrationTimer=null),!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):if(this.emit("accepted",t),t.hasHeader("expires")&&(n=t.getHeader("expires")),null!==this.registrationExpiredTimer&&(e.Timers.clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),!o){this.logger.warn("no Contact header in response to REGISTER, response ignored");break}for(;o--;){if((r=t.parseHeader("contact",o)).uri.user===this.ua.contact.uri.user){n=r.getParam("expires");break}r=null}if(!r){this.logger.warn("no Contact header pointing to us, response ignored");break}n||(n=this.expires),this.registrationTimer=e.Timers.setTimeout(function(){i.registrationTimer=null,i.register(i.options)},1e3*n-3e3),this.registrationExpiredTimer=e.Timers.setTimeout(function(){i.logger.warn("registration expired"),i.registered&&i.unregistered(null,e.C.causes.EXPIRES)},1e3*n),r.hasParam("temp-gruu")&&(this.ua.contact.temp_gruu=e.URI.parse(r.getParam("temp-gruu").replace(/"/g,""))),r.hasParam("pub-gruu")&&(this.ua.contact.pub_gruu=e.URI.parse(r.getParam("pub-gruu").replace(/"/g,""))),this.registered=!0,this.emit("registered",t||null);break;case/^423$/.test(t.status_code):t.hasHeader("min-expires")?(this.expires=t.getHeader("min-expires"),this.register(this.options)):(this.logger.warn("423 response received for REGISTER without Min-Expires"),this.registrationFailure(t,e.C.causes.SIP_FAILURE_CODE));break;default:s=e.Utils.sipErrorCause(t.status_code),this.registrationFailure(t,s)}},this.onRequestTimeout=function(){this.registrationFailure(null,e.C.causes.REQUEST_TIMEOUT)},this.onTransportError=function(){this.registrationFailure(null,e.C.causes.CONNECTION_ERROR)},this.cseq++,this.request.cseq=this.cseq,this.request.setHeader("cseq",this.cseq+" REGISTER"),this.request.extraHeaders=r,this.send()}},registrationFailure:{writable:!0,value:function(e,t){this.emit("failed",e||null,t||null)}},onTransportDisconnected:{writable:!0,value:function(){this.registered_before=this.registered,null!==this.registrationTimer&&(e.Timers.clearTimeout(this.registrationTimer),this.registrationTimer=null),null!==this.registrationExpiredTimer&&(e.Timers.clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),this.registered&&this.unregistered(null,e.C.causes.CONNECTION_ERROR)}},onTransportConnected:{writable:!0,value:function(){this.register(this.options)}},close:{writable:!0,value:function(){var e={all:!1,extraHeaders:this.closeHeaders};this.registered_before=this.registered,this.registered&&this.unregister(e)}},unregister:{writable:!0,value:function(t){var r;t=t||{},this.registered||t.all||this.logger.warn("Already unregistered, but sending an unregister anyways."),r=(t.extraHeaders||[]).slice(),this.registered=!1,null!==this.registrationTimer&&(e.Timers.clearTimeout(this.registrationTimer),this.registrationTimer=null),t.all?(r.push("Contact: *"),r.push("Expires: 0")):r.push("Contact: "+this.contact+";expires=0"),this.receiveResponse=function(t){var r;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):this.emit("accepted",t),null!==this.registrationExpiredTimer&&(e.Timers.clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),this.unregistered(t);break;default:r=e.Utils.sipErrorCause(t.status_code),this.unregistered(t,r)}},this.onRequestTimeout=function(){},this.cseq++,this.request.cseq=this.cseq,this.request.setHeader("cseq",this.cseq+" REGISTER"),this.request.extraHeaders=r,this.send()}},unregistered:{writable:!0,value:function(e,t){this.registered=!1,this.emit("unregistered",e||null,t||null)}}}),e.RegisterContext=t}},function(e,t,r){e.exports=function(e){var t=function(){};return t.prototype=Object.create(e.prototype,{close:{value:function(){}},getDescription:{value:function(e,t){}},hasDescription:{value:function(e){}},holdModifier:{value:function(e){}},setDescription:{value:function(e,t,r){}},sendDtmf:{value:function(e,t){}},getDirection:{value:function(){}}}),t}},function(e,t,r){e.exports=function(e){var t;((t=function(t,r,i,n){var s=i;if(void 0===i)throw new TypeError("Not enough arguments");if(this.ua=t,this.logger=t.getLogger("sip.clientcontext"),this.method=r,!(i=t.normalizeTarget(i)))throw new TypeError("Invalid target: "+s);(n=Object.create(n||Object.prototype)).extraHeaders=(n.extraHeaders||[]).slice(),this.request=new e.OutgoingRequest(this.method,i,this.ua,n.params,n.extraHeaders),n.body&&(this.body={},this.body.body=n.body,n.contentType&&(this.body.contentType=n.contentType),this.request.body=this.body),this.localIdentity=this.request.from,this.remoteIdentity=this.request.to,this.data={}}).prototype=Object.create(e.EventEmitter.prototype)).send=function(){return new e.RequestSender(this,this.ua).send(),this},t.prototype.cancel=function(t){(t=t||{}).extraHeaders=(t.extraHeaders||[]).slice();var r=e.Utils.getCancelReason(t.status_code,t.reason_phrase);this.request.cancel(r,t.extraHeaders),this.emit("cancel")},t.prototype.receiveResponse=function(t){var r=e.Utils.getReasonPhrase(t.status_code);switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t,r);break;case/^2[0-9]{2}$/.test(t.status_code):this.ua.applicants[this]&&delete this.ua.applicants[this],this.emit("accepted",t,r);break;default:this.ua.applicants[this]&&delete this.ua.applicants[this],this.emit("rejected",t,r),this.emit("failed",t,r)}},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR)},e.ClientContext=t}},function(e,t,r){e.exports=function(e){var t;((t=function(t,r){this.ua=t,this.logger=t.getLogger("sip.servercontext"),this.request=r,r.method===e.C.INVITE?this.transaction=new e.Transactions.InviteServerTransaction(r,t):this.transaction=new e.Transactions.NonInviteServerTransaction(r,t),r.body&&(this.body=r.body),r.hasHeader("Content-Type")&&(this.contentType=r.getHeader("Content-Type")),this.method=r.method,this.data={},this.localIdentity=r.to,this.remoteIdentity=r.from,r.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(r.getHeader("P-Asserted-Identity")))}).prototype=Object.create(e.EventEmitter.prototype)).progress=function(e){return(e=Object.create(e||Object.prototype)).statusCode||(e.statusCode=180),e.minCode=100,e.maxCode=199,e.events=["progress"],this.reply(e)},t.prototype.accept=function(e){return(e=Object.create(e||Object.prototype)).statusCode||(e.statusCode=200),e.minCode=200,e.maxCode=299,e.events=["accepted"],this.reply(e)},t.prototype.reject=function(e){return(e=Object.create(e||Object.prototype)).statusCode||(e.statusCode=480),e.minCode=300,e.maxCode=699,e.events=["rejected","failed"],this.reply(e)},t.prototype.reply=function(t){var r,i=(t=t||{}).statusCode||100,n=t.minCode||100,s=t.maxCode||699,o=e.Utils.getReasonPhrase(i,t.reasonPhrase),a=t.extraHeaders||[],c=t.body,u=t.events||[];if(i<n||i>s)throw new TypeError("Invalid statusCode: "+i);return r=this.request.reply(i,o,a,c),u.forEach(function(e){this.emit(e,r,o)},this),this},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR)},e.ServerContext=t}},function(e,t,r){e.exports=function(e){var t,i,n,s,o,a=r(24)(e),c={STATUS_NULL:0,STATUS_INVITE_SENT:1,STATUS_1XX_RECEIVED:2,STATUS_INVITE_RECEIVED:3,STATUS_WAITING_FOR_ANSWER:4,STATUS_ANSWERED:5,STATUS_WAITING_FOR_PRACK:6,STATUS_WAITING_FOR_ACK:7,STATUS_CANCELED:8,STATUS_TERMINATED:9,STATUS_ANSWERED_WAITING_FOR_PRACK:10,STATUS_EARLY_MEDIA:11,STATUS_CONFIRMED:12};(t=function(t){if(this.status=c.STATUS_NULL,this.dialog=null,this.pendingReinvite=!1,this.earlyDialogs={},!t)throw new e.Exceptions.SessionDescriptionHandlerMissing("A session description handler is required for the session to function");this.sessionDescriptionHandlerFactory=t,this.hasOffer=!1,this.hasAnswer=!1,this.timers={ackTimer:null,expiresTimer:null,invite2xxTimer:null,userNoAnswerTimer:null,rel1xxTimer:null,prackTimer:null},this.startTime=null,this.endTime=null,this.tones=null,this.local_hold=!1,this.early_sdp=null,this.rel100=e.C.supported.UNSUPPORTED}).prototype={dtmf:function(t,r){var i=[],n=this,s=this.ua.configuration.dtmfType;if(r=r||{},void 0===t)throw new TypeError("Not enough arguments");if(this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_WAITING_FOR_ACK)throw new e.Exceptions.InvalidStateError(this.status);if("string"!=typeof t&&"number"!=typeof t||!t.toString().match(/^[0-9A-D#*,]+$/i))throw new TypeError("Invalid tones: "+t);(t=t.toString(),s===e.C.dtmfType.RTP)&&(this.sessionDescriptionHandler.sendDtmf(t,r)||(this.logger.warn("Attempt to use dtmfType 'RTP' has failed, falling back to INFO packet method"),s=e.C.dtmfType.INFO));if(s===e.C.dtmfType.INFO){for(t=t.split("");t.length>0;)i.push(new a(this,t.shift(),r));if(this.tones)return this.tones=this.tones.concat(i),this;this.tones=i,function t(){var i,s;if(n.status===c.STATUS_TERMINATED||!n.tones||0===n.tones.length)return n.tones=null,this;(i=n.tones.shift()).on("failed",function(){n.tones=null}),i.send(r),s=i.duration+i.interToneGap,e.Timers.setTimeout(t,s)}()}return this},bye:function(t){var r=(t=Object.create(t||Object.prototype)).statusCode;if(this.status===c.STATUS_TERMINATED)return this.logger.error("Error: Attempted to send BYE in a terminated session."),this;if(this.logger.log("terminating Session"),r&&(r<200||r>=700))throw new TypeError("Invalid statusCode: "+r);return t.receiveResponse=function(){},this.sendRequest(e.C.BYE,t).terminated()},refer:function(t,r){if(r=r||{},this.status!==c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.referContext=new e.ReferClientContext(this.ua,this,t,r),this.emit("referRequested",this.referContext),this.referContext.refer(r)},sendRequest:function(t,r){r=r||{};var i=this,n=new e.OutgoingRequest(t,this.dialog.remote_target,this.ua,{cseq:r.cseq||(this.dialog.local_seqnum+=1),call_id:this.dialog.id.call_id,from_uri:this.dialog.local_uri,from_tag:this.dialog.id.local_tag,to_uri:this.dialog.remote_uri,to_tag:this.dialog.id.remote_tag,route_set:this.dialog.route_set,statusCode:r.statusCode,reasonPhrase:r.reasonPhrase},r.extraHeaders||[],r.body);return new e.RequestSender({request:n,onRequestTimeout:function(){i.onRequestTimeout()},onTransportError:function(){i.onTransportError()},receiveResponse:r.receiveResponse||function(e){i.receiveNonInviteResponse(e)}},this.ua).send(),this.emit(t.toLowerCase(),n),this},close:function(){var t;if(this.status===c.STATUS_TERMINATED)return this;for(t in this.logger.log("closing INVITE session "+this.id),this.sessionDescriptionHandler&&this.sessionDescriptionHandler.close(),this.timers)e.Timers.clearTimeout(this.timers[t]);for(t in this.dialog&&(this.dialog.terminate(),delete this.dialog),this.earlyDialogs)this.earlyDialogs[t].terminate(),delete this.earlyDialogs[t];return this.status=c.STATUS_TERMINATED,this.ua.transport.removeListener("transportError",this.errorListener),delete this.ua.sessions[this.id],this},createDialog:function(t,r,i){var n,s,o=t["UAS"===r?"to_tag":"from_tag"],a=t["UAS"===r?"from_tag":"to_tag"],c=t.call_id+o+a;if(s=this.earlyDialogs[c],i)return!!s||((s=new e.Dialog(this,t,r,e.Dialog.C.STATUS_EARLY)).error?(this.logger.error(s.error),this.failed(t,e.C.causes.INTERNAL_ERROR),!1):(this.earlyDialogs[c]=s,!0));if(s){for(var u in s.update(t,r),this.dialog=s,delete this.earlyDialogs[c],this.earlyDialogs)this.earlyDialogs[u].terminate(),delete this.earlyDialogs[u];return!0}return(n=new e.Dialog(this,t,r)).error?(this.logger.error(n.error),this.failed(t,e.C.causes.INTERNAL_ERROR),!1):(this.to_tag=t.to_tag,this.dialog=n,!0)},hold:function(t,r){if(this.status!==c.STATUS_WAITING_FOR_ACK&&this.status!==c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.local_hold?this.logger.log("Session is already on hold, cannot put it on hold again"):((t=t||{}).modifiers=r||[],t.modifiers.push(this.sessionDescriptionHandler.holdModifier),this.local_hold=!0,this.sendReinvite(t))},unhold:function(t,r){if(this.status!==c.STATUS_WAITING_FOR_ACK&&this.status!==c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.local_hold?(t=t||{},r&&(t.modifiers=r),this.local_hold=!1,this.sendReinvite(t)):this.logger.log("Session is not on hold, cannot unhold it")},reinvite:function(e,t){return e=e||{},t&&(e.modifiers=t),this.sendReinvite(e)},receiveReinvite:function(t){var r,i=this;if(i.emit("reinvite",this),t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),"0"!==t.getHeader("Content-Length")||t.getHeader("Content-Type")){if(!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type")))return t.reply(415),void this.emit("reinviteFailed",i);r=this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(this.sessionDescriptionHandler.getDescription.bind(this.sessionDescriptionHandler,this.sessionDescriptionHandlerOptions,this.modifiers))}else r=this.sessionDescriptionHandler.getDescription(this.sessionDescriptionHandlerOptions,this.modifiers);this.receiveRequest=function(t){t.method===e.C.ACK&&this.status===c.STATUS_WAITING_FOR_ACK?this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,this.emit("confirmed",t)}.bind(this))):(e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,this.emit("confirmed",t)):e.Session.prototype.receiveRequest.apply(this,[t])}.bind(this),r.catch(function(r){var n;throw r instanceof e.Exceptions.SessionDescriptionHandlerError?n=500:r instanceof e.Exceptions.RenegotiationError?(i.emit("renegotiationError",r),i.logger.warn(r),n=488):(i.logger.error(r),n=488),t.reply(n),i.emit("reinviteFailed",i),r}).then(function(e){var r=["Contact: "+i.contact];t.reply(200,null,r,e,function(){i.status=c.STATUS_WAITING_FOR_ACK,i.setACKTimer(),i.emit("reinviteAccepted",i)})})},sendReinvite:function(t){if(this.pendingReinvite)this.logger.warn("Reinvite in progress. Please wait until complete, then try again.");else{this.pendingReinvite=!0,(t=t||{}).modifiers=t.modifiers||[];var r=this,i=(t.extraHeaders||[]).slice();i.push("Contact: "+this.contact),i.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).then(function(t){r.sendRequest(e.C.INVITE,{extraHeaders:i,body:t,receiveResponse:r.receiveReinviteResponse.bind(r)})}).catch(function(t){if(t instanceof e.Exceptions.RenegotiationError)return r.pendingReinvite=!1,r.emit("renegotiationError",t),r.logger.warn("Renegotiation Error"),void r.logger.warn(t);r.logger.error("sessionDescriptionHandler error"),r.logger.error(t)})}},receiveRequest:function(t){switch(t.method){case e.C.BYE:t.reply(200),this.status===c.STATUS_CONFIRMED&&(this.emit("bye",t),this.terminated(t,e.C.causes.BYE));break;case e.C.INVITE:this.status===c.STATUS_CONFIRMED&&(this.logger.log("re-INVITE received"),this.receiveReinvite(t));break;case e.C.INFO:if(this.status===c.STATUS_CONFIRMED||this.status===c.STATUS_WAITING_FOR_ACK){if(this.onInfo)return this.onInfo(t);var r,i,n,s=t.getHeader("content-type"),o=/^(Signal\s*?=\s*?)([0-9A-D#*]{1})(\s)?.*/,u=/^(Duration\s?=\s?)([0-9]{1,4})(\s)?.*/;s&&(s.match(/^application\/dtmf-relay/i)?(t.body&&2===(r=t.body.split("\r\n",2)).length&&(o.test(r[0])&&(i=r[0].replace(o,"$2")),u.test(r[1])&&(n=parseInt(r[1].replace(u,"$2"),10))),new a(this,i,{duration:n}).init_incoming(t)):t.reply(415,null,["Accept: application/dtmf-relay"]))}break;case e.C.REFER:if(this.status===c.STATUS_CONFIRMED)if(this.logger.log("REFER received"),this.referContext=new e.ReferServerContext(this.ua,t),this.listeners("referRequested").length)this.emit("referRequested",this.referContext);else{this.logger.log("No referRequested listeners, automatically accepting and following the refer");var d={followRefer:!0};this.passedOptions&&(d.inviteOptions=this.passedOptions),this.referContext.accept(d,this.modifiers)}break;case e.C.NOTIFY:if(this.referContext&&this.referContext instanceof e.ReferClientContext&&t.hasHeader("event")&&/^refer(;.*)?$/.test(t.getHeader("event")))return void this.referContext.receiveNotify(t);t.reply(200,"OK"),this.emit("notify",t)}},receiveReinviteResponse:function(t){var r=this;if(this.status!==c.STATUS_TERMINATED)if(this.pendingReinvite)switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):if(this.status=c.STATUS_CONFIRMED,this.emit("ack",t.transaction.sendACK()),this.pendingReinvite=!1,e.Timers.clearTimeout(r.timers.invite2xxTimer),!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.logger.error("2XX response received to re-invite but did not have a description"),this.emit("reinviteFailed",r),this.emit("renegotiationError",new e.Exceptions.RenegotiationError("2XX response received to re-invite but did not have a description"));break}this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).catch(function(t){r.logger.error("Could not set the description in 2XX response"),r.logger.error(t),r.emit("reinviteFailed",r),r.emit("renegotiationError",t),r.sendRequest(e.C.BYE,{extraHeaders:["Reason: "+e.Utils.getReasonHeaderValue(488,"Not Acceptable Here")]}),r.terminated(null,e.C.causes.INCOMPATIBLE_SDP)}).then(function(){r.emit("reinviteAccepted",r)});break;default:this.pendingReinvite=!1,this.logger.log("Received a non 1XX or 2XX response to a re-invite"),this.emit("reinviteFailed",r),this.emit("renegotiationError",new e.Exceptions.RenegotiationError("Invalid response to a re-invite"))}else this.logger.error("Received reinvite response, but have no pending reinvite");else this.logger.error("Received reinvite response, but in STATUS_TERMINATED")},acceptAndTerminate:function(t,r,i){var n=[];return r&&n.push("Reason: "+e.Utils.getReasonHeaderValue(r,i)),(this.dialog||this.createDialog(t,"UAC"))&&(this.emit("ack",t.transaction.sendACK()),this.sendRequest(e.C.BYE,{extraHeaders:n})),this},setInvite2xxTimer:function(t,r){var i=this,n=e.Timers.T1;this.timers.invite2xxTimer=e.Timers.setTimeout(function s(){if(i.status===c.STATUS_WAITING_FOR_ACK){i.logger.log("no ACK received, attempting to retransmit OK");var o=["Contact: "+i.contact];t.reply(200,null,o,r),n=Math.min(2*n,e.Timers.T2),i.timers.invite2xxTimer=e.Timers.setTimeout(s,n)}},n)},setACKTimer:function(){var t=this;this.timers.ackTimer=e.Timers.setTimeout(function(){t.status===c.STATUS_WAITING_FOR_ACK&&(t.logger.log("no ACK received for an extended period of time, terminating the call"),e.Timers.clearTimeout(t.timers.invite2xxTimer),t.sendRequest(e.C.BYE),t.terminated(null,e.C.causes.NO_ACK))},e.Timers.TIMER_H)},onTransportError:function(){this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)},onRequestTimeout:function(){this.status===c.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==c.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))},onDialogError:function(t){this.status===c.STATUS_CONFIRMED?this.terminated(t,e.C.causes.DIALOG_ERROR):this.status!==c.STATUS_TERMINATED&&(this.failed(t,e.C.causes.DIALOG_ERROR),this.terminated(t,e.C.causes.DIALOG_ERROR))},failed:function(e,t){return this.status===c.STATUS_TERMINATED?this:(this.emit("failed",e||null,t||null),this)},rejected:function(e,t){return this.emit("rejected",e||null,t||null),this},canceled:function(){return this.sessionDescriptionHandler&&this.sessionDescriptionHandler.close(),this.emit("cancel"),this},accepted:function(t,r){return r=e.Utils.getReasonPhrase(t&&t.status_code,r),this.startTime=new Date,this.replacee&&(this.replacee.emit("replaced",this),this.replacee.terminate()),this.emit("accepted",t,r),this},terminated:function(e,t){return this.status===c.STATUS_TERMINATED?this:(this.endTime=new Date,this.close(),this.emit("terminated",e||null,t||null),this)},connecting:function(e){return this.emit("connecting",{request:e}),this}},t.C=c,e.Session=t,(i=function(t,r){var i,n=this,s=r.getHeader("Content-Type"),o=r.parseHeader("Content-Disposition");function a(e,t){r.hasHeader(e)&&r.getHeader(e).toLowerCase().indexOf("100rel")>=0&&(n.rel100=t)}if(e.Utils.augment(this,e.ServerContext,[t,r]),e.Utils.augment(this,e.Session,[t.configuration.sessionDescriptionHandlerFactory]),o&&"render"===o.type&&(this.renderbody=r.body,this.rendertype=s),this.status=c.STATUS_INVITE_RECEIVED,this.from_tag=r.from_tag,this.id=r.call_id+this.from_tag,this.request=r,this.contact=this.ua.contact.toString(),this.receiveNonInviteResponse=function(){},this.logger=t.getLogger("sip.inviteservercontext",this.id),this.ua.sessions[this.id]=this,r.hasHeader("expires")&&(i=1e3*r.getHeader("expires")),a("require",e.C.supported.REQUIRED),a("supported",e.C.supported.SUPPORTED),r.to_tag=e.Utils.newTag(),this.createDialog(r,"UAS",!0)){var u={extraHeaders:["Contact: "+n.contact]};n.rel100!==e.C.supported.REQUIRED&&n.progress(u),n.status=c.STATUS_WAITING_FOR_ANSWER,n.timers.userNoAnswerTimer=e.Timers.setTimeout(function(){r.reply(408),n.failed(r,e.C.causes.NO_ANSWER),n.terminated(r,e.C.causes.NO_ANSWER)},n.ua.configuration.noAnswerTimeout),i&&(n.timers.expiresTimer=e.Timers.setTimeout(function(){n.status===c.STATUS_WAITING_FOR_ANSWER&&(r.reply(487),n.failed(r,e.C.causes.EXPIRES),n.terminated(r,e.C.causes.EXPIRES))},i)),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)}else r.reply(500,"Missing Contact header field")}).prototype=Object.create({},{reject:{writable:!0,value:function(t){if(this.status===c.STATUS_TERMINATED)throw new e.Exceptions.InvalidStateError(this.status);return this.logger.log("rejecting RTCSession"),e.ServerContext.prototype.reject.call(this,t),this.terminated()}},terminate:{writable:!0,value:function(t){var r,i=((t=t||{}).extraHeaders||[]).slice(),n=t.body,s=this;return this.status===c.STATUS_WAITING_FOR_ACK&&this.request.server_transaction.state!==e.Transactions.C.STATUS_TERMINATED?(r=this.dialog,this.receiveRequest=function(t){t.method===e.C.ACK&&(this.sendRequest(e.C.BYE,{extraHeaders:i,body:n}),r.terminate())},this.request.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_TERMINATED&&this.dialog&&(this.request=new e.OutgoingRequest(e.C.BYE,this.dialog.remote_target,this.ua,{cseq:this.dialog.local_seqnum+=1,call_id:this.dialog.id.call_id,from_uri:this.dialog.local_uri,from_tag:this.dialog.id.local_tag,to_uri:this.dialog.remote_uri,to_tag:this.dialog.id.remote_tag,route_set:this.dialog.route_set},i,n),new e.RequestSender({request:this.request,onRequestTimeout:function(){s.onRequestTimeout()},onTransportError:function(){s.onTransportError()},receiveResponse:function(){}},this.ua).send(),r.terminate())}),this.emit("bye",this.request),this.terminated(),this.dialog=r,this.ua.dialogs[r.id.toString()]=r):this.status===c.STATUS_CONFIRMED?this.bye(t):this.reject(t),this}},progress:{writable:!0,value:function(t){var r,i=(t=t||{}).statusCode||180,n=t.reasonPhrase,s=(t.extraHeaders||[]).slice(),o=t.body;if(i<100||i>199)throw new TypeError("Invalid statusCode: "+i);if(this.isCanceled||this.status===c.STATUS_TERMINATED)return this;function a(){i=t.statusCode||183,this.status=c.STATUS_WAITING_FOR_PRACK,s.push("Contact: "+this.contact),s.push("Require: 100rel"),s.push("RSeq: "+Math.floor(1e4*Math.random())),this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).then(function(t){if(!this.isCanceled&&this.status!==c.STATUS_TERMINATED){this.early_sdp=t.body,this[this.hasOffer?"hasAnswer":"hasOffer"]=!0;var o=e.Timers.T1;this.timers.rel1xxTimer=e.Timers.setTimeout(function r(){this.request.reply(i,null,s,t),o*=2,this.timers.rel1xxTimer=e.Timers.setTimeout(r.bind(this),o)}.bind(this),o),this.timers.prackTimer=e.Timers.setTimeout(function(){this.status===c.STATUS_WAITING_FOR_PRACK&&(this.logger.log("no PRACK received, rejecting the call"),e.Timers.clearTimeout(this.timers.rel1xxTimer),this.request.reply(504),this.terminated(null,e.C.causes.NO_PRACK))}.bind(this),64*e.Timers.T1),r=this.request.reply(i,n,s,t),this.emit("progress",r,n)}}.bind(this),function(){this.request.reply(480),this.failed(null,e.C.causes.WEBRTC_ERROR),this.terminated(null,e.C.causes.WEBRTC_ERROR)}.bind(this))}return 100!==t.statusCode&&(this.rel100===e.C.supported.REQUIRED||this.rel100===e.C.supported.SUPPORTED&&t.rel100||this.rel100===e.C.supported.SUPPORTED&&this.ua.configuration.rel100===e.C.supported.REQUIRED)?(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(this.request.getHeader("Content-Type"))?(this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(this.request.body,t.sessionDescriptionHandlerOptions,t.modifiers).then(a.apply(this)).catch(function(t){this.logger.warn("invalid description"),this.logger.warn(t),this.failed(null,e.C.causes.WEBRTC_ERROR),this.terminated(null,e.C.causes.WEBRTC_ERROR)}.bind(this))):a.apply(this)):function(){r=this.request.reply(i,n,s,o),this.emit("progress",r,n)}.apply(this),this}},accept:{writable:!0,value:function(t){t=t||{},this.onInfo=t.onInfo;var r=this,i=this.request,n=(t.extraHeaders||[]).slice(),s=function(t){var s;n.push("Contact: "+r.contact),n.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),r.hasOffer?r.hasAnswer=!0:r.hasOffer=!0,s=i.reply(200,null,n,t,function(){r.status=c.STATUS_WAITING_FOR_ACK,r.setInvite2xxTimer(i,t),r.setACKTimer()},function(){r.failed(null,e.C.causes.CONNECTION_ERROR),r.terminated(null,e.C.causes.CONNECTION_ERROR)}),r.status!==c.STATUS_TERMINATED&&r.accepted(s,e.Utils.getReasonPhrase(200))},o=function(){r.status!==c.STATUS_TERMINATED&&(r.request.reply(480),r.failed(null,e.C.causes.WEBRTC_ERROR),r.terminated(null,e.C.causes.WEBRTC_ERROR))};if(this.status===c.STATUS_WAITING_FOR_PRACK)return this.status=c.STATUS_ANSWERED_WAITING_FOR_PRACK,this;if(this.status===c.STATUS_WAITING_FOR_ANSWER)this.status=c.STATUS_ANSWERED;else if(this.status!==c.STATUS_EARLY_MEDIA)throw new e.Exceptions.InvalidStateError(this.status);if(!this.createDialog(i,"UAS"))return i.reply(500,"Missing Contact header field"),this;if(e.Timers.clearTimeout(this.timers.userNoAnswerTimer),this.status===c.STATUS_EARLY_MEDIA)s({});else if(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),"0"!==this.request.getHeader("Content-Length")||this.request.getHeader("Content-Type")){if(!this.sessionDescriptionHandler.hasDescription(this.request.getHeader("Content-Type")))return void this.request.reply(415);this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(this.request.body,t.sessionDescriptionHandlerOptions,t.modifiers).then(function(){return this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers)}.bind(this)).catch(o).then(s)}else this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).catch(o).then(s);return this}},receiveRequest:{writable:!0,value:function(r){function i(){var t,i;e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,t=r.getHeader("Content-Type"),(i=r.getHeader("Content-Disposition"))&&"render"===i.type&&(this.renderbody=r.body,this.rendertype=t),this.emit("confirmed",r)}switch(r.method){case e.C.CANCEL:this.status!==c.STATUS_WAITING_FOR_ANSWER&&this.status!==c.STATUS_WAITING_FOR_PRACK&&this.status!==c.STATUS_ANSWERED_WAITING_FOR_PRACK&&this.status!==c.STATUS_EARLY_MEDIA&&this.status!==c.STATUS_ANSWERED||(this.status=c.STATUS_CANCELED,this.request.reply(487),this.canceled(r),this.rejected(r,e.C.causes.CANCELED),this.failed(r,e.C.causes.CANCELED),this.terminated(r,e.C.causes.CANCELED));break;case e.C.ACK:this.status===c.STATUS_WAITING_FOR_ACK&&(this.sessionDescriptionHandler.hasDescription(r.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(r.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(i.bind(this),function(t){this.logger.warn(t),this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(r,e.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(r,e.C.causes.BAD_MEDIA_DESCRIPTION)}.bind(this))):i.apply(this));break;case e.C.PRACK:this.status===c.STATUS_WAITING_FOR_PRACK||this.status===c.STATUS_ANSWERED_WAITING_FOR_PRACK?this.hasAnswer?(e.Timers.clearTimeout(this.timers.rel1xxTimer),e.Timers.clearTimeout(this.timers.prackTimer),r.reply(200),this.status===c.STATUS_ANSWERED_WAITING_FOR_PRACK&&(this.status=c.STATUS_EARLY_MEDIA,this.accept()),this.status=c.STATUS_EARLY_MEDIA):(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(r.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(r.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){e.Timers.clearTimeout(this.timers.rel1xxTimer),e.Timers.clearTimeout(this.timers.prackTimer),r.reply(200),this.status===c.STATUS_ANSWERED_WAITING_FOR_PRACK&&(this.status=c.STATUS_EARLY_MEDIA,this.accept()),this.status=c.STATUS_EARLY_MEDIA}.bind(this),function(t){this.logger.warn(t),this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(r,e.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(r,e.C.causes.BAD_MEDIA_DESCRIPTION)}.bind(this))):(this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(r,e.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(r,e.C.causes.BAD_MEDIA_DESCRIPTION))):this.status===c.STATUS_EARLY_MEDIA&&r.reply(200);break;default:t.prototype.receiveRequest.apply(this,[r])}}},setupSessionDescriptionHandler:{writable:!0,value:function(){return this.sessionDescriptionHandler?this.sessionDescriptionHandler:this.sessionDescriptionHandlerFactory(this,this.ua.configuration.sessionDescriptionHandlerFactoryOptions)}},onTransportError:{writable:!0,value:function(){this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)}},onRequestTimeout:{writable:!0,value:function(){this.status===c.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==c.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))}}}),e.InviteServerContext=i,(n=function(t,r,i,n){i=i||{},this.passedOptions=i,i.params=Object.create(i.params||Object.prototype);var s=(i.extraHeaders||[]).slice(),o=t.configuration.sessionDescriptionHandlerFactory;if(this.sessionDescriptionHandlerFactoryOptions=t.configuration.sessionDescriptionHandlerFactoryOptions||{},this.sessionDescriptionHandlerOptions=i.sessionDescriptionHandlerOptions||{},this.modifiers=n,this.inviteWithoutSdp=i.inviteWithoutSdp||!1,this.anonymous=i.anonymous||!1,this.renderbody=i.renderbody||null,this.rendertype=i.rendertype||"text/plain",this.from_tag=e.Utils.newTag(),i.params.from_tag=this.from_tag,this.contact=t.contact.toString({anonymous:this.anonymous,outbound:this.anonymous?!t.contact.temp_gruu:!t.contact.pub_gruu}),this.anonymous&&(i.params.from_displayName="Anonymous",i.params.from_uri="sip:anonymous@anonymous.invalid",s.push("P-Preferred-Identity: "+t.configuration.uri.toString()),s.push("Privacy: id")),s.push("Contact: "+this.contact),s.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.inviteWithoutSdp&&this.renderbody&&(s.push("Content-Type: "+this.rendertype),s.push("Content-Disposition: render;handling=optional")),t.configuration.rel100===e.C.supported.REQUIRED&&s.push("Require: 100rel"),t.configuration.replaces===e.C.supported.REQUIRED&&s.push("Require: replaces"),i.extraHeaders=s,e.Utils.augment(this,e.ClientContext,[t,e.C.INVITE,r,i]),e.Utils.augment(this,e.Session,[o]),this.status!==c.STATUS_NULL)throw new e.Exceptions.InvalidStateError(this.status);this.isCanceled=!1,this.received_100=!1,this.method=e.C.INVITE,this.receiveNonInviteResponse=this.receiveResponse,this.receiveResponse=this.receiveInviteResponse,this.logger=t.getLogger("sip.inviteclientcontext"),t.applicants[this]=this,this.id=this.request.call_id+this.from_tag,this.onInfo=i.onInfo,this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)}).prototype=Object.create({},{invite:{writable:!0,value:function(){var t=this;return this.ua.sessions[this.id]=this,e.Utils.Promise.resolve().then(function(){this.inviteWithoutSdp?(this.request.body=t.renderbody,this.status=c.STATUS_INVITE_SENT,this.send()):(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.getDescription(this.sessionDescriptionHandlerOptions,this.modifiers).then(function(e){t.isCanceled||t.status===c.STATUS_TERMINATED||(t.hasOffer=!0,t.request.body=e,t.status=c.STATUS_INVITE_SENT,t.send())},function(){t.status!==c.STATUS_TERMINATED&&(t.failed(null,e.C.causes.WEBRTC_ERROR),t.terminated(null,e.C.causes.WEBRTC_ERROR))}))}.bind(this)),this}},receiveInviteResponse:{writable:!0,value:function(t){var r,i=this,n=t.call_id+t.from_tag+t.to_tag,s=[],o={};if(this.status!==c.STATUS_TERMINATED&&t.method===e.C.INVITE){if(this.dialog&&t.status_code>=200&&t.status_code<=299){if(n!==this.dialog.id.toString()){if(!this.createDialog(t,"UAC",!0))return;return this.emit("ack",t.transaction.sendACK({body:e.Utils.generateFakeSDP(t.body)})),this.earlyDialogs[n].sendRequest(this,e.C.BYE),void(this.status!==c.STATUS_CONFIRMED&&(this.failed(t,e.C.causes.WEBRTC_ERROR),this.terminated(t,e.C.causes.WEBRTC_ERROR)))}if(this.status===c.STATUS_CONFIRMED)return void this.emit("ack",t.transaction.sendACK());if(!this.hasAnswer)return}if(this.dialog&&t.status_code<200){if(-1!==this.dialog.pracked.indexOf(t.getHeader("rseq"))||this.dialog.pracked[this.dialog.pracked.length-1]>=t.getHeader("rseq")&&this.dialog.pracked.length>0)return;if(!this.earlyDialogs[n]&&!this.createDialog(t,"UAC",!0))return;if(-1!==this.earlyDialogs[n].pracked.indexOf(t.getHeader("rseq"))||this.earlyDialogs[n].pracked[this.earlyDialogs[n].pracked.length-1]>=t.getHeader("rseq")&&this.earlyDialogs[n].pracked.length>0)return;return s.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),this.earlyDialogs[n].pracked.push(t.getHeader("rseq")),void this.earlyDialogs[n].sendRequest(this,e.C.PRACK,{extraHeaders:s,body:e.Utils.generateFakeSDP(t.body)})}if(this.isCanceled)t.status_code>=100&&t.status_code<200?(this.request.cancel(this.cancelReason,s),this.canceled(null)):t.status_code>=200&&t.status_code<299?(this.acceptAndTerminate(t),this.emit("bye",this.request)):t.status_code>=300&&(r=e.C.REASON_PHRASE[t.status_code]||e.C.causes.CANCELED,this.rejected(t,r),this.failed(t,r),this.terminated(t,r));else switch(!0){case/^100$/.test(t.status_code):this.received_100=!0,this.emit("progress",t);break;case/^1[0-9]{2}$/.test(t.status_code):if(!t.to_tag){this.logger.warn("1xx response received without to tag");break}if(t.hasHeader("contact")&&!this.createDialog(t,"UAC",!0))break;if(this.status=c.STATUS_1XX_RECEIVED,t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),t.hasHeader("require")&&-1!==t.getHeader("require").indexOf("100rel")){if(this.dialog||!this.earlyDialogs[n])break;if(-1!==this.earlyDialogs[n].pracked.indexOf(t.getHeader("rseq"))||this.earlyDialogs[n].pracked[this.earlyDialogs[n].pracked.length-1]>=t.getHeader("rseq")&&this.earlyDialogs[n].pracked.length>0)return;if(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type")))if(this.hasOffer){if(!this.createDialog(t,"UAC"))break;this.hasAnswer=!0,this.dialog.pracked.push(t.getHeader("rseq")),this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){s.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),i.sendRequest(e.C.PRACK,{extraHeaders:s,receiveResponse:function(){}}),i.status=c.STATUS_EARLY_MEDIA,i.emit("progress",t)},function(r){i.logger.warn(r),i.acceptAndTerminate(t,488,"Not Acceptable Here"),i.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION)})}else{var a=this.earlyDialogs[n],u=a.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions);this.emit("SessionDescriptionHandler-created",u),a.pracked.push(t.getHeader("rseq")),u.setDescription(t.body,i.sessionDescriptionHandlerOptions,i.modifers).then(u.getDescription.bind(u,i.sessionDescriptionHandlerOptions,i.modifiers)).then(function(r){s.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),a.sendRequest(i,e.C.PRACK,{extraHeaders:s,body:r}),i.status=c.STATUS_EARLY_MEDIA,i.emit("progress",t)}).catch(function(r){if(r instanceof e.Exceptions.SessionDescriptionHandlerError){if(a.pracked.push(t.getHeader("rseq")),i.status===c.STATUS_TERMINATED)return;i.failed(null,e.C.causes.WEBRTC_ERROR),i.terminated(null,e.C.causes.WEBRTC_ERROR)}else a.pracked.splice(a.pracked.indexOf(t.getHeader("rseq")),1),i.logger.warn("invalid description"),i.logger.warn(r)})}else s.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),this.earlyDialogs[n].pracked.push(t.getHeader("rseq")),this.earlyDialogs[n].sendRequest(this,e.C.PRACK,{extraHeaders:s}),this.emit("progress",t)}else this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):if(this.request.cseq+" "+this.request.method!==t.getHeader("cseq"))break;if(t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),this.status===c.STATUS_EARLY_MEDIA&&this.dialog){this.status=c.STATUS_CONFIRMED,o={},this.renderbody&&(s.push("Content-Type: "+this.rendertype),o.extraHeaders=s,o.body=this.renderbody),this.emit("ack",t.transaction.sendACK(o)),this.accepted(t);break}if(this.dialog)break;if(this.hasOffer)if(this.hasAnswer)this.renderbody&&(s.push("Content-Type: "+i.rendertype),o.extraHeaders=s,o.body=this.renderbody),this.emit("ack",t.transaction.sendACK(o));else{if(!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.acceptAndTerminate(t,400,"Missing session description"),this.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION);break}if(!this.createDialog(t,"UAC"))break;this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){var e={};i.status=c.STATUS_CONFIRMED,i.renderbody&&(s.push("Content-Type: "+i.rendertype),e.extraHeaders=s,e.body=i.renderbody),i.emit("ack",t.transaction.sendACK(e)),i.accepted(t)},function(r){i.logger.warn(r),i.acceptAndTerminate(t,488,"Not Acceptable Here"),i.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION)})}else if(this.earlyDialogs[n]&&this.earlyDialogs[n].sessionDescriptionHandler){if(this.hasOffer=!0,this.hasAnswer=!0,this.sessionDescriptionHandler=this.earlyDialogs[n].sessionDescriptionHandler,!this.createDialog(t,"UAC"))break;this.status=c.STATUS_CONFIRMED,this.emit("ack",t.transaction.sendACK()),this.accepted(t)}else{if(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.acceptAndTerminate(t,400,"Missing session description"),this.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION);break}if(!this.createDialog(t,"UAC"))break;this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(this.sessionDescriptionHandler.getDescription.bind(this.sessionDescriptionHandler,this.sessionDescriptionHandlerOptions,this.modifiers)).then(function(e){i.isCanceled||i.status===c.STATUS_TERMINATED||(i.status=c.STATUS_CONFIRMED,i.hasAnswer=!0,i.emit("ack",t.transaction.sendACK({body:e})),i.accepted(t))}).catch(function(r){r instanceof e.Exceptions.SessionDescriptionHandlerError&&(i.logger.warn("invalid description"),i.logger.warn(r),i.acceptAndTerminate(t,488,"Invalid session description"),i.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION))})}break;default:r=e.Utils.sipErrorCause(t.status_code),this.rejected(t,r),this.failed(t,r),this.terminated(t,r)}}}},cancel:{writable:!0,value:function(t){if((t=t||{}).extraHeaders=(t.extraHeaders||[]).slice(),this.status===c.STATUS_TERMINATED||this.status===c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.logger.log("canceling RTCSession");var r=e.Utils.getCancelReason(t.status_code,t.reason_phrase);return this.status===c.STATUS_NULL||this.status===c.STATUS_INVITE_SENT&&!this.received_100?(this.isCanceled=!0,this.cancelReason=r):this.status!==c.STATUS_INVITE_SENT&&this.status!==c.STATUS_1XX_RECEIVED&&this.status!==c.STATUS_EARLY_MEDIA||this.request.cancel(r,t.extraHeaders),this.canceled()}},terminate:{writable:!0,value:function(e){return this.status===c.STATUS_TERMINATED?this:(this.status===c.STATUS_WAITING_FOR_ACK||this.status===c.STATUS_CONFIRMED?this.bye(e):this.cancel(e),this)}},receiveRequest:{writable:!0,value:function(r){return r.method,e.C.CANCEL,r.method===e.C.ACK&&this.status===c.STATUS_WAITING_FOR_ACK&&(e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,this.accepted()),t.prototype.receiveRequest.apply(this,[r])}},onTransportError:{writable:!0,value:function(){this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)}},onRequestTimeout:{writable:!0,value:function(){this.status===c.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==c.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))}}}),e.InviteClientContext=n,(o=function(t,r,i,n){if(this.options=n||{},this.extraHeaders=(this.options.extraHeaders||[]).slice(),void 0===t||void 0===r||void 0===i)throw new TypeError("Not enough arguments");if(e.Utils.augment(this,e.ClientContext,[t,e.C.REFER,r.remoteIdentity.uri.toString(),n]),this.applicant=r,i instanceof e.InviteServerContext||i instanceof e.InviteClientContext)this.target='"'+i.remoteIdentity.friendlyName+'" <'+i.dialog.remote_target.toString()+"?Replaces="+i.dialog.id.call_id+"%3Bto-tag%3D"+i.dialog.id.remote_tag+"%3Bfrom-tag%3D"+i.dialog.id.local_tag+">";else{try{this.target=e.Grammar.parse(i,"Refer_To").uri||i}catch(e){this.logger.debug(".refer() cannot parse Refer_To from",i),this.logger.debug("...falling through to normalizeTarget()")}if(this.target=this.ua.normalizeTarget(this.target),!this.target)throw new TypeError("Invalid target: "+i)}this.ua&&this.extraHeaders.push("Referred-By: <"+this.ua.configuration.uri+">"),this.extraHeaders.push("Contact: "+r.contact),this.extraHeaders.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.extraHeaders.push("Refer-To: "+this.target),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)}).prototype=Object.create({},{refer:{writable:!0,value:function(t){t=t||{};var r=(this.extraHeaders||[]).slice();return t.extraHeaders&&r.concat(t.extraHeaders),this.applicant.sendRequest(e.C.REFER,{extraHeaders:this.extraHeaders,receiveResponse:function(e){/^1[0-9]{2}$/.test(e.status_code)?this.emit("referRequestProgress",this):/^2[0-9]{2}$/.test(e.status_code)?this.emit("referRequestAccepted",this):/^[4-6][0-9]{2}$/.test(e.status_code)&&this.emit("referRequestRejected",this),t.receiveResponse&&t.receiveResponse(e)}.bind(this)}),this}},receiveNotify:{writable:!0,value:function(t){if(t.hasHeader("Content-Type")&&-1!==t.getHeader("Content-Type").search(/^message\/sipfrag/)){var r=e.Grammar.parse(t.body,"sipfrag");if(-1===r)return void t.reply(489,"Bad Event");switch(!0){case/^1[0-9]{2}$/.test(r.status_code):this.emit("referProgress",this);break;case/^2[0-9]{2}$/.test(r.status_code):this.emit("referAccepted",this),!this.options.activeAfterTransfer&&this.applicant.terminate&&this.applicant.terminate();break;default:this.emit("referRejected",this)}return t.reply(200),void this.emit("notify",t)}t.reply(489,"Bad Event")}}}),e.ReferClientContext=o,(s=function(t,r){if(e.Utils.augment(this,e.ServerContext,[t,r]),this.ua=t,this.status=c.STATUS_INVITE_RECEIVED,this.from_tag=r.from_tag,this.id=r.call_id+this.from_tag,this.request=r,this.contact=this.ua.contact.toString(),this.logger=t.getLogger("sip.referservercontext",this.id),!this.request.hasHeader("refer-to"))return this.logger.warn("Invalid REFER packet. A refer-to header is required. Rejecting refer."),void this.reject();this.referTo=this.request.parseHeader("refer-to"),this.referredSession=this.ua.findSession(r),this.cseq=Math.floor(1e4*Math.random()),this.call_id=this.request.call_id,this.from_uri=this.request.to.uri,this.from_tag=this.request.to.parameters.tag,this.remote_target=this.request.headers.Contact[0].parsed.uri,this.to_uri=this.request.from.uri,this.to_tag=this.request.from_tag,this.route_set=this.request.getHeaders("record-route"),this.receiveNonInviteResponse=function(){},this.request.hasHeader("referred-by")&&(this.referredBy=this.request.getHeader("referred-by")),this.referTo.uri.hasHeader("replaces")&&(this.replaces=this.referTo.uri.getHeader("replaces")),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener),this.status=c.STATUS_WAITING_FOR_ANSWER}).prototype=Object.create({},{progress:{writable:!0,value:function(){if(this.status!==c.STATUS_WAITING_FOR_ANSWER)throw new e.Exceptions.InvalidStateError(this.status);this.request.reply(100)}},reject:{writable:!0,value:function(t){if(this.status===c.STATUS_TERMINATED)throw new e.Exceptions.InvalidStateError(this.status);this.logger.log("Rejecting refer"),this.status=c.STATUS_TERMINATED,e.ServerContext.prototype.reject.call(this,t),this.emit("referRequestRejected",this)}},accept:{writable:!0,value:function(t,r){if(t=t||{},this.status!==c.STATUS_WAITING_FOR_ANSWER)throw new e.Exceptions.InvalidStateError(this.status);if(this.status=c.STATUS_ANSWERED,this.request.reply(202,"Accepted"),this.emit("referRequestAccepted",this),t.followRefer){this.logger.log("Accepted refer, attempting to automatically follow it");var i=this.referTo.uri;if(!i.scheme.match("^sips?$"))return this.logger.error("SIP.js can only automatically follow SIP refer target"),void this.reject();var n=t.inviteOptions||{},s=(n.extraHeaders||[]).slice();this.replaces&&s.push("Replaces: "+decodeURIComponent(this.replaces)),this.referredBy&&s.push("Referred-By: "+this.referredBy),n.extraHeaders=s,i.clearHeaders(),this.targetSession=this.ua.invite(i,n,r),this.emit("referInviteSent",this),this.targetSession.once("progress",function(){this.sendNotify("SIP/2.0 100 Trying"),this.emit("referProgress",this),this.referredSession&&this.referredSession.emit("referProgress",this)}.bind(this)),this.targetSession.once("accepted",function(){this.logger.log("Successfully followed the refer"),this.sendNotify("SIP/2.0 200 OK"),this.emit("referAccepted",this),this.referredSession&&this.referredSession.emit("referAccepted",this)}.bind(this));var o=function(e){if(this.status!==c.STATUS_TERMINATED){if(this.logger.log("Refer was not successful. Resuming session"),e&&429===e.status_code)return this.logger.log("Alerting referrer that identity is required."),void this.sendNotify("SIP/2.0 429 Provide Referrer Identity");this.sendNotify("SIP/2.0 603 Declined"),this.status=c.STATUS_TERMINATED,this.emit("referRejected",this),this.referredSession&&this.referredSession.emit("referRejected")}};this.targetSession.once("rejected",o.bind(this)),this.targetSession.once("failed",o.bind(this))}else this.logger.log("Accepted refer, but did not automatically follow it"),this.sendNotify("SIP/2.0 200 OK"),this.emit("referAccepted",this),this.referredSession&&this.referredSession.emit("referAccepted",this)}},sendNotify:{writable:!0,value:function(t){if(this.status!==c.STATUS_ANSWERED)throw new e.Exceptions.InvalidStateError(this.status);if(-1===e.Grammar.parse(t,"sipfrag"))throw new Error("sipfrag body is required to send notify for refer");var r=new e.OutgoingRequest(e.C.NOTIFY,this.remote_target,this.ua,{cseq:this.cseq+=1,call_id:this.call_id,from_uri:this.from_uri,from_tag:this.from_tag,to_uri:this.to_uri,to_tag:this.to_tag,route_set:this.route_set},["Event: refer","Subscription-State: terminated","Content-Type: message/sipfrag"],t);new e.RequestSender({request:r,onRequestTimeout:function(){},onTransportError:function(){},receiveResponse:function(){}},this.ua).send()}}}),e.ReferServerContext=s}},function(e,t,r){e.exports=function(e){var t;return(t=function(r,i,n){var s,o;if(void 0===i)throw new TypeError("Not enough arguments");if(this.logger=r.ua.getLogger("sip.invitecontext.dtmf",r.id),this.owner=r,this.direction=null,s=(n=n||{}).duration||null,o=n.interToneGap||null,"string"==typeof i)i=i.toUpperCase();else{if("number"!=typeof i)throw new TypeError("Invalid tone: "+i);i=i.toString()}if(!i.match(/^[0-9A-D#*]$/))throw new TypeError("Invalid tone: "+i);if(this.tone=i,s&&!e.Utils.isDecimal(s))throw new TypeError("Invalid tone duration: "+s);if(s?s<t.C.MIN_DURATION?(this.logger.warn('"duration" value is lower than the minimum allowed, setting it to '+t.C.MIN_DURATION+" milliseconds"),s=t.C.MIN_DURATION):s>t.C.MAX_DURATION?(this.logger.warn('"duration" value is greater than the maximum allowed, setting it to '+t.C.MAX_DURATION+" milliseconds"),s=t.C.MAX_DURATION):s=Math.abs(s):s=t.C.DEFAULT_DURATION,this.duration=s,o&&!e.Utils.isDecimal(o))throw new TypeError("Invalid interToneGap: "+o);o?o<t.C.MIN_INTER_TONE_GAP?(this.logger.warn('"interToneGap" value is lower than the minimum allowed, setting it to '+t.C.MIN_INTER_TONE_GAP+" milliseconds"),o=t.C.MIN_INTER_TONE_GAP):o=Math.abs(o):o=t.C.DEFAULT_INTER_TONE_GAP,this.interToneGap=o}).prototype=Object.create(e.EventEmitter.prototype),t.prototype.send=function(t){var r,i={};if(this.direction="outgoing",this.owner.status!==e.Session.C.STATUS_CONFIRMED&&this.owner.status!==e.Session.C.STATUS_WAITING_FOR_ACK)throw new e.Exceptions.InvalidStateError(this.owner.status);r=(t=t||{}).extraHeaders?t.extraHeaders.slice():[],i.contentType="application/dtmf-relay",i.body="Signal= "+this.tone+"\r\n",i.body+="Duration= "+this.duration,this.request=this.owner.dialog.sendRequest(this,e.C.INFO,{extraHeaders:r,body:i}),this.owner.emit("dtmf",this.request,this)},t.prototype.receiveResponse=function(t){var r;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):this.emit("succeeded",{originator:"remote",response:t});break;default:r=e.Utils.sipErrorCause(t.status_code),this.emit("failed",t,r)}},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT),this.owner.onRequestTimeout()},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR),this.owner.onTransportError()},t.prototype.onDialogError=function(t){this.emit("failed",t,e.C.causes.DIALOG_ERROR),this.owner.onDialogError(t)},t.prototype.init_incoming=function(e){this.direction="incoming",this.request=e,e.reply(200),this.tone&&this.duration?this.owner.emit("dtmf",e,this):this.logger.warn("invalid INFO DTMF received, discarded")},t.C={MIN_DURATION:70,MAX_DURATION:6e3,DEFAULT_DURATION:100,MIN_INTER_TONE_GAP:50,DEFAULT_INTER_TONE_GAP:500},t}},function(e,t,r){e.exports=function(e){e.Subscription=function(t,r,i,n){if(n=Object.create(n||Object.prototype),this.extraHeaders=n.extraHeaders=(n.extraHeaders||[]).slice(),this.id=null,this.state="init",!i)throw new TypeError("Event necessary to create a subscription.");this.event=i,"number"!=typeof n.expires?(t.logger.warn("expires must be a number. Using default of 3600."),this.expires=3600):this.expires=n.expires,this.requestedExpires=this.expires,n.extraHeaders.push("Event: "+this.event),n.extraHeaders.push("Expires: "+this.expires),n.body&&(this.body=n.body),this.contact=t.contact.toString(),n.extraHeaders.push("Contact: "+this.contact),n.extraHeaders.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),e.Utils.augment(this,e.ClientContext,[t,e.C.SUBSCRIBE,r,n]),this.logger=t.getLogger("sip.subscription"),this.dialog=null,this.timers={N:null,sub_duration:null},this.errorCodes=[404,405,410,416,480,481,482,483,484,485,489,501,604]},e.Subscription.prototype={subscribe:function(){return"active"===this.state?(this.refresh(),this):"notify_wait"===this.state?this:(e.Timers.clearTimeout(this.timers.sub_duration),e.Timers.clearTimeout(this.timers.N),this.timers.N=e.Timers.setTimeout(this.timer_fire.bind(this),e.Timers.TIMER_N),this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event]=this,this.send(),this.state="notify_wait",this)},refresh:function(){"terminated"!==this.state&&"pending"!==this.state&&"notify_wait"!==this.state&&this.dialog.sendRequest(this,e.C.SUBSCRIBE,{extraHeaders:this.extraHeaders,body:this.body})},receiveResponse:function(t){var r,i=e.Utils.getReasonPhrase(t.status_code);"notify_wait"===this.state&&t.status_code>=300||"notify_wait"!==this.state&&-1!==this.errorCodes.indexOf(t.status_code)?this.failed(t,null):/^2[0-9]{2}$/.test(t.status_code)?(this.emit("accepted",t,i),(r=t.getHeader("Expires"))&&r<=this.requestedExpires?(this.expires=r,this.timers.sub_duration=e.Timers.setTimeout(this.refresh.bind(this),900*r)):r?(this.logger.warn("Expires header in a 200-class response to SUBSCRIBE with a higher value than the one in the request"),this.failed(t,e.C.INVALID_EXPIRES_HEADER)):(this.logger.warn("Expires header missing in a 200-class response to SUBSCRIBE"),this.failed(t,e.C.EXPIRES_HEADER_MISSING))):t.statusCode>300&&(this.emit("failed",t,i),this.emit("rejected",t,i))},unsubscribe:function(){var t=[];this.state="terminated",t.push("Event: "+this.event),t.push("Expires: 0"),t.push("Contact: "+this.contact),t.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.receiveResponse=function(){},this.dialog.sendRequest(this,this.method,{extraHeaders:t,body:this.body}),e.Timers.clearTimeout(this.timers.sub_duration),e.Timers.clearTimeout(this.timers.N),this.timers.N=e.Timers.setTimeout(this.timer_fire.bind(this),e.Timers.TIMER_N)},timer_fire:function(){"terminated"===this.state?(this.terminateDialog(),e.Timers.clearTimeout(this.timers.N),e.Timers.clearTimeout(this.timers.sub_duration),delete this.ua.subscriptions[this.id]):"notify_wait"===this.state||"pending"===this.state?this.close():this.refresh()},close:function(){"notify_wait"===this.state?(this.state="terminated",e.Timers.clearTimeout(this.timers.N),e.Timers.clearTimeout(this.timers.sub_duration),this.receiveResponse=function(){},delete this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event]):"terminated"!==this.state&&this.unsubscribe()},createConfirmedDialog:function(t,r){var i;return this.terminateDialog(),(i=new e.Dialog(this,t,r)).invite_seqnum=this.request.cseq,i.local_seqnum=this.request.cseq,!i.error&&(this.dialog=i,!0)},terminateDialog:function(){this.dialog&&(delete this.ua.subscriptions[this.id],this.dialog.terminate(),delete this.dialog)},receiveRequest:function(t){var r,i=this;function n(){r.expires&&(e.Timers.clearTimeout(i.timers.sub_duration),r.expires=Math.min(i.expires,Math.max(r.expires,0)),i.timers.sub_duration=e.Timers.setTimeout(i.refresh.bind(i),900*r.expires))}if(this.matchEvent(t))if(this.dialog||this.createConfirmedDialog(t,"UAS")&&(this.id=this.dialog.id.toString(),delete this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event],this.ua.subscriptions[this.id]=this),r=t.parseHeader("Subscription-State"),t.reply(200,e.C.REASON_200),e.Timers.clearTimeout(this.timers.N),this.emit("notify",{request:t}),"terminated"!==this.state)switch(r.state){case"active":this.state="active",n();break;case"pending":"notify_wait"===this.state&&n(),this.state="pending";break;case"terminated":if(e.Timers.clearTimeout(this.timers.sub_duration),r.reason)switch(this.logger.log("terminating subscription with reason "+r.reason),r.reason){case"deactivated":case"timeout":return void this.subscribe();case"probation":case"giveup":return void(r.params&&r.params["retry-after"]?this.timers.sub_duration=e.Timers.setTimeout(i.subscribe.bind(i),r.params["retry-after"]):this.subscribe())}this.close()}else"terminated"===r.state&&(this.terminateDialog(),e.Timers.clearTimeout(this.timers.N),e.Timers.clearTimeout(this.timers.sub_duration),delete this.ua.subscriptions[this.id]);else t.reply(489)},failed:function(e,t){return this.close(),this.emit("failed",e,t),this.emit("rejected",e,t),this},onDialogError:function(t){this.failed(t,e.C.causes.DIALOG_ERROR)},matchEvent:function(e){var t;return e.hasHeader("Event")?e.hasHeader("Subscription-State")?(t=e.parseHeader("event").event,this.event===t||(this.logger.warn("event match failed"),e.reply(481,"Event Match Failed"),!1)):(this.logger.warn("missing Subscription-State header"),!1):(this.logger.warn("missing Event header"),!1)}}}},function(e,t,r){e.exports=function(e){var t;((t=function(t,r,i,n){if(this.options=n=n||{},this.options.extraHeaders=(n.extraHeaders||[]).slice(),this.options.contentType=n.contentType||"text/plain","number"!=typeof n.expires||n.expires%1!=0?this.options.expires=3600:this.options.expires=Number(n.expires),"boolean"!=typeof n.unpublishOnClose?this.options.unpublishOnClose=!0:this.options.unpublishOnClose=n.unpublishOnClose,null==r||""===r)throw new e.Exceptions.MethodParameterError("Publish","Target",r);if(this.target=t.normalizeTarget(r),null==i||""===i)throw new e.Exceptions.MethodParameterError("Publish","Event",i);this.event=i,e.ClientContext.call(this,t,e.C.PUBLISH,this.target,this.options),this.logger=this.ua.getLogger("sip.publish"),this.pubRequestBody=null,this.pubRequestExpires=this.options.expires,this.pubRequestEtag=null,this.publish_refresh_timer=null,t.on("transportCreated",function(e){e.on("transportError",this.onTransportError.bind(this))}.bind(this))}).prototype=Object.create(e.ClientContext.prototype)).constructor=t,t.prototype.publish=function(t){if(this.request=null,e.Timers.clearTimeout(this.publish_refresh_timer),null!=t&&""!==t)this.options.body=t,this.pubRequestBody=this.options.body,0===this.pubRequestExpires&&(this.pubRequestExpires=this.options.expires,this.pubRequestEtag=null),this.ua.publishers[this.target.toString()+":"+this.event]||(this.ua.publishers[this.target.toString()+":"+this.event]=this);else{if(this.pubRequestBody=null,null===this.pubRequestEtag)throw new e.Exceptions.MethodParameterError("Publish","Body",t);if(0===this.pubRequestExpires)throw new e.Exceptions.MethodParameterError("Publish","Expire",this.pubRequestExpires)}this.sendPublishRequest()},t.prototype.unpublish=function(){this.request=null,e.Timers.clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestExpires=0,null!==this.pubRequestEtag&&this.sendPublishRequest()},t.prototype.close=function(){this.options.unpublishOnClose?this.unpublish():(this.request=null,e.Timers.clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestExpires=0,this.pubRequestEtag=null),this.ua.publishers[this.target.toString()+":"+this.event]&&delete this.ua.publishers[this.target.toString()+":"+this.event]},t.prototype.sendPublishRequest=function(){var t;(t=Object.create(this.options||Object.prototype)).extraHeaders=(this.options.extraHeaders||[]).slice(),t.extraHeaders.push("Event: "+this.event),t.extraHeaders.push("Expires: "+this.pubRequestExpires),null!==this.pubRequestEtag&&t.extraHeaders.push("SIP-If-Match: "+this.pubRequestEtag),this.request=new e.OutgoingRequest(e.C.PUBLISH,this.target,this.ua,this.options.params,t.extraHeaders),null!==this.pubRequestBody&&(this.request.body={},this.request.body.body=this.pubRequestBody,this.request.body.contentType=this.options.contentType),this.send()},t.prototype.receiveResponse=function(t){var r,i,n=e.Utils.getReasonPhrase(t.status_code);switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t,n);break;case/^2[0-9]{2}$/.test(t.status_code):t.hasHeader("SIP-ETag")?this.pubRequestEtag=t.getHeader("SIP-ETag"):this.logger.warn("SIP-ETag header missing in a 200-class response to PUBLISH"),t.hasHeader("Expires")?"number"==typeof(r=Number(t.getHeader("Expires")))&&r>=0&&r<=this.pubRequestExpires?this.pubRequestExpires=r:this.logger.warn("Bad Expires header in a 200-class response to PUBLISH"):this.logger.warn("Expires header missing in a 200-class response to PUBLISH"),0!==this.pubRequestExpires?(this.publish_refresh_timer=e.Timers.setTimeout(this.publish.bind(this),900*this.pubRequestExpires),this.emit("published",t,n)):this.emit("unpublished",t,n);break;case/^412$/.test(t.status_code):null!==this.pubRequestEtag&&0!==this.pubRequestExpires?(this.logger.warn("412 response to PUBLISH, recovering"),this.pubRequestEtag=null,this.emit("progress",t,n),this.publish(this.options.body)):(this.logger.warn("412 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.emit("failed",t,n),this.emit("unpublished",t,n));break;case/^423$/.test(t.status_code):0!==this.pubRequestExpires&&t.hasHeader("Min-Expires")?"number"==typeof(i=Number(t.getHeader("Min-Expires")))||i>this.pubRequestExpires?(this.logger.warn("423 code in response to PUBLISH, adjusting the Expires value and trying to recover"),this.pubRequestExpires=i,this.emit("progress",t,n),this.publish(this.options.body)):(this.logger.warn("Bad 423 response Min-Expires header received for PUBLISH"),this.pubRequestExpires=0,this.emit("failed",t,n),this.emit("unpublished",t,n)):(this.logger.warn("423 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.emit("failed",t,n),this.emit("unpublished",t,n));break;default:this.pubRequestExpires=0,this.emit("failed",t,n),this.emit("unpublished",t,n)}0===this.pubRequestExpires&&(e.Timers.clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestEtag=null)},t.prototype.onRequestTimeout=function(){e.ClientContext.prototype.onRequestTimeout.call(this),this.emit("unpublished",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){e.ClientContext.prototype.onTransportError.call(this),this.emit("unpublished",null,e.C.causes.CONNECTION_ERROR)},e.PublishContext=t}},function(e,t,r){(function(t){var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};e.exports=function(e,n){var s,o={STATUS_INIT:0,STATUS_STARTING:1,STATUS_READY:2,STATUS_USER_CLOSED:3,STATUS_NOT_READY:4,CONFIGURATION_ERROR:1,NETWORK_ERROR:2,ALLOWED_METHODS:["ACK","CANCEL","INVITE","MESSAGE","BYE","OPTIONS","INFO","NOTIFY","REFER"],ACCEPTED_BODY_TYPES:["application/sdp","application/dtmf-relay"],MAX_FORWARDS:70,TAG_LENGTH:10};function a(t){if(t instanceof Function)return t.initialize||(t.initialize=function(){return e.Utils.Promise.resolve()}),t}((s=function(t){var r=this;function i(e){return r.emit.bind(r,e)}o.ACCEPTED_BODY_TYPES=o.ACCEPTED_BODY_TYPES.toString(),this.log=new e.LoggerFactory,this.logger=this.getLogger("sip.ua"),this.cache={credentials:{}},this.configuration={},this.dialogs={},this.applicants={},this.data={},this.sessions={},this.subscriptions={},this.earlySubscriptions={},this.publishers={},this.transport=null,this.contact=null,this.status=o.STATUS_INIT,this.error=null,this.transactions={nist:{},nict:{},ist:{},ict:{}},Object.defineProperties(this,{transactionsCount:{get:function(){var e,t=["nist","nict","ist","ict"],r=0;for(e in t)r+=Object.keys(this.transactions[t[e]]).length;return r}},nictTransactionsCount:{get:function(){return Object.keys(this.transactions.nict).length}},nistTransactionsCount:{get:function(){return Object.keys(this.transactions.nist).length}},ictTransactionsCount:{get:function(){return Object.keys(this.transactions.ict).length}},istTransactionsCount:{get:function(){return Object.keys(this.transactions.ist).length}}}),void 0===t?t={}:("string"==typeof t||t instanceof String)&&(t={uri:t}),t.log&&(t.log.hasOwnProperty("builtinEnabled")&&(this.log.builtinEnabled=t.log.builtinEnabled),t.log.hasOwnProperty("level")&&(this.log.level=t.log.level),t.log.hasOwnProperty("connector")&&(this.log.connector=t.log.connector));try{this.loadConfig(t)}catch(e){throw this.status=o.STATUS_NOT_READY,this.error=o.CONFIGURATION_ERROR,e}this.registerContext=new e.RegisterContext(this),this.registerContext.on("failed",i("registrationFailed")),this.registerContext.on("registered",i("registered")),this.registerContext.on("unregistered",i("unregistered")),this.configuration.autostart&&this.start()}).prototype=Object.create(e.EventEmitter.prototype)).register=function(e){return this.configuration.register=!0,this.registerContext.register(e),this},s.prototype.unregister=function(e){this.configuration.register=!1;var t=this.registerContext;return this.transport.afterConnected(t.unregister.bind(t,e)),this},s.prototype.isRegistered=function(){return this.registerContext.registered},s.prototype.invite=function(t,r,i){var n=new e.InviteClientContext(this,t,r,i);return this.transport.afterConnected(function(){n.invite(),this.emit("inviteSent",n)}.bind(this)),n},s.prototype.subscribe=function(t,r,i){var n=new e.Subscription(this,t,r,i);return this.transport.afterConnected(n.subscribe.bind(n)),n},s.prototype.publish=function(t,r,i,n){var s=new e.PublishContext(this,t,r,n);return this.transport.afterConnected(s.publish.bind(s,i)),s},s.prototype.message=function(t,r,i){if(void 0===r)throw new TypeError("Not enough arguments");return(i=Object.create(i||Object.prototype)).contentType||(i.contentType="text/plain"),i.body=r,this.request(e.C.MESSAGE,t,i)},s.prototype.request=function(t,r,i){var n=new e.ClientContext(this,t,r,i);return this.transport.afterConnected(n.send.bind(n)),n},s.prototype.stop=function(){var e,r,i,s,a=this;if(this.logger.log("user requested closure..."),this.status===o.STATUS_USER_CLOSED)return this.logger.warn("UA already closed"),this;for(e in this.logger.log("closing registerContext"),this.registerContext.close(),this.sessions)this.logger.log("closing session "+e),this.sessions[e].terminate();for(r in this.subscriptions)this.logger.log("unsubscribing from subscription "+r),this.subscriptions[r].close();for(r in this.earlySubscriptions)this.logger.log("unsubscribing from early subscription "+r),this.earlySubscriptions[r].close();for(s in this.publishers)this.logger.log("unpublish "+s),this.publishers[s].close();for(i in this.applicants)this.applicants[i].close();return this.status=o.STATUS_USER_CLOSED,0===this.nistTransactionsCount&&0===this.nictTransactionsCount?this.transport.disconnect():this.on("transactionDestroyed",function e(){0===a.nistTransactionsCount&&0===a.nictTransactionsCount&&(a.removeListener("transactionDestroyed",e),a.transport.disconnect())}),"function"==typeof n.removeEventListener&&(t.chrome&&t.chrome.app&&t.chrome.app.runtime||n.removeEventListener("unload",this.environListener)),this},s.prototype.start=function(){if(this.logger.log("user requested startup..."),this.status===o.STATUS_INIT){if(this.status=o.STATUS_STARTING,!this.configuration.transportConstructor)throw new e.Exceptions.TransportError("Transport constructor not set");this.transport=new this.configuration.transportConstructor(this.getLogger("sip.transport"),this.configuration.transportOptions),this.setTransportListeners(),this.emit("transportCreated",this.transport),this.transport.connect()}else this.status===o.STATUS_USER_CLOSED?(this.logger.log("resuming"),this.status=o.STATUS_READY,this.transport.connect()):this.status===o.STATUS_STARTING?this.logger.log("UA is in STARTING status, not opening new connection"):this.status===o.STATUS_READY?this.logger.log("UA is in READY status, not resuming"):this.logger.error("Connection is down. Auto-Recovery system is trying to connect");return this.configuration.autostop&&"function"==typeof n.addEventListener&&(t.chrome&&t.chrome.app&&t.chrome.app.runtime||(this.environListener=this.stop.bind(this),n.addEventListener("unload",this.environListener))),this},s.prototype.normalizeTarget=function(t){return e.Utils.normalizeTarget(t,this.configuration.hostportParams)},s.prototype.saveCredentials=function(e){return this.cache.credentials[e.realm]=this.cache.credentials[e.realm]||{},this.cache.credentials[e.realm][e.uri]=e,this},s.prototype.getCredentials=function(e){var t,r;return t=e.ruri.host,this.cache.credentials[t]&&this.cache.credentials[t][e.ruri]&&((r=this.cache.credentials[t][e.ruri]).method=e.method),r},s.prototype.getLogger=function(e,t){return this.log.getLogger(e,t)},s.prototype.onTransportError=function(){this.status!==o.STATUS_USER_CLOSED&&(this.error&&this.error===o.NETWORK_ERROR||(this.status=o.STATUS_NOT_READY,this.error=o.NETWORK_ERROR))},s.prototype.setTransportListeners=function(){this.transport.on("connected",this.onTransportConnected.bind(this)),this.transport.on("message",this.onTransportReceiveMsg.bind(this)),this.transport.on("transportError",this.onTransportError.bind(this))},s.prototype.onTransportConnected=function(){this.configuration.register&&this.configuration.authenticationFactory.initialize().then(function(){this.registerContext.onTransportConnected()}.bind(this))},s.prototype.onTransportReceiveMsg=function(t){var r;if(t=e.Parser.parseMessage(t,this),this.status===e.UA.C.STATUS_USER_CLOSED&&t instanceof e.IncomingRequest)this.logger.warn("UA received message when status = USER_CLOSED - aborting");else if(e.sanityCheck(t,this,this.transport))if(t instanceof e.IncomingRequest)t.transport=this.transport,this.receiveRequest(t);else if(t instanceof e.IncomingResponse)switch(t.method){case e.C.INVITE:(r=this.transactions.ict[t.via_branch])&&r.receiveResponse(t);break;case e.C.ACK:break;default:(r=this.transactions.nict[t.via_branch])&&r.receiveResponse(t)}},s.prototype.newTransaction=function(e){this.transactions[e.type][e.id]=e,this.emit("newTransaction",{transaction:e})},s.prototype.destroyTransaction=function(e){delete this.transactions[e.type][e.id],this.emit("transactionDestroyed",{transaction:e})},s.prototype.receiveRequest=function(t){var r,i,n,s,a,c,u=t.method;function d(e){return e&&e.user===t.ruri.user}if(!(d(this.configuration.uri)||d(this.contact.uri)||d(this.contact.pub_gruu)||d(this.contact.temp_gruu)))return this.logger.warn("Request-URI does not point to us"),void(t.method!==e.C.ACK&&t.reply_sl(404));if(t.ruri.scheme!==e.C.SIPS){if(!e.Transactions.checkTransaction(this,t))if(u===e.C.OPTIONS?(new e.Transactions.NonInviteServerTransaction(t,this),t.reply(200,null,["Allow: "+e.UA.C.ALLOWED_METHODS.toString(),"Accept: "+o.ACCEPTED_BODY_TYPES])):u===e.C.MESSAGE?((n=new e.ServerContext(this,t)).body=t.body,n.content_type=t.getHeader("Content-Type")||"text/plain",t.reply(200,null),this.emit("message",n)):u!==e.C.INVITE&&u!==e.C.ACK&&new e.ServerContext(this,t),t.to_tag)(r=this.findDialog(t))?(u===e.C.INVITE&&new e.Transactions.InviteServerTransaction(t,this),r.receiveRequest(t)):u===e.C.NOTIFY?(i=this.findSession(t),s=this.findEarlySubscription(t),i?i.receiveRequest(t):s?s.receiveRequest(t):(this.logger.warn("received NOTIFY request for a non existent session or subscription"),t.reply(481,"Subscription does not exist"))):u!==e.C.ACK&&t.reply(481);else switch(u){case e.C.INVITE:if(a=this.configuration.replaces!==e.C.supported.UNSUPPORTED&&t.parseHeader("replaces")){if(!(c=this.dialogs[a.call_id+a.replaces_to_tag+a.replaces_from_tag]))return void t.reply_sl(481,null);if(c.owner.status===e.Session.C.STATUS_TERMINATED)return void t.reply_sl(603,null);if(c.state===e.Dialog.C.STATUS_CONFIRMED&&a.early_only)return void t.reply_sl(486,null)}(i=new e.InviteServerContext(this,t)).replacee=c&&c.owner,this.emit("invite",i);break;case e.C.BYE:t.reply(481);break;case e.C.CANCEL:(i=this.findSession(t))?i.receiveRequest(t):this.logger.warn("received CANCEL request for a non existent session");break;case e.C.ACK:break;case e.C.NOTIFY:this.configuration.allowLegacyNotifications&&this.listeners("notify").length>0?(t.reply(200,null),this.emit("notify",{request:t})):t.reply(481,"Subscription does not exist");break;case e.C.REFER:if(this.logger.log("Received an out of dialog refer"),this.configuration.allowOutOfDialogRefers){this.logger.log("Allow out of dialog refers is enabled on the UA");var h=new e.ReferServerContext(this,t);this.listeners("outOfDialogReferRequested").length?this.emit("outOfDialogReferRequested",h):(this.logger.log("No outOfDialogReferRequest listeners, automatically accepting and following the out of dialog refer"),h.accept({followRefer:!0}));break}t.reply(405);break;default:t.reply(405)}}else t.reply_sl(416)},s.prototype.findSession=function(e){return this.sessions[e.call_id+e.from_tag]||this.sessions[e.call_id+e.to_tag]||null},s.prototype.findDialog=function(e){return this.dialogs[e.call_id+e.from_tag+e.to_tag]||this.dialogs[e.call_id+e.to_tag+e.from_tag]||null},s.prototype.findEarlySubscription=function(e){return this.earlySubscriptions[e.call_id+e.to_tag+e.getHeader("event")]||null},s.prototype.loadConfig=function(t){var i,n,s,o,c,u={viaHost:e.Utils.createRandomToken(12)+".invalid",uri:new e.URI("sip","anonymous."+e.Utils.createRandomToken(6),"anonymous.invalid",null,null),custom:{},displayName:"",password:null,registerExpires:600,register:!0,registrarServer:null,transportConstructor:r(29)(e),transportOptions:{},userAgentString:e.C.USER_AGENT,noAnswerTimeout:60,hackViaTcp:!1,hackIpInContact:!1,hackWssInTransport:!1,hackAllowUnregisteredOptionTags:!1,sessionDescriptionHandlerFactoryOptions:{constraints:{},peerConnectionOptions:{}},contactName:e.Utils.createRandomToken(8),contactTransport:"ws",forceRport:!1,autostart:!0,autostop:!0,rel100:e.C.supported.UNSUPPORTED,dtmfType:e.C.dtmfType.INFO,replaces:e.C.supported.UNSUPPORTED,sessionDescriptionHandlerFactory:r(30)(e).defaultFactory,authenticationFactory:a(function(t){return new e.DigestAuthentication(t)}),allowLegacyNotifications:!1,allowOutOfDialogRefers:!1};function d(e,r){var i=e.replace(/([a-z][A-Z])/g,function(e){return e[0]+"_"+e[1].toLowerCase()});if(e!==i){var n=t.hasOwnProperty(e);t.hasOwnProperty(i)&&(r.warn(i+" is deprecated, please use "+e),n&&r.warn(e+" overriding "+i)),t[e]=n?t[e]:t[i]}}var h=this.getConfigurationCheck();for(i in h.mandatory){if(d(i,this.logger),!t.hasOwnProperty(i))throw new e.Exceptions.ConfigurationError(i);if(n=t[i],void 0===(s=h.mandatory[i](n)))throw new e.Exceptions.ConfigurationError(i,n);u[i]=s}for(i in h.optional)if(d(i,this.logger),t.hasOwnProperty(i)){if((n=t[i])instanceof Array&&0===n.length)continue;if(null===n||""===n||void 0===n)continue;if("number"==typeof n&&isNaN(n))continue;if(void 0===(s=h.optional[i](n)))throw new e.Exceptions.ConfigurationError(i,n);u[i]=s}0===u.displayName&&(u.displayName="0"),u.instanceId||(u.instanceId=e.Utils.newUUID()),u.sipjsId=e.Utils.createRandomToken(5),(o=u.uri.clone()).user=null,u.hostportParams=o.toRaw().replace(/^sip:/i,""),u.authorizationUser||(u.authorizationUser=u.uri.user),u.registrarServer||((c=u.uri.clone()).user=null,u.registrarServer=c),u.noAnswerTimeout=1e3*u.noAnswerTimeout,u.hackIpInContact&&("boolean"==typeof u.hackIpInContact?u.viaHost=e.Utils.getRandomTestNetIP():"string"==typeof u.hackIpInContact&&(u.viaHost=u.hackIpInContact)),u.hackWssInTransport&&(u.contactTransport="wss"),this.contact={pub_gruu:null,temp_gruu:null,uri:new e.URI("sip",u.contactName,u.viaHost,null,{transport:u.contactTransport}),toString:function(e){var t=(e=e||{}).anonymous||null,r=e.outbound||null,i="<";return i+=t?(this.temp_gruu||"sip:anonymous@anonymous.invalid;transport="+u.contactTransport).toString():(this.pub_gruu||this.uri).toString(),r&&(i+=";ob"),i+=">"}};var l={};for(i in u)l[i]=u[i];for(i in Object.assign(this.configuration,l),this.logger.log("configuration parameters after validation:"),u)switch(i){case"uri":case"registrarServer":case"sessionDescriptionHandlerFactory":this.logger.log("· "+i+": "+u[i]);break;case"password":this.logger.log("· "+i+": NOT SHOWN");break;case"transportConstructor":this.logger.log("· "+i+": "+u[i].name);break;default:this.logger.log("· "+i+": "+JSON.stringify(u[i]))}},s.prototype.getConfigurationCheck=function(){return{mandatory:{},optional:{uri:function(t){var r;return/^sip:/i.test(t)||(t=e.C.SIP+":"+t),(r=e.URI.parse(t))&&r.user?r:void 0},transportConstructor:function(e){if(e instanceof Function)return e},transportOptions:function(e){if("object"===(void 0===e?"undefined":i(e)))return e},authorizationUser:function(t){return-1===e.Grammar.parse('"'+t+'"',"quoted_string")?void 0:t},displayName:function(t){return-1===e.Grammar.parse('"'+t+'"',"displayName")?void 0:t},dtmfType:function(t){switch(t){case e.C.dtmfType.RTP:return e.C.dtmfType.RTP;case e.C.dtmfType.INFO:default:return e.C.dtmfType.INFO}},hackViaTcp:function(e){if("boolean"==typeof e)return e},hackIpInContact:function(t){return"boolean"==typeof t?t:"string"==typeof t&&-1!==e.Grammar.parse(t,"host")?t:void 0},hackWssInTransport:function(e){if("boolean"==typeof e)return e},hackAllowUnregisteredOptionTags:function(e){if("boolean"==typeof e)return e},contactTransport:function(e){if("string"==typeof e)return e},forceRport:function(e){if("boolean"==typeof e)return e},instanceId:function(t){if("string"==typeof t)return/^uuid:/i.test(t)&&(t=t.substr(5)),-1===e.Grammar.parse(t,"uuid")?void 0:t},noAnswerTimeout:function(t){var r;if(e.Utils.isDecimal(t)&&(r=Number(t))>0)return r},password:function(e){return String(e)},rel100:function(t){return t===e.C.supported.REQUIRED?e.C.supported.REQUIRED:t===e.C.supported.SUPPORTED?e.C.supported.SUPPORTED:e.C.supported.UNSUPPORTED},replaces:function(t){return t===e.C.supported.REQUIRED?e.C.supported.REQUIRED:t===e.C.supported.SUPPORTED?e.C.supported.SUPPORTED:e.C.supported.UNSUPPORTED},register:function(e){if("boolean"==typeof e)return e},registerExpires:function(t){var r;if(e.Utils.isDecimal(t)&&(r=Number(t))>0)return r},registrarServer:function(t){var r;if("string"==typeof t)return/^sip:/i.test(t)||(t=e.C.SIP+":"+t),(r=e.URI.parse(t))?r.user?void 0:r:void 0},userAgentString:function(e){if("string"==typeof e)return e},autostart:function(e){if("boolean"==typeof e)return e},autostop:function(e){if("boolean"==typeof e)return e},sessionDescriptionHandlerFactory:function(e){if(e instanceof Function)return e},sessionDescriptionHandlerFactoryOptions:function(e){if("object"===(void 0===e?"undefined":i(e)))return e},authenticationFactory:a,allowLegacyNotifications:function(e){if("boolean"==typeof e)return e},custom:function(e){if("object"===(void 0===e?"undefined":i(e)))return e},contactName:function(e){if("string"==typeof e)return e}}}},s.C=o,e.UA=s}}).call(this,r(28))},function(e,t){var r;r=function(){return this}();try{r=r||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(r=window)}e.exports=r},function(e,t,r){(function(t){e.exports=function(e){var r,i={STATUS_CONNECTING:0,STATUS_OPEN:1,STATUS_CLOSING:2,STATUS_CLOSED:3},n=(t.window||t).WebSocket;return(r=function(t,r){r=e.Utils.defaultOptions({},r),this.logger=t,this.ws=null,this.server=null,this.connectionPromise=null,this.connectDeferredResolve=null,this.connectionTimeout=null,this.disconnectionPromise=null,this.disconnectDeferredResolve=null,this.boundOnOpen=null,this.boundOnMessage=null,this.boundOnClose=null,this.boundOnError=null,this.reconnectionAttempts=0,this.reconnectTimer=null,this.keepAliveInterval=null,this.keepAliveDebounceTimeout=null,this.status=i.STATUS_CONNECTING,this.configuration={},this.loadConfig(r)}).prototype=Object.create(e.Transport.prototype,{isConnected:{writable:!0,value:function(){return this.status===i.STATUS_OPEN}},sendPromise:{writable:!0,value:function(t,r){if(r=r||{},!this.statusAssert(i.STATUS_OPEN,r.force))return this.onError("unable to send message - WebSocket not open"),e.Utils.Promise.reject();var n=t.toString();return this.ws?(!0===this.configuration.traceSip&&this.logger.log("sending WebSocket message:\n\n"+n+"\n"),this.ws.send(n),e.Utils.Promise.resolve({msg:n})):(this.onError("unable to send message - WebSocket does not exist"),e.Utils.Promise.reject())}},disconnectPromise:{writable:!0,value:function(t){return this.disconnectionPromise?this.disconnectionPromise:(t=t||{},this.statusTransition(i.STATUS_CLOSING,t.force)?(this.disconnectionPromise=new e.Utils.Promise(function(r,i){this.disconnectDeferredResolve=r,this.reconnectTimer&&(e.Timers.clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws?(this.stopSendingKeepAlives(),this.logger.log("closing WebSocket "+this.server.ws_uri),this.ws.close(t.code,t.reason)):i("Attempted to disconnect but the websocket doesn't exist")}.bind(this)),this.disconnectionPromise):e.Utils.Promise.reject("Failed status transition - attempted to disconnect a socket that was not open"))}},connectPromise:{writable:!0,value:function(t){return this.connectionPromise?this.connectionPromise:(t=t||{},this.server=this.server||this.getNextWsServer(t.force),this.connectionPromise=new e.Utils.Promise(function(r,s){if((this.status===i.STATUS_OPEN||this.status===i.STATUS_CLOSING)&&!t.force)return this.logger.warn("WebSocket "+this.server.ws_uri+" is already connected"),void s("Failed status check - attempted to open a connection but already open/closing");this.connectDeferredResolve=r,this.status=i.STATUS_CONNECTING,this.logger.log("connecting to WebSocket "+this.server.ws_uri),this.disposeWs();try{this.ws=new n(this.server.ws_uri,"sip")}catch(e){return this.ws=null,this.status=i.STATUS_CLOSED,this.onError("error connecting to WebSocket "+this.server.ws_uri+":"+e),void s("Failed to create a websocket")}this.ws?(this.connectionTimeout=e.Timers.setTimeout(function(){this.onError("took too long to connect - exceeded time set in configuration.connectionTimeout: "+this.configuration.connectionTimeout+"s")}.bind(this),1e3*this.configuration.connectionTimeout),this.boundOnOpen=this.onOpen.bind(this),this.boundOnMessage=this.onMessage.bind(this),this.boundOnClose=this.onClose.bind(this),this.boundOnError=this.onError.bind(this),this.ws.addEventListener("open",this.boundOnOpen),this.ws.addEventListener("message",this.boundOnMessage),this.ws.addEventListener("close",this.boundOnClose),this.ws.addEventListener("error",this.boundOnError)):s("Unexpected instance websocket not set")}.bind(this)),this.connectionPromise)}},onOpen:{writable:!0,value:function(){this.status=i.STATUS_OPEN,this.emit("connected"),e.Timers.clearTimeout(this.connectionTimeout),this.logger.log("WebSocket "+this.server.ws_uri+" connected"),null!==this.reconnectTimer&&(e.Timers.clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.reconnectionAttempts=0,this.disconnectionPromise=null,this.disconnectDeferredResolve=null,this.startSendingKeepAlives(),this.connectDeferredResolve?this.connectDeferredResolve({overrideEvent:!0}):this.logger.warn("Unexpected websocket.onOpen with no connectDeferredResolve")}},onClose:{writable:!0,value:function(t){if(this.logger.log("WebSocket disconnected (code: "+t.code+(t.reason?"| reason: "+t.reason:"")+")"),this.emit("disconnected",{code:t.code,reason:t.reason}),this.status!==i.STATUS_CLOSING&&(this.logger.warn("WebSocket abrupt disconnection"),this.emit("transportError")),this.stopSendingKeepAlives(),e.Timers.clearTimeout(this.connectionTimeout),this.connectionTimeout=null,this.connectionPromise=null,this.connectDeferredResolve=null,this.disconnectDeferredResolve)return this.disconnectDeferredResolve({overrideEvent:!0}),this.statusTransition(i.STATUS_CLOSED),void(this.disconnectDeferredResolve=null);this.status=i.STATUS_CLOSED,this.reconnect()}},disposeWs:{writable:!0,value:function(){this.ws&&(this.ws.removeEventListener("open",this.boundOnOpen),this.ws.removeEventListener("message",this.boundOnMessage),this.ws.removeEventListener("close",this.boundOnClose),this.ws.removeEventListener("error",this.boundOnError),this.boundOnOpen=null,this.boundOnMessage=null,this.boundOnClose=null,this.boundOnError=null,this.ws=null)}},onMessage:{writable:!0,value:function(e){var t=e.data;if(/^(\r\n)+$/.test(t))return this.clearKeepAliveTimeout(),void(!0===this.configuration.traceSip&&this.logger.log("received WebSocket message with CRLF Keep Alive response"));if(t){if("string"!=typeof t){try{t=String.fromCharCode.apply(null,new Uint8Array(t))}catch(e){return void this.logger.warn("received WebSocket binary message failed to be converted into string, message discarded")}!0===this.configuration.traceSip&&this.logger.log("received WebSocket binary message:\n\n"+t+"\n")}else!0===this.configuration.traceSip&&this.logger.log("received WebSocket text message:\n\n"+t+"\n");this.emit("message",t)}else this.logger.warn("received empty message, message discarded")}},onError:{writable:!0,value:function(e){this.logger.warn("Transport error: "+e),this.emit("transportError")}},reconnect:{writable:!0,value:function(){if(this.reconnectionAttempts>0&&this.logger.log("Reconnection attempt "+this.reconnectionAttempts+" failed"),this.noAvailableServers())return this.logger.warn("no available ws servers left - going to closed state"),this.status=i.STATUS_CLOSED,void this.resetServerErrorStatus();this.isConnected()&&(this.logger.warn("attempted to reconnect while connected - forcing disconnect"),this.disconnect({force:!0})),this.reconnectionAttempts+=1,this.reconnectionAttempts>this.configuration.maxReconnectionAttempts?(this.logger.warn("maximum reconnection attempts for WebSocket "+this.server.ws_uri),this.logger.log("transport "+this.server.ws_uri+" failed | connection state set to 'error'"),this.server.isError=!0,this.emit("transportError"),this.server=this.getNextWsServer(),this.reconnectionAttempts=0,this.reconnect()):(this.logger.log("trying to reconnect to WebSocket "+this.server.ws_uri+" (reconnection attempt "+this.reconnectionAttempts+")"),this.reconnectTimer=e.Timers.setTimeout(function(){this.connect(),this.reconnectTimer=null}.bind(this),1===this.reconnectionAttempts?0:1e3*this.configuration.reconnectionTimeout))}},resetServerErrorStatus:{writable:!0,value:function(){var e,t=this.configuration.wsServers.length;for(e=0;e<t;e++)this.configuration.wsServers[e].isError=!1}},getNextWsServer:{writable:!0,value:function(e){if(!this.noAvailableServers()){var t,r,i,n=[];for(r=this.configuration.wsServers.length,t=0;t<r;t++)(i=this.configuration.wsServers[t]).isError&&!e||(0===n.length?n.push(i):i.weight>n[0].weight?n=[i]:i.weight===n[0].weight&&n.push(i));return n[t=Math.floor(Math.random()*n.length)]}this.logger.warn("attempted to get next ws server but there are no available ws servers left")}},noAvailableServers:{writable:!0,value:function(){var e;for(e in this.configuration.wsServers)if(!this.configuration.wsServers[e].isError)return!1;return!0}},sendKeepAlive:{writable:!0,value:function(){if(!this.keepAliveDebounceTimeout)return this.keepAliveDebounceTimeout=e.Timers.setTimeout(function(){this.emit("keepAliveDebounceTimeout"),this.clearKeepAliveTimeout()}.bind(this),1e3*this.configuration.keepAliveDebounce),this.send("\r\n\r\n")}},clearKeepAliveTimeout:{writable:!0,value:function(){e.Timers.clearTimeout(this.keepAliveDebounceTimeout),this.keepAliveDebounceTimeout=null}},startSendingKeepAlives:{writable:!0,value:function(){var t,r;this.configuration.keepAliveInterval&&!this.keepAliveInterval&&(this.keepAliveInterval=e.Timers.setInterval(function(){this.sendKeepAlive(),this.startSendingKeepAlives()}.bind(this),(t=this.configuration.keepAliveInterval,r=.8*t,1e3*(Math.random()*(t-r)+r))))}},stopSendingKeepAlives:{writable:!0,value:function(){e.Timers.clearInterval(this.keepAliveInterval),e.Timers.clearTimeout(this.keepAliveDebounceTimeout),this.keepAliveInterval=null,this.keepAliveDebounceTimeout=null}},statusAssert:{writable:!0,value:function(e,t){return e===this.status||(t?(this.logger.warn("Attempted to assert "+Object.keys(i)[this.status]+" as "+Object.keys(i)[e]+"- continuing with option: 'force'"),!0):(this.logger.warn("Tried to assert "+Object.keys(i)[e]+" but is currently "+Object.keys(i)[this.status]),!1))}},statusTransition:{writable:!0,value:function(e,t){return this.logger.log("Attempting to transition status from "+Object.keys(i)[this.status]+" to "+Object.keys(i)[e]),e===i.STATUS_OPEN&&this.statusAssert(i.STATUS_CONNECTING,t)||e===i.STATUS_CLOSING&&this.statusAssert(i.STATUS_OPEN,t)||e===i.STATUS_CLOSED&&this.statusAssert(i.STATUS_CLOSING,t)?(this.status=e,!0):(this.logger.warn("Status transition failed - result: no-op - reason: either gave an nonexistent status or attempted illegal transition"),!1)}},loadConfig:{writable:!0,value:function(t){var r,i,n,s={wsServers:[{scheme:"WSS",sip_uri:"<sip:edge.sip.onsip.com;transport=ws;lr>",weight:0,ws_uri:"wss://edge.sip.onsip.com",isError:!1}],connectionTimeout:5,maxReconnectionAttempts:3,reconnectionTimeout:4,keepAliveInterval:0,keepAliveDebounce:10,traceSip:!1};function o(e,r){var i=e.replace(/([a-z][A-Z])/g,function(e){return e[0]+"_"+e[1].toLowerCase()});if(e!==i){var n=t.hasOwnProperty(e);t.hasOwnProperty(i)&&(r.warn(i+" is deprecated, please use "+e),n&&r.warn(e+" overriding "+i)),t[e]=n?t[e]:t[i]}}var a=this.getConfigurationCheck();for(r in a.mandatory){if(o(r,this.logger),!t.hasOwnProperty(r))throw new e.Exceptions.ConfigurationError(r);if(i=t[r],void 0===(n=a.mandatory[r](i)))throw new e.Exceptions.ConfigurationError(r,i);s[r]=n}for(r in a.optional)if(o(r,this.logger),t.hasOwnProperty(r)){if((i=t[r])instanceof Array&&0===i.length)continue;if(null===i||""===i||void 0===i)continue;if("number"==typeof i&&isNaN(i))continue;if(void 0===(n=a.optional[r](i)))throw new e.Exceptions.ConfigurationError(r,i);s[r]=n}var c={};for(r in s)c[r]={value:s[r]};for(r in Object.defineProperties(this.configuration,c),this.logger.log("configuration parameters after validation:"),s)this.logger.log("· "+r+": "+JSON.stringify(s[r]))}},getConfigurationCheck:{writable:!0,value:function(){return{mandatory:{},optional:{wsServers:function(t){var r,i,n;if("string"==typeof t)t=[{ws_uri:t}];else{if(!(t instanceof Array))return;for(i=t.length,r=0;r<i;r++)"string"==typeof t[r]&&(t[r]={ws_uri:t[r]})}if(0===t.length)return!1;for(i=t.length,r=0;r<i;r++){if(!t[r].ws_uri)return;if(t[r].weight&&!Number(t[r].weight))return;if(-1===(n=e.Grammar.parse(t[r].ws_uri,"absoluteURI")))return;if(["wss","ws","udp"].indexOf(n.scheme)<0)return;t[r].sip_uri="<sip:"+n.host+(n.port?":"+n.port:"")+";transport="+n.scheme.replace(/^wss$/i,"ws")+";lr>",t[r].weight||(t[r].weight=0),t[r].isError=!1,t[r].scheme=n.scheme.toUpperCase()}return t},keepAliveInterval:function(t){var r;if(e.Utils.isDecimal(t)&&(r=Number(t))>0)return r},keepAliveDebounce:function(t){var r;if(e.Utils.isDecimal(t)&&(r=Number(t))>0)return r},traceSip:function(e){if("boolean"==typeof e)return e},connectionTimeout:function(t){var r;if(e.Utils.isDecimal(t)&&(r=Number(t))>0)return r},maxReconnectionAttempts:function(t){var r;if(e.Utils.isDecimal(t)&&(r=Number(t))>=0)return r},reconnectionTimeout:function(t){var r;if(e.Utils.isDecimal(t)&&(r=Number(t))>0)return r}}}}}}),r.C=i,e.Web.Transport=r,r}}).call(this,r(28))},function(e,t,r){(function(t){e.exports=function(e){var i=function(e,r,i){this.options=i||{},this.logger=e,this.observer=r,this.dtmfSender=null,this.shouldAcquireMedia=!0,this.CONTENT_TYPE="application/sdp",this.C={},this.C.DIRECTION={NULL:null,SENDRECV:"sendrecv",SENDONLY:"sendonly",RECVONLY:"recvonly",INACTIVE:"inactive"},this.logger.log("SessionDescriptionHandlerOptions: "+JSON.stringify(this.options)),this.direction=this.C.DIRECTION.NULL,this.modifiers=this.options.modifiers||[],Array.isArray(this.modifiers)||(this.modifiers=[this.modifiers]);var n=t.window||t;this.WebRTC={MediaStream:n.MediaStream,getUserMedia:n.navigator.mediaDevices.getUserMedia.bind(n.navigator.mediaDevices),RTCPeerConnection:n.RTCPeerConnection},this.iceGatheringDeferred=null,this.iceGatheringTimeout=!1,this.iceGatheringTimer=null,this.initPeerConnection(this.options.peerConnectionOptions),this.constraints=this.checkAndDefaultConstraints(this.options.constraints)};return i.defaultFactory=function(e,t){var n=e.ua.getLogger("sip.invitecontext.sessionDescriptionHandler",e.id),s=new(r(31))(e,t);return new i(n,s,t)},i.prototype=Object.create(e.SessionDescriptionHandler.prototype,{close:{writable:!0,value:function(){this.logger.log("closing PeerConnection"),this.peerConnection&&"closed"!==this.peerConnection.signalingState&&(this.peerConnection.getSenders?this.peerConnection.getSenders().forEach(function(e){e.track&&e.track.stop()}):(this.logger.warn("Using getLocalStreams which is deprecated"),this.peerConnection.getLocalStreams().forEach(function(e){e.getTracks().forEach(function(e){e.stop()})})),this.peerConnection.getReceivers?this.peerConnection.getReceivers().forEach(function(e){e.track&&e.track.stop()}):(this.logger.warn("Using getRemoteStreams which is deprecated"),this.peerConnection.getRemoteStreams().forEach(function(e){e.getTracks().forEach(function(e){e.stop()})})),this.resetIceGatheringComplete(),this.peerConnection.close())}},getDescription:{writable:!0,value:function(t,r){(t=t||{}).peerConnectionOptions&&this.initPeerConnection(t.peerConnectionOptions);var i=Object.assign({},this.constraints,t.constraints);return i=this.checkAndDefaultConstraints(i),JSON.stringify(i)!==JSON.stringify(this.constraints)&&(this.constraints=i,this.shouldAcquireMedia=!0),r=r||[],Array.isArray(r)||(r=[r]),r=r.concat(this.modifiers),e.Utils.Promise.resolve().then(function(){if(this.shouldAcquireMedia)return this.acquire(this.constraints).then(function(){this.shouldAcquireMedia=!1}.bind(this))}.bind(this)).then(function(){return this.createOfferOrAnswer(t.RTCOfferOptions,r)}.bind(this)).then(function(e){return this.emit("getDescription",e),{body:e.sdp,contentType:this.CONTENT_TYPE}}.bind(this))}},hasDescription:{writable:!0,value:function(e){return e===this.CONTENT_TYPE}},holdModifier:{writable:!0,value:function(t){return/a=(sendrecv|sendonly|recvonly|inactive)/.test(t.sdp)?(t.sdp=t.sdp.replace(/a=sendrecv\r\n/g,"a=sendonly\r\n"),t.sdp=t.sdp.replace(/a=recvonly\r\n/g,"a=inactive\r\n")):t.sdp=t.sdp.replace(/(m=[^\r]*\r\n)/g,"$1a=sendonly\r\n"),e.Utils.Promise.resolve(t)}},setDescription:{writable:!0,value:function(t,r,i){var n=this,s=this;(r=r||{}).peerConnectionOptions&&this.initPeerConnection(r.peerConnectionOptions),i=i||[],Array.isArray(i)||(i=[i]),i=i.concat(this.modifiers);var o={type:this.hasOffer("local")?"answer":"offer",sdp:t};return e.Utils.Promise.resolve().then(function(){if(this.shouldAcquireMedia&&this.options.alwaysAcquireMediaFirst)return this.acquire(this.constraints).then(function(){this.shouldAcquireMedia=!1}.bind(this))}.bind(this)).then(function(){return e.Utils.reducePromises(i,o)}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var r=new e.Exceptions.SessionDescriptionHandlerError("setDescription",t,"The modifiers did not resolve successfully");throw n.logger.error(r.message),s.emit("peerConnection-setRemoteDescriptionFailed",r),r}).then(function(e){return s.emit("setDescription",e),s.peerConnection.setRemoteDescription(e)}).catch(function(s){if(s instanceof e.Exceptions.SessionDescriptionHandlerError)throw s;if(/^m=video.+$/gm.test(t)&&!r.disableAudioFallback)return r.disableAudioFallback=!0,n.setDescription(t,r,[e.Web.Modifiers.stripVideo].concat(i));var o=new e.Exceptions.SessionDescriptionHandlerError("setDescription",s);throw n.logger.error(o.error),n.emit("peerConnection-setRemoteDescriptionFailed",o),o}).then(function(){s.peerConnection.getReceivers?s.emit("setRemoteDescription",s.peerConnection.getReceivers()):s.emit("setRemoteDescription",s.peerConnection.getRemoteStreams()),s.emit("confirmed",s)})}},sendDtmf:{writable:!0,value:function(e,t){if(!this.dtmfSender&&this.hasBrowserGetSenderSupport()){var r=this.peerConnection.getSenders();r.length>0&&(this.dtmfSender=r[0].dtmf)}if(!this.dtmfSender&&this.hasBrowserTrackSupport()){var i=this.peerConnection.getLocalStreams();if(i.length>0){var n=i[0].getAudioTracks();n.length>0&&(this.dtmfSender=this.peerConnection.createDTMFSender(n[0]))}}if(!this.dtmfSender)return!1;try{this.dtmfSender.insertDTMF(e,t.duration,t.interToneGap)}catch(e){if("InvalidStateError"===e.type||"InvalidCharacterError"===e.type)return this.logger.error(e),!1;throw e}return this.logger.log("DTMF sent via RTP: "+e.toString()),!0}},getDirection:{writable:!0,value:function(){return this.direction}},createOfferOrAnswer:{writable:!0,value:function(t,r){var i,n=this,s=this,o=this.peerConnection;return t=t||{},i=s.hasOffer("remote")?"createAnswer":"createOffer",o[i](t).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var r=new e.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",t,"peerConnection-"+i+"Failed");throw n.emit("peerConnection-"+i+"Failed",r),r}).then(function(t){return e.Utils.reducePromises(r,s.createRTCSessionDescriptionInit(t))}).then(function(e){return s.resetIceGatheringComplete(),o.setLocalDescription(e)}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var r=new e.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",t,"peerConnection-SetLocalDescriptionFailed");throw n.emit("peerConnection-SetLocalDescriptionFailed",r),r}).then(function(){return s.waitForIceGatheringComplete()}).then(function(){var t=s.createRTCSessionDescriptionInit(s.peerConnection.localDescription);return e.Utils.reducePromises(r,t)}).then(function(e){return s.setDirection(e.sdp),e}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var r=new e.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",t);throw n.logger.error(r),r})}},createRTCSessionDescriptionInit:{writable:!0,value:function(e){return{type:e.type,sdp:e.sdp}}},addDefaultIceCheckingTimeout:{writable:!0,value:function(e){return void 0===e.iceCheckingTimeout&&(e.iceCheckingTimeout=5e3),e}},addDefaultIceServers:{writable:!0,value:function(e){return e.iceServers||(e.iceServers=[{urls:"stun:stun.l.google.com:19302"}]),e}},checkAndDefaultConstraints:{writable:!0,value:function(e){var t={audio:!0,video:!this.options.alwaysAcquireMediaFirst};return e=e||t,0===Object.keys(e).length&&e.constructor===Object?t:e}},hasBrowserTrackSupport:{writable:!0,value:function(){return Boolean(this.peerConnection.addTrack)}},hasBrowserGetSenderSupport:{writable:!0,value:function(){return Boolean(this.peerConnection.getSenders)}},initPeerConnection:{writable:!0,value:function(t){var r=this;t=t||{},(t=this.addDefaultIceCheckingTimeout(t)).rtcConfiguration=t.rtcConfiguration||{},t.rtcConfiguration=this.addDefaultIceServers(t.rtcConfiguration),this.logger.log("initPeerConnection"),this.peerConnection&&(this.logger.log("Already have a peer connection for this session. Tearing down."),this.resetIceGatheringComplete(),this.peerConnection.close()),this.peerConnection=new this.WebRTC.RTCPeerConnection(t.rtcConfiguration),this.logger.log("New peer connection created"),"ontrack"in this.peerConnection?this.peerConnection.addEventListener("track",function(e){r.logger.log("track added"),r.observer.trackAdded(),r.emit("addTrack",e)}):(this.logger.warn("Using onaddstream which is deprecated"),this.peerConnection.onaddstream=function(e){r.logger.log("stream added"),r.emit("addStream",e)}),this.peerConnection.onicecandidate=function(e){r.emit("iceCandidate",e),e.candidate?r.logger.log("ICE candidate received: "+(null===e.candidate.candidate?null:e.candidate.candidate.trim())):null===e.candidate&&(r.logger.log("ICE candidate gathering complete"),r.triggerIceGatheringComplete())},this.peerConnection.onicegatheringstatechange=function(){switch(r.logger.log("RTCIceGatheringState changed: "+this.iceGatheringState),this.iceGatheringState){case"gathering":r.emit("iceGathering",this),!r.iceGatheringTimer&&t.iceCheckingTimeout&&(r.iceGatheringTimeout=!1,r.iceGatheringTimer=e.Timers.setTimeout(function(){r.logger.log("RTCIceChecking Timeout Triggered after "+t.iceCheckingTimeout+" milliseconds"),r.iceGatheringTimeout=!0,r.triggerIceGatheringComplete()},t.iceCheckingTimeout));break;case"complete":r.triggerIceGatheringComplete()}},this.peerConnection.oniceconnectionstatechange=function(){var e;switch(this.iceConnectionState){case"new":e="iceConnection";break;case"checking":e="iceConnectionChecking";break;case"connected":e="iceConnectionConnected";break;case"completed":e="iceConnectionCompleted";break;case"failed":e="iceConnectionFailed";break;case"disconnected":e="iceConnectionDisconnected";break;case"closed":e="iceConnectionClosed";break;default:return void r.logger.warn("Unknown iceConnection state:",this.iceConnectionState)}r.emit(e,this)}}},acquire:{writable:!0,value:function(t){var r=this;return t=this.checkAndDefaultConstraints(t),new e.Utils.Promise(function(e,r){this.logger.log("acquiring local media"),this.emit("userMediaRequest",t),t.audio||t.video?this.WebRTC.getUserMedia(t).then(function(t){this.observer.trackAdded(),this.emit("userMedia",t),e(t)}.bind(this)).catch(function(e){this.emit("userMediaFailed",e),r(e)}.bind(this)):e([])}.bind(this)).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var i=new e.Exceptions.SessionDescriptionHandlerError("acquire",t,"unable to acquire streams");throw r.logger.error(i.message),r.logger.error(i.error),i}).then(function(t){this.logger.log("acquired local media streams");try{return this.peerConnection.removeTrack&&this.peerConnection.getSenders().forEach(function(e){this.peerConnection.removeTrack(e)},this),t}catch(t){return e.Utils.Promise.reject(t)}}.bind(this)).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var i=new e.Exceptions.SessionDescriptionHandlerError("acquire",t,"error removing streams");throw r.logger.error(i.message),r.logger.error(i.error),i}).then(function(t){try{(t=[].concat(t)).forEach(function(e){this.peerConnection.addTrack?e.getTracks().forEach(function(t){this.peerConnection.addTrack(t,e)},this):this.peerConnection.addStream(e)},this)}catch(t){return e.Utils.Promise.reject(t)}return e.Utils.Promise.resolve()}.bind(this)).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var i=new e.Exceptions.SessionDescriptionHandlerError("acquire",t,"error adding stream");throw r.logger.error(i.message),r.logger.error(i.error),i})}},hasOffer:{writable:!0,value:function(e){var t="have-"+e+"-offer";return this.peerConnection.signalingState===t}},isIceGatheringComplete:{writable:!0,value:function(){return"complete"===this.peerConnection.iceGatheringState||this.iceGatheringTimeout}},resetIceGatheringComplete:{writable:!0,value:function(){this.iceGatheringTimeout=!1,this.iceGatheringTimer&&(e.Timers.clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=null),this.iceGatheringDeferred&&(this.iceGatheringDeferred.reject(),this.iceGatheringDeferred=null)}},setDirection:{writable:!0,value:function(e){var t=e.match(/a=(sendrecv|sendonly|recvonly|inactive)/);if(null===t)return this.direction=this.C.DIRECTION.NULL,void this.observer.directionChanged();var r=t[1];switch(r){case this.C.DIRECTION.SENDRECV:case this.C.DIRECTION.SENDONLY:case this.C.DIRECTION.RECVONLY:case this.C.DIRECTION.INACTIVE:this.direction=r;break;default:this.direction=this.C.DIRECTION.NULL}this.observer.directionChanged()}},triggerIceGatheringComplete:{writable:!0,value:function(){this.isIceGatheringComplete()&&(this.emit("iceGatheringComplete",this),this.iceGatheringTimer&&(e.Timers.clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=null),this.iceGatheringDeferred&&(this.iceGatheringDeferred.resolve(),this.iceGatheringDeferred=null))}},waitForIceGatheringComplete:{writable:!0,value:function(){return this.isIceGatheringComplete()?e.Utils.Promise.resolve():(this.isIceGatheringDeferred||(this.iceGatheringDeferred=e.Utils.defer()),this.iceGatheringDeferred.promise)}}}),i}}).call(this,r(28))},function(e,t,r){var i=function(e,t){this.session=e||{},this.options=t||{}};i.prototype={trackAdded:function(){this.session.emit("trackAdded")},directionChanged:function(){this.session.emit("directionChanged")}},e.exports=i},function(e,t,r){e.exports=function(e){var t,r=[],i=[],n=[];function s(t,r,i){for(var n,s=e.Utils.buildStatusLine(t),o=r.getHeaders("via"),a=o.length,c=0;c<a;c++)s+="Via: "+o[c]+"\r\n";n=r.getHeader("To"),r.to_tag||(n+=";tag="+e.Utils.newTag()),s+="To: "+n+"\r\n",s+="From: "+r.getHeader("From")+"\r\n",s+="Call-ID: "+r.call_id+"\r\n",s+="CSeq: "+r.cseq+" "+r.method+"\r\n",s+="\r\n",i.send(s)}r.push(function(e,t,r){if(!e.ruri||"sip"!==e.ruri.scheme)return s(416,e,r),!1}),r.push(function(e,t,r){if(!e.to_tag&&e.call_id.substr(0,5)===t.configuration.sipjsId)return s(482,e,r),!1}),r.push(function(t,r,i){if(e.Utils.str_utf8_length(t.body)<t.getHeader("content-length"))return s(400,t,i),!1}),r.push(function(t,r,i){var n,o,a=t.from_tag,c=t.call_id,u=t.cseq;if(!t.to_tag)if(t.method===e.C.INVITE){if(n=r.transactions.ist[t.via_branch])return;for(o in r.transactions.ist)if((n=r.transactions.ist[o]).request.from_tag===a&&n.request.call_id===c&&n.request.cseq===u)return s(482,t,i),!1}else{if(n=r.transactions.nist[t.via_branch])return;for(o in r.transactions.nist)if((n=r.transactions.nist[o]).request.from_tag===a&&n.request.call_id===c&&n.request.cseq===u)return s(482,t,i),!1}}),i.push(function(e,t){if(e.getHeaders("via").length>1)return t.getLogger("sip.sanitycheck").warn("More than one Via header field present in the response. Dropping the response"),!1}),i.push(function(e,t){var r=t.configuration.viaHost;if(e.via.host!==r||void 0!==e.via.port)return t.getLogger("sip.sanitycheck").warn("Via sent-by in the response does not match UA Via host value. Dropping the response"),!1}),i.push(function(t,r){if(e.Utils.str_utf8_length(t.body)<t.getHeader("content-length"))return r.getLogger("sip.sanitycheck").warn("Message body length is lower than the value in Content-Length header field. Dropping the response"),!1}),n.push(function(e,t){for(var r=["from","to","call_id","cseq","via"],i=r.length;i--;)if(!e.hasHeader(r[i]))return t.getLogger("sip.sanitycheck").warn("Missing mandatory header field : "+r[i]+". Dropping the response"),!1}),t=function(t,s,o){var a;for(a=n.length;a--;)if(!1===n[a](t,s,o))return!1;if(t instanceof e.IncomingRequest){for(a=r.length;a--;)if(!1===r[a](t,s,o))return!1}else if(t instanceof e.IncomingResponse)for(a=i.length;a--;)if(!1===i[a](t,s,o))return!1;return!0},e.sanityCheck=t}},function(e,t,r){var i=r(34);e.exports=function(e){var t;return(t=function(e){this.logger=e.getLogger("sipjs.digestauthentication"),this.username=e.configuration.authorizationUser,this.password=e.configuration.password,this.cnonce=null,this.nc=0,this.ncHex="00000000",this.response=null}).prototype.authenticate=function(t,r){if(this.algorithm=r.algorithm,this.realm=r.realm,this.nonce=r.nonce,this.opaque=r.opaque,this.stale=r.stale,this.algorithm){if("MD5"!==this.algorithm)return this.logger.warn('challenge with Digest algorithm different than "MD5", authentication aborted'),!1}else this.algorithm="MD5";if(!this.realm)return this.logger.warn("challenge without Digest realm, authentication aborted"),!1;if(!this.nonce)return this.logger.warn("challenge without Digest nonce, authentication aborted"),!1;if(r.qop)if(r.qop.indexOf("auth")>-1)this.qop="auth";else{if(!(r.qop.indexOf("auth-int")>-1))return this.logger.warn('challenge without Digest qop different than "auth" or "auth-int", authentication aborted'),!1;this.qop="auth-int"}else this.qop=null;return this.method=t.method,this.uri=t.ruri,this.cnonce=e.createRandomToken(12),this.nc+=1,this.updateNcHex(),4294967296===this.nc&&(this.nc=1,this.ncHex="00000001"),this.calculateResponse(),!0},t.prototype.calculateResponse=function(){var e,t;e=i(this.username+":"+this.realm+":"+this.password),"auth"===this.qop?(t=i(this.method+":"+this.uri),this.response=i(e+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth:"+t)):"auth-int"===this.qop?(t=i(this.method+":"+this.uri+":"+i(this.body?this.body:"")),this.response=i(e+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth-int:"+t)):null===this.qop&&(t=i(this.method+":"+this.uri),this.response=i(e+":"+this.nonce+":"+t))},t.prototype.toString=function(){var e=[];if(!this.response)throw new Error("response field does not exist, cannot generate Authorization header");return e.push("algorithm="+this.algorithm),e.push('username="'+this.username+'"'),e.push('realm="'+this.realm+'"'),e.push('nonce="'+this.nonce+'"'),e.push('uri="'+this.uri+'"'),e.push('response="'+this.response+'"'),this.opaque&&e.push('opaque="'+this.opaque+'"'),this.qop&&(e.push("qop="+this.qop),e.push('cnonce="'+this.cnonce+'"'),e.push("nc="+this.ncHex)),"Digest "+e.join(", ")},t.prototype.updateNcHex=function(){var e=Number(this.nc).toString(16);this.ncHex="00000000".substr(0,8-e.length)+e},t}},function(e,t,r){var i;e.exports=(i=r(35),function(e){var t=i,r=t.lib,n=r.WordArray,s=r.Hasher,o=t.algo,a=[];!function(){for(var t=0;t<64;t++)a[t]=4294967296*e.abs(e.sin(t+1))|0}();var c=o.MD5=s.extend({_doReset:function(){this._hash=new n.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var i=t+r,n=e[i];e[i]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8)}var s=this._hash.words,o=e[t+0],c=e[t+1],p=e[t+2],f=e[t+3],m=e[t+4],g=e[t+5],T=e[t+6],v=e[t+7],C=e[t+8],S=e[t+9],_=e[t+10],y=e[t+11],E=e[t+12],b=e[t+13],R=e[t+14],w=e[t+15],A=s[0],I=s[1],D=s[2],O=s[3];A=u(A,I,D,O,o,7,a[0]),O=u(O,A,I,D,c,12,a[1]),D=u(D,O,A,I,p,17,a[2]),I=u(I,D,O,A,f,22,a[3]),A=u(A,I,D,O,m,7,a[4]),O=u(O,A,I,D,g,12,a[5]),D=u(D,O,A,I,T,17,a[6]),I=u(I,D,O,A,v,22,a[7]),A=u(A,I,D,O,C,7,a[8]),O=u(O,A,I,D,S,12,a[9]),D=u(D,O,A,I,_,17,a[10]),I=u(I,D,O,A,y,22,a[11]),A=u(A,I,D,O,E,7,a[12]),O=u(O,A,I,D,b,12,a[13]),D=u(D,O,A,I,R,17,a[14]),A=d(A,I=u(I,D,O,A,w,22,a[15]),D,O,c,5,a[16]),O=d(O,A,I,D,T,9,a[17]),D=d(D,O,A,I,y,14,a[18]),I=d(I,D,O,A,o,20,a[19]),A=d(A,I,D,O,g,5,a[20]),O=d(O,A,I,D,_,9,a[21]),D=d(D,O,A,I,w,14,a[22]),I=d(I,D,O,A,m,20,a[23]),A=d(A,I,D,O,S,5,a[24]),O=d(O,A,I,D,R,9,a[25]),D=d(D,O,A,I,f,14,a[26]),I=d(I,D,O,A,C,20,a[27]),A=d(A,I,D,O,b,5,a[28]),O=d(O,A,I,D,p,9,a[29]),D=d(D,O,A,I,v,14,a[30]),A=h(A,I=d(I,D,O,A,E,20,a[31]),D,O,g,4,a[32]),O=h(O,A,I,D,C,11,a[33]),D=h(D,O,A,I,y,16,a[34]),I=h(I,D,O,A,R,23,a[35]),A=h(A,I,D,O,c,4,a[36]),O=h(O,A,I,D,m,11,a[37]),D=h(D,O,A,I,v,16,a[38]),I=h(I,D,O,A,_,23,a[39]),A=h(A,I,D,O,b,4,a[40]),O=h(O,A,I,D,o,11,a[41]),D=h(D,O,A,I,f,16,a[42]),I=h(I,D,O,A,T,23,a[43]),A=h(A,I,D,O,S,4,a[44]),O=h(O,A,I,D,E,11,a[45]),D=h(D,O,A,I,w,16,a[46]),A=l(A,I=h(I,D,O,A,p,23,a[47]),D,O,o,6,a[48]),O=l(O,A,I,D,v,10,a[49]),D=l(D,O,A,I,R,15,a[50]),I=l(I,D,O,A,g,21,a[51]),A=l(A,I,D,O,E,6,a[52]),O=l(O,A,I,D,f,10,a[53]),D=l(D,O,A,I,_,15,a[54]),I=l(I,D,O,A,c,21,a[55]),A=l(A,I,D,O,C,6,a[56]),O=l(O,A,I,D,w,10,a[57]),D=l(D,O,A,I,T,15,a[58]),I=l(I,D,O,A,b,21,a[59]),A=l(A,I,D,O,m,6,a[60]),O=l(O,A,I,D,y,10,a[61]),D=l(D,O,A,I,p,15,a[62]),I=l(I,D,O,A,S,21,a[63]),s[0]=s[0]+A|0,s[1]=s[1]+I|0,s[2]=s[2]+D|0,s[3]=s[3]+O|0},_doFinalize:function(){var t=this._data,r=t.words,i=8*this._nDataBytes,n=8*t.sigBytes;r[n>>>5]|=128<<24-n%32;var s=e.floor(i/4294967296),o=i;r[15+(n+64>>>9<<4)]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),r[14+(n+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),t.sigBytes=4*(r.length+1),this._process();for(var a=this._hash,c=a.words,u=0;u<4;u++){var d=c[u];c[u]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8)}return a},clone:function(){var e=s.clone.call(this);return e._hash=this._hash.clone(),e}});function u(e,t,r,i,n,s,o){var a=e+(t&r|~t&i)+n+o;return(a<<s|a>>>32-s)+t}function d(e,t,r,i,n,s,o){var a=e+(t&i|r&~i)+n+o;return(a<<s|a>>>32-s)+t}function h(e,t,r,i,n,s,o){var a=e+(t^r^i)+n+o;return(a<<s|a>>>32-s)+t}function l(e,t,r,i,n,s,o){var a=e+(r^(t|~i))+n+o;return(a<<s|a>>>32-s)+t}t.MD5=s._createHelper(c),t.HmacMD5=s._createHmacHelper(c)}(Math),i.MD5)},function(e,t,r){var i;e.exports=(i=i||function(e,t){var r=Object.create||function(){function e(){}return function(t){var r;return e.prototype=t,r=new e,e.prototype=null,r}}(),i={},n=i.lib={},s=n.Base={extend:function(e){var t=r(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},o=n.WordArray=s.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,r=e.words,i=this.sigBytes,n=e.sigBytes;if(this.clamp(),i%4)for(var s=0;s<n;s++){var o=r[s>>>2]>>>24-s%4*8&255;t[i+s>>>2]|=o<<24-(i+s)%4*8}else for(var s=0;s<n;s+=4)t[i+s>>>2]=r[s>>>2];return this.sigBytes+=n,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=s.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r,i=[],n=function(t){var t=t,r=987654321,i=4294967295;return function(){var n=((r=36969*(65535&r)+(r>>16)&i)<<16)+(t=18e3*(65535&t)+(t>>16)&i)&i;return n/=4294967296,(n+=.5)*(e.random()>.5?1:-1)}},s=0;s<t;s+=4){var a=n(4294967296*(r||e.random()));r=987654071*a(),i.push(4294967296*a()|0)}return new o.init(i,t)}}),a=i.enc={},c=a.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,i=[],n=0;n<r;n++){var s=t[n>>>2]>>>24-n%4*8&255;i.push((s>>>4).toString(16)),i.push((15&s).toString(16))}return i.join("")},parse:function(e){for(var t=e.length,r=[],i=0;i<t;i+=2)r[i>>>3]|=parseInt(e.substr(i,2),16)<<24-i%8*4;return new o.init(r,t/2)}},u=a.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,i=[],n=0;n<r;n++){var s=t[n>>>2]>>>24-n%4*8&255;i.push(String.fromCharCode(s))}return i.join("")},parse:function(e){for(var t=e.length,r=[],i=0;i<t;i++)r[i>>>2]|=(255&e.charCodeAt(i))<<24-i%4*8;return new o.init(r,t)}},d=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(u.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return u.parse(unescape(encodeURIComponent(e)))}},h=n.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r=this._data,i=r.words,n=r.sigBytes,s=this.blockSize,a=4*s,c=n/a,u=(c=t?e.ceil(c):e.max((0|c)-this._minBufferSize,0))*s,d=e.min(4*u,n);if(u){for(var h=0;h<u;h+=s)this._doProcessBlock(i,h);var l=i.splice(0,u);r.sigBytes-=d}return new o.init(l,d)},clone:function(){var e=s.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),l=(n.Hasher=h.extend({cfg:s.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){h.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){e&&this._append(e);var t=this._doFinalize();return t},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new l.HMAC.init(e,r).finalize(t)}}}),i.algo={});return i}(Math),i)},function(e,t,r){var i=r(37);e.exports=function(e){return{parse:function(t,r){var n={startRule:r,SIP:e};try{i.parse(t,n)}catch(e){n.data=-1}return n.data}}}},function(e,t,r){function i(e,t,r,n){this.message=e,this.expected=t,this.found=r,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,i)}!function(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}(i,Error),i.buildMessage=function(e,t){var r={literal:function(e){return'"'+n(e.text)+'"'},class:function(e){var t,r="";for(t=0;t<e.parts.length;t++)r+=e.parts[t]instanceof Array?s(e.parts[t][0])+"-"+s(e.parts[t][1]):s(e.parts[t]);return"["+(e.inverted?"^":"")+r+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function i(e){return e.charCodeAt(0).toString(16).toUpperCase()}function n(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+i(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+i(e)})}function s(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+i(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+i(e)})}return"Expected "+function(e){var t,i,n,s=new Array(e.length);for(t=0;t<e.length;t++)s[t]=(n=e[t],r[n.type](n));if(s.sort(),s.length>0){for(t=1,i=1;t<s.length;t++)s[t-1]!==s[t]&&(s[i]=s[t],i++);s.length=i}switch(s.length){case 1:return s[0];case 2:return s[0]+" or "+s[1];default:return s.slice(0,-1).join(", ")+", or "+s[s.length-1]}}(e)+" but "+function(e){return e?'"'+n(e)+'"':"end of input"}(t)+" found."},e.exports={SyntaxError:i,parse:function(e,t){t=void 0!==t?t:{};var r,n={},s={Contact:119,Name_Addr_Header:156,Record_Route:176,Request_Response:81,SIP_URI:45,Subscription_State:186,Supported:191,Require:182,Via:194,absoluteURI:84,Call_ID:118,Content_Disposition:130,Content_Length:135,Content_Type:136,CSeq:146,displayName:122,Event:149,From:151,host:52,Max_Forwards:154,Min_SE:213,Proxy_Authenticate:157,quoted_string:40,Refer_To:178,Replaces:179,Session_Expires:210,stun_URI:217,To:192,turn_URI:223,uuid:226,WWW_Authenticate:209,challenge:158,sipfrag:230,Referred_By:231},o=119,a=["\r\n",T("\r\n",!1),/^[0-9]/,v([["0","9"]],!1,!1),/^[a-zA-Z]/,v([["a","z"],["A","Z"]],!1,!1),/^[0-9a-fA-F]/,v([["0","9"],["a","f"],["A","F"]],!1,!1),/^[\0-\xFF]/,v([["\0","ÿ"]],!1,!1),/^["]/,v(['"'],!1,!1)," ",T(" ",!1),"\t",T("\t",!1),/^[a-zA-Z0-9]/,v([["a","z"],["A","Z"],["0","9"]],!1,!1),";",T(";",!1),"/",T("/",!1),"?",T("?",!1),":",T(":",!1),"@",T("@",!1),"&",T("&",!1),"=",T("=",!1),"+",T("+",!1),"$",T("$",!1),",",T(",",!1),"-",T("-",!1),"_",T("_",!1),".",T(".",!1),"!",T("!",!1),"~",T("~",!1),"*",T("*",!1),"'",T("'",!1),"(",T("(",!1),")",T(")",!1),"%",T("%",!1),function(){return" "},function(){return":"},/^[!-~]/,v([["!","~"]],!1,!1),/^[\x80-\uFFFF]/,v([["","￿"]],!1,!1),/^[\x80-\xBF]/,v([["","¿"]],!1,!1),/^[a-f]/,v([["a","f"]],!1,!1),"`",T("`",!1),"<",T("<",!1),">",T(">",!1),"\\",T("\\",!1),"[",T("[",!1),"]",T("]",!1),"{",T("{",!1),"}",T("}",!1),function(){return"*"},function(){return"/"},function(){return"="},function(){return"("},function(){return")"},function(){return">"},function(){return"<"},function(){return","},function(){return";"},function(){return":"},function(){return'"'},/^[!-']/,v([["!","'"]],!1,!1),/^[*-[]/,v([["*","["]],!1,!1),/^[\]-~]/,v([["]","~"]],!1,!1),function(e){return e},/^[#-[]/,v([["#","["]],!1,!1),/^[\0-\t]/,v([["\0","\t"]],!1,!1),/^[\x0B-\f]/,v([["\v","\f"]],!1,!1),/^[\x0E-\x7F]/,v([["",""]],!1,!1),function(){t.data.uri=new t.SIP.URI(t.data.scheme,t.data.user,t.data.host,t.data.port),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port},function(){t.data.uri=new t.SIP.URI(t.data.scheme,t.data.user,t.data.host,t.data.port,t.data.uri_params,t.data.uri_headers),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port,delete t.data.uri_params,"SIP_URI"===t.startRule&&(t.data=t.data.uri)},"sips",T("sips",!0),"sip",T("sip",!0),function(e){t.data.scheme=e},function(){t.data.user=decodeURIComponent(m().slice(0,-1))},function(){t.data.password=m()},function(){return t.data.host=m(),t.data.host},function(){return t.data.host_type="domain",m()},/^[a-zA-Z0-9_\-]/,v([["a","z"],["A","Z"],["0","9"],"_","-"],!1,!1),/^[a-zA-Z0-9\-]/,v([["a","z"],["A","Z"],["0","9"],"-"],!1,!1),function(){return t.data.host_type="IPv6",m()},"::",T("::",!1),function(){return t.data.host_type="IPv6",m()},function(){return t.data.host_type="IPv4",m()},"25",T("25",!1),/^[0-5]/,v([["0","5"]],!1,!1),"2",T("2",!1),/^[0-4]/,v([["0","4"]],!1,!1),"1",T("1",!1),/^[1-9]/,v([["1","9"]],!1,!1),function(e){return e=parseInt(e.join("")),t.data.port=e,e},"transport=",T("transport=",!0),"udp",T("udp",!0),"tcp",T("tcp",!0),"sctp",T("sctp",!0),"tls",T("tls",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.transport=e.toLowerCase()},"user=",T("user=",!0),"phone",T("phone",!0),"ip",T("ip",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.user=e.toLowerCase()},"method=",T("method=",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.method=e},"ttl=",T("ttl=",!0),function(e){t.data.params||(t.data.params={}),t.data.params.ttl=e},"maddr=",T("maddr=",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.maddr=e},"lr",T("lr",!0),function(){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.lr=void 0},function(e,r){t.data.uri_params||(t.data.uri_params={}),r=null===r?void 0:r[1],t.data.uri_params[e.toLowerCase()]=r},function(e,r){e=e.join("").toLowerCase(),r=r.join(""),t.data.uri_headers||(t.data.uri_headers={}),t.data.uri_headers[e]?t.data.uri_headers[e].push(r):t.data.uri_headers[e]=[r]},function(){"Refer_To"===t.startRule&&(t.data.uri=new t.SIP.URI(t.data.scheme,t.data.user,t.data.host,t.data.port,t.data.uri_params,t.data.uri_headers),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port,delete t.data.uri_params)},"//",T("//",!1),function(){t.data.scheme=m()},T("SIP",!0),function(){t.data.sip_version=m()},"INVITE",T("INVITE",!1),"ACK",T("ACK",!1),"VXACH",T("VXACH",!1),"OPTIONS",T("OPTIONS",!1),"BYE",T("BYE",!1),"CANCEL",T("CANCEL",!1),"REGISTER",T("REGISTER",!1),"SUBSCRIBE",T("SUBSCRIBE",!1),"NOTIFY",T("NOTIFY",!1),"REFER",T("REFER",!1),"PUBLISH",T("PUBLISH",!1),function(){return t.data.method=m(),t.data.method},function(e){t.data.status_code=parseInt(e.join(""))},function(){t.data.reason_phrase=m()},function(){t.data=m()},function(){var e,r;for(r=t.data.multi_header.length,e=0;e<r;e++)if(null===t.data.multi_header[e].parsed){t.data=null;break}null!==t.data?t.data=t.data.multi_header:t.data=-1},function(){var e;t.data.multi_header||(t.data.multi_header=[]);try{e=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),delete t.data.uri,delete t.data.displayName,delete t.data.params}catch(t){e=null}t.data.multi_header.push({position:u,offset:g().start.offset,parsed:e})},function(e){'"'===(e=m().trim())[0]&&(e=e.substring(1,e.length-1)),t.data.displayName=e},"q",T("q",!0),function(e){t.data.params||(t.data.params={}),t.data.params.q=e},"expires",T("expires",!0),function(e){t.data.params||(t.data.params={}),t.data.params.expires=e},function(e){return parseInt(e.join(""))},"0",T("0",!1),function(){return parseFloat(m())},function(e,r){t.data.params||(t.data.params={}),r=null===r?void 0:r[1],t.data.params[e.toLowerCase()]=r},"render",T("render",!0),"session",T("session",!0),"icon",T("icon",!0),"alert",T("alert",!0),function(){"Content_Disposition"===t.startRule&&(t.data.type=m().toLowerCase())},"handling",T("handling",!0),"optional",T("optional",!0),"required",T("required",!0),function(e){t.data=parseInt(e.join(""))},function(){t.data=m()},"text",T("text",!0),"image",T("image",!0),"audio",T("audio",!0),"video",T("video",!0),"application",T("application",!0),"message",T("message",!0),"multipart",T("multipart",!0),"x-",T("x-",!0),function(e){t.data.value=parseInt(e.join(""))},function(e){t.data=e},function(e){t.data.event=e.toLowerCase()},function(){var e=t.data.tag;t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),e&&t.data.setParam("tag",e)},"tag",T("tag",!0),function(e){t.data.tag=e},function(e){t.data=parseInt(e.join(""))},function(e){t.data=e},function(){t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params)},"digest",T("Digest",!0),"realm",T("realm",!0),function(e){t.data.realm=e},"domain",T("domain",!0),"nonce",T("nonce",!0),function(e){t.data.nonce=e},"opaque",T("opaque",!0),function(e){t.data.opaque=e},"stale",T("stale",!0),"true",T("true",!0),function(){t.data.stale=!0},"false",T("false",!0),function(){t.data.stale=!1},"algorithm",T("algorithm",!0),"md5",T("MD5",!0),"md5-sess",T("MD5-sess",!0),function(e){t.data.algorithm=e.toUpperCase()},"qop",T("qop",!0),"auth-int",T("auth-int",!0),"auth",T("auth",!0),function(e){t.data.qop||(t.data.qop=[]),t.data.qop.push(e.toLowerCase())},function(e){t.data.value=parseInt(e.join(""))},function(){var e,r;for(r=t.data.multi_header.length,e=0;e<r;e++)if(null===t.data.multi_header[e].parsed){t.data=null;break}null!==t.data?t.data=t.data.multi_header:t.data=-1},function(){var e;t.data.multi_header||(t.data.multi_header=[]);try{e=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),delete t.data.uri,delete t.data.displayName,delete t.data.params}catch(t){e=null}t.data.multi_header.push({position:u,offset:g().start.offset,parsed:e})},function(){t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params)},function(){t.data.replaces_from_tag&&t.data.replaces_to_tag||(t.data=-1)},function(){t.data={call_id:t.data}},"from-tag",T("from-tag",!0),function(e){t.data.replaces_from_tag=e},"to-tag",T("to-tag",!0),function(e){t.data.replaces_to_tag=e},"early-only",T("early-only",!0),function(){t.data.early_only=!0},function(e,t){return t},function(e,t){return function(e,t){return[e].concat(t)}(e,t)},function(e){"Require"===t.startRule&&(t.data=e||[])},function(e){t.data.value=parseInt(e.join(""))},"active",T("active",!0),"pending",T("pending",!0),"terminated",T("terminated",!0),function(){t.data.state=m()},"reason",T("reason",!0),function(e){void 0!==e&&(t.data.reason=e)},function(e){void 0!==e&&(t.data.expires=e)},"retry_after",T("retry_after",!0),function(e){void 0!==e&&(t.data.retry_after=e)},"deactivated",T("deactivated",!0),"probation",T("probation",!0),"rejected",T("rejected",!0),"timeout",T("timeout",!0),"giveup",T("giveup",!0),"noresource",T("noresource",!0),"invariant",T("invariant",!0),function(e){"Supported"===t.startRule&&(t.data=e||[])},function(){var e=t.data.tag;t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),e&&t.data.setParam("tag",e)},"ttl",T("ttl",!0),function(e){t.data.ttl=e},"maddr",T("maddr",!0),function(e){t.data.maddr=e},"received",T("received",!0),function(e){t.data.received=e},"branch",T("branch",!0),function(e){t.data.branch=e},"rport",T("rport",!0),function(){"undefined"!=typeof response_port&&(t.data.rport=response_port.join(""))},function(e){t.data.protocol=e},T("UDP",!0),T("TCP",!0),T("TLS",!0),T("SCTP",!0),function(e){t.data.transport=e},function(){t.data.host=m()},function(e){t.data.port=parseInt(e.join(""))},function(e){return parseInt(e.join(""))},function(e){"Session_Expires"===t.startRule&&(t.data.deltaSeconds=e)},"refresher",T("refresher",!1),"uas",T("uas",!1),"uac",T("uac",!1),function(e){"Session_Expires"===t.startRule&&(t.data.refresher=e)},function(e){"Min_SE"===t.startRule&&(t.data=e)},"stuns",T("stuns",!0),"stun",T("stun",!0),function(e){t.data.scheme=e},function(e){t.data.host=e},"?transport=",T("?transport=",!1),"turns",T("turns",!0),"turn",T("turn",!0),function(){t.data.transport=transport},function(){t.data=m()},"Referred-By",T("Referred-By",!1),"b",T("b",!1),"cid",T("cid",!1)],c=[y('2 ""6 7!'),y('4"""5!7#'),y('4$""5!7%'),y('4&""5!7\''),y(";'.# &;("),y('4(""5!7)'),y('4*""5!7+'),y('2,""6,7-'),y('2.""6.7/'),y('40""5!71'),y('22""6273. &24""6475.} &26""6677.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),y(";).# &;,"),y('2F""6F7G.} &2H""6H7I.q &2J""6J7K.e &2L""6L7M.Y &2N""6N7O.M &2P""6P7Q.A &2R""6R7S.5 &2T""6T7U.) &2V""6V7W'),y('%%2X""6X7Y/5#;#/,$;#/#$+#)(#\'#("\'#&\'#/"!&,)'),y('%%$;$0#*;$&/,#; /#$+")("\'#&\'#." &"/=#$;$/&#0#*;$&&&#/\'$8":Z" )("\'#&\'#'),y(';.." &"'),y("%$;'.# &;(0)*;'.# &;(&/?#28\"\"6879/0$;//'$8#:[# )(#'#(\"'#&'#"),y('%%$;2/&#0#*;2&&&#/g#$%$;.0#*;.&/,#;2/#$+")("\'#&\'#0=*%$;.0#*;.&/,#;2/#$+")("\'#&\'#&/#$+")("\'#&\'#/"!&,)'),y('4\\""5!7].# &;3'),y('4^""5!7_'),y('4`""5!7a'),y(';!.) &4b""5!7c'),y('%$;). &2F""6F7G. &2J""6J7K.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O/#0*;). &2F""6F7G. &2J""6J7K.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O&&&#/"!&,)'),y('%$;). &2F""6F7G.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O/#0*;). &2F""6F7G.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O&&&#/"!&,)'),y('2T""6T7U.ã &2V""6V7W.× &2f""6f7g.Ë &2h""6h7i.¿ &2:""6:7;.³ &2D""6D7E.§ &22""6273. &28""6879. &2j""6j7k. &;&.} &24""6475.q &2l""6l7m.e &2n""6n7o.Y &26""6677.M &2>""6>7?.A &2p""6p7q.5 &2r""6r7s.) &;\'.# &;('),y('%$;).ī &2F""6F7G.ğ &2J""6J7K.ē &2L""6L7M.ć &2X""6X7Y.û &2P""6P7Q.ï &2H""6H7I.ã &2@""6@7A.× &2d""6d7e.Ë &2R""6R7S.¿ &2N""6N7O.³ &2T""6T7U.§ &2V""6V7W. &2f""6f7g. &2h""6h7i. &28""6879.w &2j""6j7k.k &;&.e &24""6475.Y &2l""6l7m.M &2n""6n7o.A &26""6677.5 &2p""6p7q.) &2r""6r7s/Ĵ#0ı*;).ī &2F""6F7G.ğ &2J""6J7K.ē &2L""6L7M.ć &2X""6X7Y.û &2P""6P7Q.ï &2H""6H7I.ã &2@""6@7A.× &2d""6d7e.Ë &2R""6R7S.¿ &2N""6N7O.³ &2T""6T7U.§ &2V""6V7W. &2f""6f7g. &2h""6h7i. &28""6879.w &2j""6j7k.k &;&.e &24""6475.Y &2l""6l7m.M &2n""6n7o.A &26""6677.5 &2p""6p7q.) &2r""6r7s&&&#/"!&,)'),y("%;//?#2P\"\"6P7Q/0$;//'$8#:t# )(#'#(\"'#&'#"),y("%;//?#24\"\"6475/0$;//'$8#:u# )(#'#(\"'#&'#"),y("%;//?#2>\"\"6>7?/0$;//'$8#:v# )(#'#(\"'#&'#"),y("%;//?#2T\"\"6T7U/0$;//'$8#:w# )(#'#(\"'#&'#"),y("%;//?#2V\"\"6V7W/0$;//'$8#:x# )(#'#(\"'#&'#"),y('%2h""6h7i/0#;//\'$8":y" )("\'#&\'#'),y('%;//6#2f""6f7g/\'$8":z" )("\'#&\'#'),y("%;//?#2D\"\"6D7E/0$;//'$8#:{# )(#'#(\"'#&'#"),y("%;//?#22\"\"6273/0$;//'$8#:|# )(#'#(\"'#&'#"),y("%;//?#28\"\"6879/0$;//'$8#:}# )(#'#(\"'#&'#"),y("%;//0#;&/'$8\":~\" )(\"'#&'#"),y("%;&/0#;//'$8\":~\" )(\"'#&'#"),y("%;=/T#$;G.) &;K.# &;F0/*;G.) &;K.# &;F&/,$;>/#$+#)(#'#(\"'#&'#"),y('4""5!7.A &4""5!7.5 &4""5!7.) &;3.# &;.'),y("%%;//Q#;&/H$$;J.# &;K0)*;J.# &;K&/,$;&/#$+$)($'#(#'#(\"'#&'#/\"!&,)"),y("%;//]#;&/T$%$;J.# &;K0)*;J.# &;K&/\"!&,)/1$;&/($8$:$!!)($'#(#'#(\"'#&'#"),y(';..G &2L""6L7M.; &4""5!7./ &4""5!7.# &;3'),y('%2j""6j7k/J#4""5!7.5 &4""5!7.) &4""5!7/#$+")("\'#&\'#'),y("%;N/M#28\"\"6879/>$;O.\" &\"/0$;S/'$8$:$ )($'#(#'#(\"'#&'#"),y("%;N/d#28\"\"6879/U$;O.\" &\"/G$;S/>$;_/5$;l.\" &\"/'$8&:& )(&'#(%'#($'#(#'#(\"'#&'#"),y('%3""5$7.) &3""5#7/\' 8!:!! )'),y('%;P/]#%28""6879/,#;R/#$+")("\'#&\'#." &"/6$2:""6:7;/\'$8#:# )(#\'#("\'#&\'#'),y("$;+.) &;-.# &;Q/2#0/*;+.) &;-.# &;Q&&&#"),y('2<""6<7=.q &2>""6>7?.e &2@""6@7A.Y &2B""6B7C.M &2D""6D7E.A &22""6273.5 &26""6677.) &24""6475'),y('%$;+._ &;-.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E0e*;+._ &;-.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E&/& 8!:! )'),y('%;T/J#%28""6879/,#;^/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),y("%;U.) &;\\.# &;X/& 8!:! )"),y('%$%;V/2#2J""6J7K/#$+")("\'#&\'#0<*%;V/2#2J""6J7K/#$+")("\'#&\'#&/D#;W/;$2J""6J7K." &"/\'$8#:# )(#\'#("\'#&\'#'),y('$4""5!7/,#0)*4""5!7&&&#'),y('%4$""5!7%/?#$4""5!70)*4""5!7&/#$+")("\'#&\'#'),y('%2l""6l7m/?#;Y/6$2n""6n7o/\'$8#:# )(#\'#("\'#&\'#'),y('%%;Z/³#28""6879/¤$;Z/$28""6879/$;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+-)(-\'#(,\'#(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ސ &%2""67/¤#;Z/$28""6879/$;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+,)(,\'#(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.۹ &%2""67/#;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+*)(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ٺ &%2""67/t#;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ؓ &%2""67/\\#;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+&)(&\'#(%\'#($\'#(#\'#("\'#&\'#.ׄ &%2""67/D#;Z/;$28""6879/,$;[/#$+$)($\'#(#\'#("\'#&\'#.֍ &%2""67/,#;[/#$+")("\'#&\'#.ծ &%2""67/,#;Z/#$+")("\'#&\'#.Տ &%;Z/#2""67/$;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$++)(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.Ӈ &%;Z/ª#%28""6879/,#;Z/#$+")("\'#&\'#." &"/$2""67/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+*)(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.а &%;Z/¹#%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/k$2""67/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+))()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.Ί &%;Z/È#%28""6879/,#;Z/#$+")("\'#&\'#." &"/¡$%28""6879/,#;Z/#$+")("\'#&\'#." &"/z$%28""6879/,#;Z/#$+")("\'#&\'#." &"/S$2""67/D$;Z/;$28""6879/,$;[/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.˕ &%;Z/×#%28""6879/,#;Z/#$+")("\'#&\'#." &"/°$%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/b$%28""6879/,#;Z/#$+")("\'#&\'#." &"/;$2""67/,$;[/#$+\')(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ȑ &%;Z/þ#%28""6879/,#;Z/#$+")("\'#&\'#." &"/×$%28""6879/,#;Z/#$+")("\'#&\'#." &"/°$%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/b$%28""6879/,#;Z/#$+")("\'#&\'#." &"/;$2""67/,$;Z/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.Ħ &%;Z/Ĝ#%28""6879/,#;Z/#$+")("\'#&\'#." &"/õ$%28""6879/,#;Z/#$+")("\'#&\'#." &"/Î$%28""6879/,#;Z/#$+")("\'#&\'#." &"/§$%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/Y$%28""6879/,#;Z/#$+")("\'#&\'#." &"/2$2""67/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#/& 8!: ! )'),y('%;#/M#;#." &"/?$;#." &"/1$;#." &"/#$+$)($\'#(#\'#("\'#&\'#'),y("%;Z/;#28\"\"6879/,$;Z/#$+#)(#'#(\"'#&'#.# &;\\"),y("%;]/o#2J\"\"6J7K/`$;]/W$2J\"\"6J7K/H$;]/?$2J\"\"6J7K/0$;]/'$8':¡' )(''#(&'#(%'#($'#(#'#(\"'#&'#"),y('%2¢""6¢7£/2#4¤""5!7¥/#$+")("\'#&\'#. &%2¦""6¦7§/;#4¨""5!7©/,$;!/#$+#)(#\'#("\'#&\'#.j &%2ª""6ª7«/5#;!/,$;!/#$+#)(#\'#("\'#&\'#.B &%4¬""5!7­/,#;!/#$+")("\'#&\'#.# &;!'),y('%%;!." &"/[#;!." &"/M$;!." &"/?$;!." &"/1$;!." &"/#$+%)(%\'#($\'#(#\'#("\'#&\'#/\' 8!:®!! )'),y('$%22""6273/,#;`/#$+")("\'#&\'#0<*%22""6273/,#;`/#$+")("\'#&\'#&'),y(";a.A &;b.; &;c.5 &;d./ &;e.) &;f.# &;g"),y('%3¯""5*7°/a#3±""5#7².G &3³""5#7´.; &3µ""5$7¶./ &3·""5#7¸.# &;6/($8":¹"! )("\'#&\'#'),y('%3º""5%7»/I#3¼""5%7½./ &3¾""5"7¿.# &;6/($8":À"! )("\'#&\'#'),y('%3Á""5\'7Â/1#;/($8":Ã"! )("\'#&\'#'),y('%3Ä""5$7Å/1#;ð/($8":Æ"! )("\'#&\'#'),y('%3Ç""5&7È/1#;T/($8":É"! )("\'#&\'#'),y('%3Ê""5"7Ë/N#%2>""6>7?/,#;6/#$+")("\'#&\'#." &"/\'$8":Ì" )("\'#&\'#'),y('%;h/P#%2>""6>7?/,#;i/#$+")("\'#&\'#." &"/)$8":Í""! )("\'#&\'#'),y('%$;j/&#0#*;j&&&#/"!&,)'),y('%$;j/&#0#*;j&&&#/"!&,)'),y(";k.) &;+.# &;-"),y('2l""6l7m.e &2n""6n7o.Y &24""6475.M &28""6879.A &2<""6<7=.5 &2@""6@7A.) &2B""6B7C'),y('%26""6677/n#;m/e$$%2<""6<7=/,#;m/#$+")("\'#&\'#0<*%2<""6<7=/,#;m/#$+")("\'#&\'#&/#$+#)(#\'#("\'#&\'#'),y('%;n/A#2>""6>7?/2$;o/)$8#:Î#"" )(#\'#("\'#&\'#'),y("$;p.) &;+.# &;-/2#0/*;p.) &;+.# &;-&&&#"),y("$;p.) &;+.# &;-0/*;p.) &;+.# &;-&"),y('2l""6l7m.e &2n""6n7o.Y &24""6475.M &26""6677.A &28""6879.5 &2@""6@7A.) &2B""6B7C'),y(";.# &;r"),y("%;/G#;'/>$;s/5$;'/,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),y(";M.# &;t"),y("%;/E#28\"\"6879/6$;u.# &;x/'$8#:Ï# )(#'#(\"'#&'#"),y('%;v.# &;w/J#%26""6677/,#;/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),y('%2Ð""6Ð7Ñ/:#;/1$;w." &"/#$+#)(#\'#("\'#&\'#'),y('%24""6475/,#;{/#$+")("\'#&\'#'),y("%;z/3#$;y0#*;y&/#$+\")(\"'#&'#"),y(";*.) &;+.# &;-"),y(';+. &;-. &22""6273.} &26""6677.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),y('%;|/e#$%24""6475/,#;|/#$+")("\'#&\'#0<*%24""6475/,#;|/#$+")("\'#&\'#&/#$+")("\'#&\'#'),y('%$;~0#*;~&/e#$%22""6273/,#;}/#$+")("\'#&\'#0<*%22""6273/,#;}/#$+")("\'#&\'#&/#$+")("\'#&\'#'),y("$;~0#*;~&"),y(';+.w &;-.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),y('%%;"/#$;".G &;!.A &2@""6@7A.5 &2F""6F7G.) &2J""6J7K0M*;".G &;!.A &2@""6@7A.5 &2F""6F7G.) &2J""6J7K&/#$+")("\'#&\'#/& 8!:Ò! )'),y(";.# &;"),y('%%;O/2#2:""6:7;/#$+")("\'#&\'#." &"/,#;S/#$+")("\'#&\'#." &"'),y('$;+. &;-.} &2B""6B7C.q &2D""6D7E.e &22""6273.Y &28""6879.M &2:""6:7;.A &2<""6<7=.5 &2>""6>7?.) &2@""6@7A/#0*;+. &;-.} &2B""6B7C.q &2D""6D7E.e &22""6273.Y &28""6879.M &2:""6:7;.A &2<""6<7=.5 &2>""6>7?.) &2@""6@7A&&&#'),y("$;y0#*;y&"),y('%3""5#7Ó/q#24""6475/b$$;!/&#0#*;!&&&#/L$2J""6J7K/=$$;!/&#0#*;!&&&#/\'$8%:Ô% )(%\'#($\'#(#\'#("\'#&\'#'),y('2Õ""6Õ7Ö'),y('2×""6×7Ø'),y('2Ù""6Ù7Ú'),y('2Û""6Û7Ü'),y('2Ý""6Ý7Þ'),y('2ß""6ß7à'),y('2á""6á7â'),y('2ã""6ã7ä'),y('2å""6å7æ'),y('2ç""6ç7è'),y('2é""6é7ê'),y("%;.Y &;.S &;.M &;.G &;.A &;.; &;.5 &;./ &;.) &;.# &;6/& 8!:ë! )"),y("%;/G#;'/>$;/5$;'/,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),y("%;/' 8!:ì!! )"),y("%;!/5#;!/,$;!/#$+#)(#'#(\"'#&'#"),y("%$;*.A &;+.; &;-.5 &;3./ &;4.) &;'.# &;(0G*;*.A &;+.; &;-.5 &;3./ &;4.) &;'.# &;(&/& 8!:í! )"),y("%;¶/Y#$%;A/,#;¶/#$+\")(\"'#&'#06*%;A/,#;¶/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),y('%;9/N#%2:""6:7;/,#;9/#$+")("\'#&\'#." &"/\'$8":î" )("\'#&\'#'),y("%;:.c &%;/Y#$%;A/,#;/#$+\")(\"'#&'#06*%;A/,#;/#$+\")(\"'#&'#&/#$+\")(\"'#&'#/& 8!:ï! )"),y("%;L.# &;/]#$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/'$8\":ð\" )(\"'#&'#"),y("%;.\" &\"/>#;@/5$;M/,$;?/#$+$)($'#(#'#(\"'#&'#"),y("%%;6/Y#$%;./,#;6/#$+\")(\"'#&'#06*%;./,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#.# &;H/' 8!:ñ!! )"),y(";.) &;.# &; "),y("%3ò\"\"5!7ó/:#;</1$;/($8#:ô#! )(#'#(\"'#&'#"),y("%3õ\"\"5'7ö/:#;</1$;/($8#:÷#! )(#'#(\"'#&'#"),y("%$;!/&#0#*;!&&&#/' 8!:ø!! )"),y('%2ù""6ù7ú/o#%2J""6J7K/M#;!." &"/?$;!." &"/1$;!." &"/#$+$)($\'#(#\'#("\'#&\'#." &"/\'$8":û" )("\'#&\'#'),y('%;6/J#%;</,#;¡/#$+")("\'#&\'#." &"/)$8":ü""! )("\'#&\'#'),y(";6.) &;T.# &;H"),y("%;£/Y#$%;B/,#;¤/#$+\")(\"'#&'#06*%;B/,#;¤/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),y('%3ý""5&7þ.G &3ÿ""5\'7Ā.; &3ā""5$7Ă./ &3ă""5%7Ą.# &;6/& 8!:ą! )'),y(";¥.# &; "),y('%3Ć""5(7ć/M#;</D$3Ĉ""5(7ĉ./ &3Ċ""5(7ċ.# &;6/#$+#)(#\'#("\'#&\'#'),y("%;6/Y#$%;A/,#;6/#$+\")(\"'#&'#06*%;A/,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),y("%$;!/&#0#*;!&&&#/' 8!:Č!! )"),y("%;©/& 8!:č! )"),y("%;ª/k#;;/b$;¯/Y$$%;B/,#;°/#$+\")(\"'#&'#06*%;B/,#;°/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),y(";«.# &;¬"),y('3Ď""5$7ď.S &3Đ""5%7đ.G &3Ē""5%7ē.; &3Ĕ""5%7ĕ./ &3Ė""5+7ė.# &;­'),y('3Ę""5\'7ę./ &3Ě""5)7ě.# &;­'),y(";6.# &;®"),y('%3Ĝ""5"7ĝ/,#;6/#$+")("\'#&\'#'),y(";­.# &;6"),y("%;6/5#;</,$;±/#$+#)(#'#(\"'#&'#"),y(";6.# &;H"),y("%;³/5#;./,$;/#$+#)(#'#(\"'#&'#"),y("%$;!/&#0#*;!&&&#/' 8!:Ğ!! )"),y("%;/' 8!:ğ!! )"),y('%;¶/^#$%;B/,#; /#$+")("\'#&\'#06*%;B/,#; /#$+")("\'#&\'#&/($8":Ġ"!!)("\'#&\'#'),y('%%;7/e#$%2J""6J7K/,#;7/#$+")("\'#&\'#0<*%2J""6J7K/,#;7/#$+")("\'#&\'#&/#$+")("\'#&\'#/"!&,)'),y("%;L.# &;/]#$%;B/,#;¸/#$+\")(\"'#&'#06*%;B/,#;¸/#$+\")(\"'#&'#&/'$8\":ġ\" )(\"'#&'#"),y(";¹.# &; "),y("%3Ģ\"\"5#7ģ/:#;</1$;6/($8#:Ĥ#! )(#'#(\"'#&'#"),y("%$;!/&#0#*;!&&&#/' 8!:ĥ!! )"),y("%;/' 8!:Ħ!! )"),y("%$;0#*;&/x#;@/o$;M/f$;?/]$$%;B/,#; /#$+\")(\"'#&'#06*%;B/,#; /#$+\")(\"'#&'#&/'$8%:ħ% )(%'#($'#(#'#(\"'#&'#"),y(";¾"),y("%3Ĩ\"\"5&7ĩ/k#;./b$;Á/Y$$%;A/,#;Á/#$+\")(\"'#&'#06*%;A/,#;Á/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#.# &;¿"),y("%;6/k#;./b$;À/Y$$%;A/,#;À/#$+\")(\"'#&'#06*%;A/,#;À/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),y("%;6/;#;</2$;6.# &;H/#$+#)(#'#(\"'#&'#"),y(";Â.G &;Ä.A &;Æ.; &;È.5 &;É./ &;Ê.) &;Ë.# &;À"),y("%3Ī\"\"5%7ī/5#;</,$;Ã/#$+#)(#'#(\"'#&'#"),y("%;I/' 8!:Ĭ!! )"),y("%3ĭ\"\"5&7Į/#;</$;D/$;Å/|$$%$;'/&#0#*;'&&&#/,#;Å/#$+\")(\"'#&'#0C*%$;'/&#0#*;'&&&#/,#;Å/#$+\")(\"'#&'#&/,$;E/#$+&)(&'#(%'#($'#(#'#(\"'#&'#"),y(";t.# &;w"),y("%3į\"\"5%7İ/5#;</,$;Ç/#$+#)(#'#(\"'#&'#"),y("%;I/' 8!:ı!! )"),y("%3Ĳ\"\"5&7ĳ/:#;</1$;I/($8#:Ĵ#! )(#'#(\"'#&'#"),y('%3ĵ""5%7Ķ/]#;</T$%3ķ""5$7ĸ/& 8!:Ĺ! ).4 &%3ĺ""5%7Ļ/& 8!:ļ! )/#$+#)(#\'#("\'#&\'#'),y('%3Ľ""5)7ľ/R#;</I$3Ŀ""5#7ŀ./ &3Ł""5(7ł.# &;6/($8#:Ń#! )(#\'#("\'#&\'#'),y('%3ń""5#7Ņ/#;</$;D/$%;Ì/e#$%2D""6D7E/,#;Ì/#$+")("\'#&\'#0<*%2D""6D7E/,#;Ì/#$+")("\'#&\'#&/#$+")("\'#&\'#/,$;E/#$+%)(%\'#($\'#(#\'#("\'#&\'#'),y('%3ņ""5(7Ň./ &3ň""5$7ŉ.# &;6/\' 8!:Ŋ!! )'),y("%;6/Y#$%;A/,#;6/#$+\")(\"'#&'#06*%;A/,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),y("%;Ï/G#;./>$;Ï/5$;./,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),y("%$;!/&#0#*;!&&&#/' 8!:ŋ!! )"),y("%;Ñ/]#$%;A/,#;Ñ/#$+\")(\"'#&'#06*%;A/,#;Ñ/#$+\")(\"'#&'#&/'$8\":Ō\" )(\"'#&'#"),y("%;/]#$%;B/,#; /#$+\")(\"'#&'#06*%;B/,#; /#$+\")(\"'#&'#&/'$8\":ō\" )(\"'#&'#"),y('%;L.O &;.I &%;@." &"/:#;t/1$;?." &"/#$+#)(#\'#("\'#&\'#/]#$%;B/,#; /#$+")("\'#&\'#06*%;B/,#; /#$+")("\'#&\'#&/\'$8":Ŏ" )("\'#&\'#'),y("%;Ô/]#$%;B/,#;Õ/#$+\")(\"'#&'#06*%;B/,#;Õ/#$+\")(\"'#&'#&/'$8\":ŏ\" )(\"'#&'#"),y("%;/& 8!:Ő! )"),y('%3ő""5(7Œ/:#;</1$;6/($8#:œ#! )(#\'#("\'#&\'#.g &%3Ŕ""5&7ŕ/:#;</1$;6/($8#:Ŗ#! )(#\'#("\'#&\'#.: &%3ŗ""5*7Ř/& 8!:ř! ).# &; '),y('%%;6/k#$%;A/2#;6/)$8":Ś""$ )("\'#&\'#0<*%;A/2#;6/)$8":Ś""$ )("\'#&\'#&/)$8":ś""! )("\'#&\'#." &"/\' 8!:Ŝ!! )'),y("%;Ø/Y#$%;A/,#;Ø/#$+\")(\"'#&'#06*%;A/,#;Ø/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),y("%;/Y#$%;B/,#; /#$+\")(\"'#&'#06*%;B/,#; /#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),y("%$;!/&#0#*;!&&&#/' 8!:ŝ!! )"),y("%;Û/Y#$%;B/,#;Ü/#$+\")(\"'#&'#06*%;B/,#;Ü/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),y('%3Ş""5&7ş.; &3Š""5\'7š./ &3Ţ""5*7ţ.# &;6/& 8!:Ť! )'),y("%3ť\"\"5&7Ŧ/:#;</1$;Ý/($8#:ŧ#! )(#'#(\"'#&'#.} &%3õ\"\"5'7ö/:#;</1$;/($8#:Ũ#! )(#'#(\"'#&'#.P &%3ũ\"\"5+7Ū/:#;</1$;/($8#:ū#! )(#'#(\"'#&'#.# &; "),y('3Ŭ""5+7ŭ.k &3Ů""5)7ů._ &3Ű""5(7ű.S &3Ų""5\'7ų.G &3Ŵ""5&7ŵ.; &3Ŷ""5*7ŷ./ &3Ÿ""5)7Ź.# &;6'),y(';1." &"'),y('%%;6/k#$%;A/2#;6/)$8":Ś""$ )("\'#&\'#0<*%;A/2#;6/)$8":Ś""$ )("\'#&\'#&/)$8":ś""! )("\'#&\'#." &"/\' 8!:ź!! )'),y("%;L.# &;/]#$%;B/,#;á/#$+\")(\"'#&'#06*%;B/,#;á/#$+\")(\"'#&'#&/'$8\":Ż\" )(\"'#&'#"),y(";¹.# &; "),y("%;ã/Y#$%;A/,#;ã/#$+\")(\"'#&'#06*%;A/,#;ã/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),y("%;ê/k#;./b$;í/Y$$%;B/,#;ä/#$+\")(\"'#&'#06*%;B/,#;ä/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),y(";å.; &;æ.5 &;ç./ &;è.) &;é.# &; "),y("%3ż\"\"5#7Ž/:#;</1$;ð/($8#:ž#! )(#'#(\"'#&'#"),y("%3ſ\"\"5%7ƀ/:#;</1$;T/($8#:Ɓ#! )(#'#(\"'#&'#"),y("%3Ƃ\"\"5(7ƃ/F#;</=$;\\.) &;Y.# &;X/($8#:Ƅ#! )(#'#(\"'#&'#"),y("%3ƅ\"\"5&7Ɔ/:#;</1$;6/($8#:Ƈ#! )(#'#(\"'#&'#"),y('%3ƈ""5%7Ɖ/O#%;</3#$;!0#*;!&/#$+")("\'#&\'#." &"/\'$8":Ɗ" )("\'#&\'#'),y("%;ë/G#;;/>$;6/5$;;/,$;ì/#$+%)(%'#($'#(#'#(\"'#&'#"),y('%3""5#7Ó.# &;6/\' 8!:Ƌ!! )'),y('%3±""5#7ƌ.G &3³""5#7ƍ.; &3·""5#7Ǝ./ &3µ""5$7Ə.# &;6/\' 8!:Ɛ!! )'),y('%;î/D#%;C/,#;ï/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),y("%;U.) &;\\.# &;X/& 8!:Ƒ! )"),y('%%;!." &"/[#;!." &"/M$;!." &"/?$;!." &"/1$;!." &"/#$+%)(%\'#($\'#(#\'#("\'#&\'#/\' 8!:ƒ!! )'),y('%%;!/?#;!." &"/1$;!." &"/#$+#)(#\'#("\'#&\'#/\' 8!:Ɠ!! )'),y(";¾"),y('%;/^#$%;B/,#;ó/#$+")("\'#&\'#06*%;B/,#;ó/#$+")("\'#&\'#&/($8":Ɣ"!!)("\'#&\'#'),y(";ô.# &; "),y('%2ƕ""6ƕ7Ɩ/L#;</C$2Ɨ""6Ɨ7Ƙ.) &2ƙ""6ƙ7ƚ/($8#:ƛ#! )(#\'#("\'#&\'#'),y('%;/^#$%;B/,#; /#$+")("\'#&\'#06*%;B/,#; /#$+")("\'#&\'#&/($8":Ɯ"!!)("\'#&\'#'),y("%;6/5#;0/,$;÷/#$+#)(#'#(\"'#&'#"),y("$;2.) &;4.# &;.0/*;2.) &;4.# &;.&"),y("$;%0#*;%&"),y("%;ú/;#28\"\"6879/,$;û/#$+#)(#'#(\"'#&'#"),y('%3Ɲ""5%7ƞ.) &3Ɵ""5$7Ơ/\' 8!:ơ!! )'),y('%;ü/J#%28""6879/,#;^/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),y("%;\\.) &;X.# &;/' 8!:Ƣ!! )"),y(';".S &;!.M &2F""6F7G.A &2J""6J7K.5 &2H""6H7I.) &2N""6N7O'),y('2L""6L7M. &2B""6B7C. &2<""6<7=.} &2R""6R7S.q &2T""6T7U.e &2V""6V7W.Y &2P""6P7Q.M &2@""6@7A.A &2D""6D7E.5 &22""6273.) &2>""6>7?'),y('%;Ā/b#28""6879/S$;û/J$%2ƣ""6ƣ7Ƥ/,#;ì/#$+")("\'#&\'#." &"/#$+$)($\'#(#\'#("\'#&\'#'),y('%3ƥ""5%7Ʀ.) &3Ƨ""5$7ƨ/\' 8!:ơ!! )'),y('%;ì/O#3±""5#7².6 &3³""5#7´.* &$;+0#*;+&/\'$8":Ʃ" )("\'#&\'#'),y("%;Ą/#2F\"\"6F7G/x$;ă/o$2F\"\"6F7G/`$;ă/W$2F\"\"6F7G/H$;ă/?$2F\"\"6F7G/0$;ą/'$8):ƪ) )()'#(('#(''#(&'#(%'#($'#(#'#(\"'#&'#"),y("%;#/>#;#/5$;#/,$;#/#$+$)($'#(#'#(\"'#&'#"),y("%;ă/,#;ă/#$+\")(\"'#&'#"),y("%;ă/5#;ă/,$;ă/#$+#)(#'#(\"'#&'#"),y("%;/U#;'/L$;/C$;'/:$;/1$; .\" &\"/#$+&)(&'#(%'#($'#(#'#(\"'#&'#"),y('%2ƫ""6ƫ7Ƭ.) &2ƭ""6ƭ7Ʈ/w#;0/n$;Ĉ/e$$%;B/2#;ĉ.# &; /#$+")("\'#&\'#0<*%;B/2#;ĉ.# &; /#$+")("\'#&\'#&/#$+$)($\'#(#\'#("\'#&\'#'),y(";.# &;L"),y("%2Ư\"\"6Ư7ư/5#;</,$;Ċ/#$+#)(#'#(\"'#&'#"),y("%;D/S#;,/J$2:\"\"6:7;/;$;,.# &;T/,$;E/#$+%)(%'#($'#(#'#(\"'#&'#")],u=0,d=0,h=[{line:1,column:1}],l=0,p=[],f=0;if("startRule"in t){if(!(t.startRule in s))throw new Error("Can't start parsing from rule \""+t.startRule+'".');o=s[t.startRule]}function m(){return e.substring(d,u)}function g(){return S(d,u)}function T(e,t){return{type:"literal",text:e,ignoreCase:t}}function v(e,t,r){return{type:"class",parts:e,inverted:t,ignoreCase:r}}function C(t){var r,i=h[t];if(i)return i;for(r=t-1;!h[r];)r--;for(i={line:(i=h[r]).line,column:i.column};r<t;)10===e.charCodeAt(r)?(i.line++,i.column=1):i.column++,r++;return h[t]=i,i}function S(e,t){var r=C(e),i=C(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:i.line,column:i.column}}}function _(e){u<l||(u>l&&(l=u,p=[]),p.push(e))}function y(e){var t,r=new Array(e.length);for(t=0;t<e.length;t++)r[t]=e.charCodeAt(t)-32;return r}if(t.data={},(r=function t(r){for(var i,s,o=c[r],h=0,l=[],p=o.length,m=[],g=[];;){for(;h<p;)switch(o[h]){case 0:g.push(a[o[h+1]]),h+=2;break;case 1:g.push(void 0),h++;break;case 2:g.push(null),h++;break;case 3:g.push(n),h++;break;case 4:g.push([]),h++;break;case 5:g.push(u),h++;break;case 6:g.pop(),h++;break;case 7:u=g.pop(),h++;break;case 8:g.length-=o[h+1],h+=2;break;case 9:g.splice(-2,1),h++;break;case 10:g[g.length-2].push(g.pop()),h++;break;case 11:g.push(g.splice(g.length-o[h+1],o[h+1])),h+=2;break;case 12:g.push(e.substring(g.pop(),u)),h++;break;case 13:m.push(p),l.push(h+3+o[h+1]+o[h+2]),g[g.length-1]?(p=h+3+o[h+1],h+=3):(p=h+3+o[h+1]+o[h+2],h+=3+o[h+1]);break;case 14:m.push(p),l.push(h+3+o[h+1]+o[h+2]),g[g.length-1]===n?(p=h+3+o[h+1],h+=3):(p=h+3+o[h+1]+o[h+2],h+=3+o[h+1]);break;case 15:m.push(p),l.push(h+3+o[h+1]+o[h+2]),g[g.length-1]!==n?(p=h+3+o[h+1],h+=3):(p=h+3+o[h+1]+o[h+2],h+=3+o[h+1]);break;case 16:g[g.length-1]!==n?(m.push(p),l.push(h),p=h+2+o[h+1],h+=2):h+=2+o[h+1];break;case 17:m.push(p),l.push(h+3+o[h+1]+o[h+2]),e.length>u?(p=h+3+o[h+1],h+=3):(p=h+3+o[h+1]+o[h+2],h+=3+o[h+1]);break;case 18:m.push(p),l.push(h+4+o[h+2]+o[h+3]),e.substr(u,a[o[h+1]].length)===a[o[h+1]]?(p=h+4+o[h+2],h+=4):(p=h+4+o[h+2]+o[h+3],h+=4+o[h+2]);break;case 19:m.push(p),l.push(h+4+o[h+2]+o[h+3]),e.substr(u,a[o[h+1]].length).toLowerCase()===a[o[h+1]]?(p=h+4+o[h+2],h+=4):(p=h+4+o[h+2]+o[h+3],h+=4+o[h+2]);break;case 20:m.push(p),l.push(h+4+o[h+2]+o[h+3]),a[o[h+1]].test(e.charAt(u))?(p=h+4+o[h+2],h+=4):(p=h+4+o[h+2]+o[h+3],h+=4+o[h+2]);break;case 21:g.push(e.substr(u,o[h+1])),u+=o[h+1],h+=2;break;case 22:g.push(a[o[h+1]]),u+=a[o[h+1]].length,h+=2;break;case 23:g.push(n),0===f&&_(a[o[h+1]]),h+=2;break;case 24:d=g[g.length-1-o[h+1]],h+=2;break;case 25:d=u,h++;break;case 26:for(i=o.slice(h+4,h+4+o[h+3]),s=0;s<o[h+3];s++)i[s]=g[g.length-1-i[s]];g.splice(g.length-o[h+2],o[h+2],a[o[h+1]].apply(null,i)),h+=4+o[h+3];break;case 27:g.push(t(o[h+1])),h+=2;break;case 28:f++,h++;break;case 29:f--,h++;break;default:throw new Error("Invalid opcode: "+o[h]+".")}if(!(m.length>0))break;p=m.pop(),h=l.pop()}return g[0]}(o))!==n&&u===e.length)return r;throw r!==n&&u<e.length&&_({type:"end"}),function(e,t,r){return new i(i.buildMessage(e,t),e,t,r)}(p,l<e.length?e.charAt(l):null,l<e.length?S(l,l+1):S(l,l))}}},function(e,t,r){e.exports=function(e){function t(e,t){var r,i,n=[],s=e.split(/\r\n/);for(r=0;r<s.length;){var o=s[r];if(/^m=(?:audio|video)/.test(o))i={index:r,stripped:[]},n.push(i);else if(i){var a=/^a=rtpmap:(\d+) ([^\/]+)\//.exec(o);if(a&&t===a[2]){s.splice(r,1),i.stripped.push(a[1]);continue}}r++}for(r=0;r<n.length;r++){for(var c=s[n[r].index].split(" "),u=3;u<c.length;)-1===n[r].stripped.indexOf(c[u])?u++:c.splice(u,1);s[n[r].index]=c.join(" ")}return s.join("\r\n")}return{stripTcpCandidates:function(t){return t.sdp=t.sdp.replace(/^a=candidate:\d+ \d+ tcp .*?\r\n/gim,""),e.Utils.Promise.resolve(t)},stripTelephoneEvent:function(r){return r.sdp=t(r.sdp,"telephone-event"),e.Utils.Promise.resolve(r)},cleanJitsiSdpImageattr:function(t){return t.sdp=t.sdp.replace(/^(a=imageattr:.*?)(x|y)=\[0-/gm,"$1$2=[1:"),e.Utils.Promise.resolve(t)},stripG722:function(r){return r.sdp=t(r.sdp,"G722"),e.Utils.Promise.resolve(r)},stripRtpPayload:function(r){return function(i){return i.sdp=t(i.sdp,r),e.Utils.Promise.resolve(i)}},stripVideo:function(t){return t.sdp=function(e,t){return new RegExp("m="+t+".*$","gm").test(e)&&(e=e.split(/^m=/gm).filter(function(e){return e.substr(0,t.length)!==t}).join("m=")),e}(t,"video"),e.Utils.Promise.resolve(t)}}}},function(e,t,r){(function(t){e.exports=function(e){var r={STATUS_NULL:0,STATUS_NEW:1,STATUS_CONNECTING:2,STATUS_CONNECTED:3,STATUS_COMPLETED:4},i=function(i){if(i.media.remote.video?this.video=!0:this.video=!1,i.media.remote.audio?this.audio=!0:this.audio=!1,!this.audio&&!this.video)throw new Error("At least one remote audio or video element is required for Simple.");this.options=i;var n=t.navigator.userAgent.toLowerCase(),s=!1,o=!1;n.indexOf("safari")>-1&&n.indexOf("chrome")<0?s=!0:n.indexOf("firefox")>-1&&n.indexOf("chrome")<0&&(o=!0);var a={};return s&&(a.modifiers=[e.Web.Modifiers.stripG722]),o&&(a.alwaysAcquireMediaFirst=!0),this.options.ua.uri||(this.anonymous=!0),this.ua=new e.UA({uri:this.options.ua.uri,authorizationUser:this.options.ua.authorizationUser,password:this.options.ua.password,displayName:this.options.ua.displayName,userAgentString:this.options.ua.userAgentString,register:!0,sessionDescriptionHandlerFactoryOptions:a,transportOptions:{traceSip:this.options.ua.traceSip,wsServers:this.options.ua.wsServers}}),this.state=r.STATUS_NULL,this.logger=this.ua.getLogger("sip.simple"),this.ua.on("registered",function(){this.emit("registered",this.ua)}.bind(this)),this.ua.on("unregistered",function(){this.emit("unregistered",this.ua)}.bind(this)),this.ua.on("failed",function(){this.emit("unregistered",this.ua)}.bind(this)),this.ua.on("invite",function(e){if(this.state!==r.STATUS_NULL&&this.state!==r.STATUS_COMPLETED)return this.logger.warn("Rejecting incoming call. Simple only supports 1 call at a time"),void e.reject();this.session=e,this.setupSession(),this.emit("ringing",this.session)}.bind(this)),this.ua.on("message",function(e){this.emit("message",e)}.bind(this)),this};return i.prototype=Object.create(e.EventEmitter.prototype),i.C=r,i.prototype.call=function(e){if(this.ua&&this.checkRegistration()){if(this.state===r.STATUS_NULL||this.state===r.STATUS_COMPLETED)return this.options.media.remote.audio&&(this.options.media.remote.audio.autoplay=!0),this.options.media.remote.video&&(this.options.media.remote.video.autoplay=!0),this.options.media.local&&this.options.media.local.video&&(this.options.media.local.video.autoplay=!0,this.options.media.local.video.volume=0),this.session=this.ua.invite(e,{sessionDescriptionHandlerOptions:{constraints:{audio:this.audio,video:this.video}}}),this.setupSession(),this.session;this.logger.warn("Cannot make more than a single call with Simple")}else this.logger.warn("A registered UA is required for calling")},i.prototype.answer=function(){if(this.state===r.STATUS_NEW||this.state===r.STATUS_CONNECTING)return this.options.media.remote.audio&&(this.options.media.remote.audio.autoplay=!0),this.options.media.remote.video&&(this.options.media.remote.video.autoplay=!0),this.session.accept({sessionDescriptionHandlerOptions:{constraints:{audio:this.audio,video:this.video}}});this.logger.warn("No call to answer")},i.prototype.reject=function(){if(this.state===r.STATUS_NEW||this.state===r.STATUS_CONNECTING)return this.session.reject();this.logger.warn("Call is already answered")},i.prototype.hangup=function(){if(this.state===r.STATUS_CONNECTED||this.state===r.STATUS_CONNECTING||this.state===r.STATUS_NEW)return this.state!==r.STATUS_CONNECTED?this.session.cancel():this.session.bye();this.logger.warn("No active call to hang up on")},i.prototype.hold=function(){if(this.state===r.STATUS_CONNECTED&&!this.session.local_hold)return this.mute(),this.logger.log("Placing session on hold"),this.session.hold();this.logger.warn("Cannot put call on hold")},i.prototype.unhold=function(){if(this.state===r.STATUS_CONNECTED&&this.session.local_hold)return this.unmute(),this.logger.log("Placing call off hold"),this.session.unhold();this.logger.warn("Cannot unhold a call that is not on hold")},i.prototype.mute=function(){this.state===r.STATUS_CONNECTED?(this.logger.log("Muting Audio"),this.toggleMute(!0),this.emit("mute",this)):this.logger.warn("An acitve call is required to mute audio")},i.prototype.unmute=function(){this.state===r.STATUS_CONNECTED?(this.logger.log("Unmuting Audio"),this.toggleMute(!1),this.emit("unmute",this)):this.logger.warn("An active call is required to unmute audio")},i.prototype.sendDTMF=function(e){this.state===r.STATUS_CONNECTED?(this.logger.log("Sending DTMF tone: "+e),this.session.dtmf(e)):this.logger.warn("An active call is required to send a DTMF tone")},i.prototype.message=function(e,t){this.ua&&this.checkRegistration()?e&&t?this.ua.message(e,t):this.logger.warn("A destination and message are required to send a message"):this.logger.warn("A registered UA is required to send a message")},i.prototype.checkRegistration=function(){return this.anonymous||this.ua&&this.ua.isRegistered()},i.prototype.setupRemoteMedia=function(){var e,r=this.session.sessionDescriptionHandler.peerConnection;r.getReceivers?(e=new t.window.MediaStream,r.getReceivers().forEach(function(t){var r=t.track;r&&e.addTrack(r)})):e=r.getRemoteStreams()[0],this.video?(this.options.media.remote.video.srcObject=e,this.options.media.remote.video.play().catch(function(){this.logger.log("play was rejected")}.bind(this))):this.audio&&(this.options.media.remote.audio.srcObject=e,this.options.media.remote.audio.play().catch(function(){this.logger.log("play was rejected")}.bind(this)))},i.prototype.setupLocalMedia=function(){if(this.video&&this.options.media.local&&this.options.media.local.video){var e,r=this.session.sessionDescriptionHandler.peerConnection;r.getSenders?(e=new t.window.MediaStream,r.getSenders().forEach(function(t){var r=t.track;r&&"video"===r.kind&&e.addTrack(r)})):e=r.getLocalStreams()[0],this.options.media.local.video.srcObject=e,this.options.media.local.video.volume=0,this.options.media.local.video.play()}},i.prototype.cleanupMedia=function(){this.video&&(this.options.media.remote.video.srcObject=null,this.options.media.remote.video.pause(),this.options.media.local&&this.options.media.local.video&&(this.options.media.local.video.srcObject=null,this.options.media.local.video.pause())),this.audio&&(this.options.media.remote.audio.srcObject=null,this.options.media.remote.audio.pause())},i.prototype.setupSession=function(){this.state=r.STATUS_NEW,this.emit("new",this.session),this.session.on("progress",this.onProgress.bind(this)),this.session.on("accepted",this.onAccepted.bind(this)),this.session.on("rejected",this.onEnded.bind(this)),this.session.on("failed",this.onFailed.bind(this)),this.session.on("terminated",this.onEnded.bind(this))},i.prototype.destroyMedia=function(){this.session.sessionDescriptionHandler.close()},i.prototype.toggleMute=function(e){var t=this.session.sessionDescriptionHandler.peerConnection;t.getSenders?t.getSenders().forEach(function(t){t.track&&(t.track.enabled=!e)}):t.getLocalStreams().forEach(function(t){t.getAudioTracks().forEach(function(t){t.enabled=!e}),t.getVideoTracks().forEach(function(t){t.enabled=!e})})},i.prototype.onAccepted=function(){this.state=r.STATUS_CONNECTED,this.emit("connected",this.session),this.setupLocalMedia(),this.setupRemoteMedia(),this.session.sessionDescriptionHandler.on("addTrack",function(){this.logger.log("A track has been added, triggering new remoteMedia setup"),this.setupRemoteMedia()}.bind(this)),this.session.sessionDescriptionHandler.on("addStream",function(){this.logger.log("A stream has been added, trigger new remoteMedia setup"),this.setupRemoteMedia()}.bind(this)),this.session.on("hold",function(){this.emit("hold",this.session)}.bind(this)),this.session.on("unhold",function(){this.emit("unhold",this.session)}.bind(this)),this.session.on("dtmf",function(e){this.emit("dtmf",e)}.bind(this)),this.session.on("bye",this.onEnded.bind(this))},i.prototype.onProgress=function(){this.state=r.STATUS_CONNECTING,this.emit("connecting",this.session)},i.prototype.onFailed=function(){this.onEnded()},i.prototype.onEnded=function(){this.state=r.STATUS_COMPLETED,this.emit("ended",this.session),this.cleanupMedia()},i}}).call(this,r(28))},function(e,t,r){(function(t){var i=t.window||t;function n(e,t){if(null!=e){var r=t.charAt(0).toUpperCase()+t.slice(1),i=[t,"webkit"+r,"moz"+r];for(var n in i){var s=e[i[n]];if(s)return s.bind(e)}}}e.exports={WebSocket:i.WebSocket,Transport:r(10),open:i.open,Promise:i.Promise,timers:i,console:i.console||{debug:function(){},log:function(){},warn:function(){},error:function(){}},addEventListener:n(i,"addEventListener"),removeEventListener:n(i,"removeEventListener")}}).call(this,r(28))}])},e.exports=r()}),SIP=unwrapExports(sip);class CallbacksHandler{constructor(){this.callbacks={}}on(e,t){this.callbacks[e]=t}triggerCallback(e,...t){return t.push(e),this.callbacks["*"]&&this.callbacks["*"].apply(void 0,t),e in this.callbacks?this.callbacks[e].apply(void 0,t):null}}const states=["STATUS_NULL","STATUS_NEW","STATUS_CONNECTING","STATUS_CONNECTED","STATUS_COMPLETED"],events=["connected","disconnected","registered","unregistered","registrationFailed","invite","inviteSent","transportCreated","newTransaction","transactionDestroyed","notify","outOfDialogReferRequested","message"];class WebRTCClient{static isAPrivateIp(e){return null==/^(?:10|127|172\.(?:1[6-9]|2[0-9]|3[01])|192\.168)\..*/.exec(e)}static getIceServers(e){return WebRTCClient.isAPrivateIp(e)?[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun3.l.google.com:19302","stun:stun4.l.google.com:19302"]}]:[]}constructor(e){this.config=e,this.callbacksHandler=new CallbacksHandler,this.configureMedia(e.media),this.userAgent=this.createUserAgent()}configureMedia(e){this.audio=e.audio,this.video=e.video,this.localVideo=e.localVideo}createUserAgent(){const e=this._createWebRTCConfiguration(),t=new SIP.UA(e);return events.filter(e=>"invite"!==e).forEach(e=>{t.on(e,t=>{this.callbacksHandler.triggerCallback(e,t)})}),t.on("invite",e=>{this._setupSession(e),this.callbacksHandler.triggerCallback("invite",e)}),t}on(e,t){this.callbacksHandler.on(e,t)}call(e){this.audio&&this._isWeb()&&(this.audio.autoplay=!0),this.video&&this._isWeb()&&(this.video.autoplay=!0),this.localVideo&&this._isWeb()&&(this.localVideo.autoplay=!0,this.localVideo.volume=0);const t=this.userAgent.invite(e,this._getMediaConfiguration());return this._setupSession(t),t}answer(e){this.audio&&this._isWeb()&&(this.audio.autoplay=!0),this.video&&this._isWeb()&&(this.video.autoplay=!0),e.accept(this._getMediaConfiguration())}hangup(e){e.hasAnswer&&e.bye?e.bye():e.hasAnswer||!e.cancel?e.reject&&e.reject():e.cancel()}reject(e){return e.reject()}mute(e){this._toggleMute(e,!0)}unmute(e){this._toggleMute(e,!1)}hold(e){return this.mute(e),e.hold()}unhold(e){return this.unmute(e),e.unhold()}sendDTMF(e,t){e.dtmf(t)}message(e,t){this.userAgent.message(e,t)}transfert(e,t){this.hold(e),setTimeout(()=>{e.refer(t),this.hangup(e)},50)}getState(){return states[this.userAgent.state]}close(){this._cleanupMedia(),this.userAgent.transport.disconnect(),this.userAgent.stop()}_isWeb(){return"object"==typeof this.audio||"object"==typeof this.video}_hasAudio(){return!!this.audio}_hasVideo(){return!!this.video}_hasLocalVideo(){return!!this.localVideo}_createWebRTCConfiguration(){return{authorizationUser:this.config.authorizationUser,displayName:this.config.displayName,hackIpInContact:!0,hackWssInTransport:!0,log:{builtinEnabled:!1},password:this.config.password,uri:`${this.config.authorizationUser}@${this.config.host}`,transportOptions:{traceSip:!1,wsServers:`wss://${this.config.host}:${this.config.port||443}/api/asterisk/ws`},sessionDescriptionHandlerFactoryOptions:{peerConnectionOptions:{iceCheckingTimeout:500,constraints:{audio:!0,video:!1},rtcConfiguration:{rtcpMuxPolicy:"negotiate",iceServers:WebRTCClient.getIceServers(this.config.host),mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!1}}}}}}_getMediaConfiguration(){return{sessionDescriptionHandlerOptions:{constraints:{audio:this._hasAudio(),video:this._hasVideo()},RTCOfferOptions:{mandatory:{OfferToReceiveAudio:this._hasAudio(),OfferToReceiveVideo:this._hasVideo()}}}}}_setupSession(e){e.on("accepted",()=>this._onAccepted(e))}_onAccepted(e){this._setupLocalMedia(e),this._setupRemoteMedia(e),e.sessionDescriptionHandler.on("addTrack",()=>{this._setupRemoteMedia(e)}),e.sessionDescriptionHandler.on("addStream",()=>{this._setupRemoteMedia(e)}),this.callbacksHandler.triggerCallback("accepted",e)}_setupRemoteMedia(e){const t=e.sessionDescriptionHandler.peerConnection;let r;t.getReceivers?(r="undefined"!=typeof global?new global.window.MediaStream:new window.MediaStream,t.getReceivers().forEach(e=>{const{track:t}=e;t&&r.addTrack(t)})):[r]=t.getRemoteStreams(),this._hasVideo()?(this.video.srcObject=r,this.video.play()):this._hasAudio()&&(this.audio.srcObject=r,this.audio.play())}_setupLocalMedia(e){if(!this.localVideo)return;const t=e.sessionDescriptionHandler.peerConnection;let r;t.getSenders?(r="undefined"!=typeof global?new global.window.MediaStream:new window.MediaStream,t.getSenders().forEach(e=>{const{track:t}=e;t&&"video"===t.kind&&r.addTrack(t)})):[r]=t.getLocalStreams(),this.localVideo.srcObject=r,this.localVideo.volume=0,this.localVideo.play()}_cleanupMedia(){this.video&&this._isWeb()&&(this.video.srcObject=null,this.video.pause(),this.localVideo&&(this.localVideo.srcObject=null,this.localVideo.pause())),this.audio&&this._isWeb()&&(this.audio.srcObject=null,this.audio.pause())}_toggleMute(e,t){const r=e.sessionDescriptionHandler.peerConnection;r.getSenders?r.getSenders().forEach(e=>{e.track&&(e.track.enabled=!t)}):r.getLocalStreams().forEach(e=>{e.getAudioTracks().forEach(e=>{e.enabled=!t}),e.getVideoTracks().forEach(e=>{e.enabled=!t})})}}var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function __extends(e,t){function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function __values(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function __read(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var i,n,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(i=s.next()).done;)o.push(i.value)}catch(e){n={error:e}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return o}function __spread(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(__read(arguments[t]));return e}var Event$1=function(){return function(e,t){this.target=t,this.type=e}}(),ErrorEvent=function(e){function t(t,r){var i=e.call(this,"error",r)||this;return i.message=t.message,i.error=t,i}return __extends(t,e),t}(Event$1),CloseEvent=function(e){function t(t,r,i){void 0===t&&(t=1e3),void 0===r&&(r="");var n=e.call(this,"close",i)||this;return n.wasClean=!0,n.code=t,n.reason=r,n}return __extends(t,e),t}(Event$1),getGlobalWebSocket=function(){if("undefined"!=typeof WebSocket)return WebSocket},isWebSocket=function(e){return"function"==typeof e&&2===e.CLOSING},DEFAULT={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1},ReconnectingWebSocket=function(){function e(e,t,r){void 0===r&&(r={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.eventToHandler=new Map([["open",this._handleOpen.bind(this)],["close",this._handleClose.bind(this)],["error",this._handleError.bind(this)],["message",this._handleMessage.bind(this)]]),this.onclose=void 0,this.onerror=void 0,this.onmessage=void 0,this.onopen=void 0,this._url=e,this._protocols=t,this._options=r,this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce(function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e},0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED||this._connect(),this._disconnect(e,t),this._connect()},e.prototype.send=function(e){this._ws&&this._ws.readyState===this.OPEN?(this._debug("send",e),this._ws.send(e)):(this._debug("enqueue",e),this._messageQueue.push(e))},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(e){return e!==t}))},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,__spread(["RWS>"],e))},e.prototype._getNextDelay=function(){var e=0;if(this._retryCount>0){var t=this._options,r=t.reconnectionDelayGrowFactor,i=void 0===r?DEFAULT.reconnectionDelayGrowFactor:r,n=t.minReconnectionDelay,s=void 0===n?DEFAULT.minReconnectionDelay:n,o=t.maxReconnectionDelay,a=void 0===o?DEFAULT.maxReconnectionDelay:o;(e=s*Math.pow(i,this._retryCount-1))>a&&(e=a)}return this._debug("next delay",e),e},e.prototype._wait=function(){var e=this;return new Promise(function(t){setTimeout(t,e._getNextDelay())})},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options,r=t.maxRetries,i=void 0===r?DEFAULT.maxRetries:r,n=t.connectionTimeout,s=void 0===n?DEFAULT.connectionTimeout:n,o=t.WebSocket,a=void 0===o?getGlobalWebSocket():o;if(this._retryCount>=i)this._debug("max retries reached",this._retryCount,">=",i);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),!isWebSocket(a))throw Error("No valid WebSocket class provided");this._wait().then(function(){return e._getNextUrl(e._url)}).then(function(t){e._closeCalled||(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new a(t,e._protocols):new a(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout(function(){return e._handleTimeout()},s))})}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new ErrorEvent(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),clearTimeout(this._connectTimeout),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new CloseEvent(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._handleOpen=function(e){var t=this;this._debug("open event");var r=this._options.minUptime,i=void 0===r?DEFAULT.minUptime:r;clearTimeout(this._connectTimeout),this._uptimeTimeout=setTimeout(function(){return t._acceptOpen()},i),this._debug("assign binary type"),this._ws.binaryType=this._binaryType,this._messageQueue.forEach(function(e){return t._ws.send(e)}),this._messageQueue=[],this.onopen&&this.onopen(e),this._listeners.open.forEach(function(r){return t._callEventListener(e,r)})},e.prototype._handleMessage=function(e){var t=this;this._debug("message event"),this.onmessage&&this.onmessage(e),this._listeners.message.forEach(function(r){return t._callEventListener(e,r)})},e.prototype._handleError=function(e){var t=this;this._debug("error event",e.message),this._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),this.onerror&&this.onerror(e),this._debug("exec error listeners"),this._listeners.error.forEach(function(r){return t._callEventListener(e,r)}),this._connect()},e.prototype._handleClose=function(e){var t=this;this._debug("close event"),this._shouldReconnect&&this._connect(),this.onclose&&this.onclose(e),this._listeners.close.forEach(function(r){return t._callEventListener(e,r)})},e.prototype._removeListeners=function(){var e,t;if(this._ws){this._debug("removeListeners");try{for(var r=__values(this.eventToHandler),i=r.next();!i.done;i=r.next()){var n=__read(i.value,2),s=n[0],o=n[1];this._ws.removeEventListener(s,o)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}}},e.prototype._addListeners=function(){var e,t;this._debug("addListeners");try{for(var r=__values(this.eventToHandler),i=r.next();!i.done;i=r.next()){var n=__read(i.value,2),s=n[0],o=n[1];this._ws.addEventListener(s,o)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}},e}();class WebSocketClient{constructor({host:e,token:t,events:r=[]},i={}){this.initialized=!1,this.callbacksHandler=new CallbacksHandler,this.socket=null,this.host=e,this.token=t,this.events=r,this.options=i}connect(){this.socket=new ReconnectingWebSocket(`wss://${this.host}/api/websocketd/?token=${this.token}`,[],this.options),this.options.binaryType&&(this.socket.binaryType=this.options.binaryType),this.socket.onmessage=(e=>{const t=JSON.parse("string"==typeof e.data?e.data:"{}");this.initialized?this.callbacksHandler.triggerCallback(t.name,t):this.handleMessage(t,this.socket)}),this.socket.onclose=(e=>{e.code})}close(){this.socket&&this.socket.close()}on(e,t){this.callbacksHandler.on(e,t)}handleMessage(e,t){switch(e.op){case"init":this.events.forEach(e=>{const r={op:"subscribe",data:{event_name:e}};t.send(JSON.stringify(r))}),t.send(JSON.stringify({op:"start"}));break;case"subscribe":break;case"start":this.initialized=!0;break;default:this.callbacksHandler.triggerCallback("message",e)}}}var COUNTRIES={BELGIUM:"BE",CANADA:"CA",FRANCE:"FR",GERMANY:"DE",ITALY:"IT",PORTUGAL:"PT",SPAIN:"ES",SWITZERLAND:"CH",UNITED_KINGDOM:"GB",UNITED_STATES:"US"};class NotificationOptions{static parse(e){return new NotificationOptions(e?{sound:e.sound,vibration:e.vibration}:{sound:!0,vibration:!0})}static newFrom(e){return newFrom(e,NotificationOptions)}constructor({sound:e=!0,vibration:t=!0}={}){this.sound=e,this.vibration=t}setSound(e){return this.sound=e,this}setVibration(e){return this.vibration=e,this}enable(){return this.vibration=!0,this.sound=!0,this}disable(){return this.vibration=!1,this.sound=!1,this}isEnabled(){return this.sound||this.vibration}}class DebugPhone{makeCall(e){console.info("DebugPhone - calling: ${number}")}acceptCall(){console.info("DebugPhone - Accept call")}mute(){console.info("DebugPhone - Mute phone")}unmute(){console.info("DebugPhone - Unmute phone")}hold(){console.info("DebugPhone - Put on hold")}unhold(){console.info("DebugPhone - Put on unhold")}transfer(e){console.info(`DebugPhone - Transferring to ${e}`)}sendKey(e){console.info("DebugPhone - sending: ${key}")}putOnSpeaker(){console.info("DebugPhone - Put on speaker")}putOffSpeaker(){console.info("DebugPhone - Put off speaker")}endCall(){console.info("DebugPhone - Hang up")}onConnectionMade(){console.info("DebugPhone - Connection made")}close(){console.info("DebugPhone - Close")}}class DebugDevice{connectToCall(){console.info("DebugDevice - Connected to call")}disconnectFromCall(){console.info("DebugDevice - Disconnected from call")}ringback(){console.info("DebugDevice - Ringback")}stopRingback(){console.info("DebugDevice - Stop ringback")}playRingtone(){console.info("DebugDevice - Play ringtone")}stopRingtone(){console.info("DebugDevice - Stop ringtone")}mute(){console.info("DebugDevice - Mute")}unmute(){console.info("DebugDevice - Unmute")}putOnSpeaker(){console.info("DebugDevice - Put on speaker")}putOffSpeaker(){console.info("DebugDevice - Put off speaker")}}var index={WazoApiClient:ApiClient,WazoWebRTCClient:WebRTCClient,WazoWebSocketClient:WebSocketClient,BadResponse:BadResponse,ServerError:ServerError,Call:Call,CallLog:CallLog,ChatMessage:ChatMessage,Contact:Contact,COUNTRIES:COUNTRIES,ForwardOption:ForwardOption,Line:Line,NotificationOptions:NotificationOptions,Profile:Profile,Session:Session,Voicemail:Voicemail,DebugPhone:DebugPhone,DebugDevice:DebugDevice,PRESENCE:PRESENCE,FORWARD_KEYS:FORWARD_KEYS};return index});
//# sourceMappingURL=wazo-sdk.js.map
